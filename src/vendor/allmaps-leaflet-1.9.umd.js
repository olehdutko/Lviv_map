(function(Ne,Ft){typeof exports=="object"&&typeof module<"u"?Ft(exports,require("leaflet")):typeof define=="function"&&define.amd?define(["exports","leaflet"],Ft):(Ne=typeof globalThis<"u"?globalThis:Ne||self,Ft(Ne.Allmaps={},Ne.L))})(this,function(Ne,Ft){"use strict";function Ca(r){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(r){for(const t in r)if(t!=="default"){const i=Object.getOwnPropertyDescriptor(r,t);Object.defineProperty(e,t,i.get?i:{enumerable:!0,get:()=>r[t]})}}return e.default=r,Object.freeze(e)}const it=Ca(Ft);function dt(r,e){const t=e[0],i=e[1];return[r[0]*t+r[2]*i+r[4],r[1]*t+r[3]*i+r[5]]}function La(){return[1,0,0,1,0,0]}function ka(r,e){const t=r[0],i=r[1],n=r[2],o=r[3],s=r[4],a=r[5],c=e[0],l=e[1],h=e[2],u=e[3],g=e[4],m=e[5];return[t*c+n*l,i*c+o*l,t*h+n*u,i*h+o*u,t*g+n*m+s,i*g+o*m+a]}function _i(r,e,t,i,n,o,s){const a=Math.sin(n),c=Math.cos(n);return[t*c,i*a,-t*a,i*c,o*t*c-s*t*a+r,o*i*a+s*i*c+e]}function Rn(r){const e=ja(r),t=r[0],i=r[1],n=r[2],o=r[3],s=r[4],a=r[5];return[o/e,-i/e,-n/e,t/e,(n*a-o*s)/e,-(t*a-i*s)/e]}function ja(r){return r[0]*r[3]-r[1]*r[2]}function Dt(r){const e=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];return e[0]=r[0],e[1]=r[1],e[4]=r[2],e[5]=r[3],e[12]=r[4],e[13]=r[5],e}async function An(r,e,t){let i;if(typeof t=="function"?i=await t(r,e):i=await fetch(r,e),!i.ok)throw new Error(i.statusText);return i}async function Oa(r,e,t){return await(await An(r,e,t)).json()}async function Fa(r,e,t){return await Oa(`${r}/info.json`,e,t)}function In(r,e=!1){switch(r.type){case"Polygon":return r.coordinates?{...r,coordinates:Cn(r.coordinates,e)}:r;case"MultiPolygon":return r.coordinates?{...r,coordinates:r.coordinates.map(t=>Cn(t,e))}:r;case"GeometryCollection":return{...r,geometries:r.geometries.map(t=>In(t,e))};default:return r}}function Cn(r,e){if(r.length===0)return r;const t=[];for(let i=0;i<r.length;i++)t.push(Da(r[i],i===0?e:!e));return t}function Da(r,e){let t=0,i=0;for(let n=0,o=r.length,s=o-1;n<o;s=n++){const a=(r[n][0]-r[s][0])*(r[s][1]+r[n][1]),c=t+a;i+=Math.abs(t)>=Math.abs(a)?t-c+a:a-c+t,t=c}return t+i>=0!=!!e?r.slice().reverse():r}function ce(r){return Array.isArray(r)&&r.length===2&&typeof r[0]=="number"&&typeof r[1]=="number"}function Me(r){return Array.isArray(r)&&r.every(ce)}function Ga(r){return Array.isArray(r)&&r.every(ce)}function Ie(r){return Array.isArray(r)&&r.every(Ga)}function Be(r){return Array.isArray(r)&&r.every(ce)}function ze(r){return Array.isArray(r)&&r.every(Me)}function Ue(r){return Array.isArray(r)&&r.every(Ie)}function xi(r){if(r=r.filter(function(e,t,i){return t===0||!bi(e,i[t-1])}),r.length<2)throw new Error("LineString should contain at least 2 points");return r}function Ln(r){if(r=r.filter(function(e,t,i){return t===0||!bi(e,i[t-1])}),za(r)&&r.splice(-1),r.length<3)throw new Error("Ring should contain at least 3 points");return r}function kn(r){return r.map(e=>Ln(e))}function Na(r){return r.map(e=>xi(e))}function Ba(r){return r.map(e=>kn(e))}function yr(r){return{type:"Point",coordinates:r}}function wr(r){return{type:"LineString",coordinates:r}}function _r(r,e=!0){const t={type:"Polygon",coordinates:e?r.map(i=>[...i,i[0]]):r};return In(t)}function za(r){return Array.isArray(r)&&r.length>=2&&bi(r[0],r[r.length-1])}function bi(r,e){return r===e?!0:r===null||e===null?!1:r[0]===e[0]&&r[1]===e[1]}function jn(r,e){if(r.length!=e.length)throw new Error("Point arrays should be of same lenght");return r.map((t,i)=>[t,e[i]])}function On(r){return r.reduce((e,t,i)=>[...e,[t,r[(i+1)%r.length]]],[])}function Ua(r){return[r[0],-r[1]]}function Fn(r,e){return[(e[0]-r[0])/2+r[0],(e[1]-r[1])/2+r[1]]}function Ti(r,e,t){return r*(1-t)+e*t}function Mi(r,e,t){return[Ti(r[0],e[0],t),Ti(r[1],e[1],t)]}function Ve(r,e){if(Me(r)&&r.length===2)return Ve(r[0],r[1]);if(ce(r)&&e===void 0)return Ve(r,[0,0]);if(ce(r)&&ce(e))return Math.sqrt(ft(r,e));throw new Error("Input type not supported")}function ft(r,e){if(Me(r)&&r.length===2)return ft(r[0],r[1]);if(ce(r)&&e===void 0)return ft(r,[0,0]);if(ce(r)&&ce(e))return(e[0]-r[0])**2+(e[1]-r[1])**2;throw new Error("Input type not supported")}function Va(r){return r*(Math.PI/180)}function We(r){return typeof r=="object"&&r!==null&&r.type==="Point"&&ce(r.coordinates)}function $e(r){return typeof r=="object"&&r!==null&&r.type==="LineString"&&Me(r.coordinates)}function Ze(r){return typeof r=="object"&&r!==null&&r.type==="Polygon"&&Array.isArray(r.coordinates)&&Ie(r.coordinates)}function qe(r){return typeof r=="object"&&r!==null&&r.type==="MultiPoint"&&Be(r.coordinates)}function Xe(r){return typeof r=="object"&&r!==null&&r.type==="MultiLineString"&&ze(r.coordinates)}function He(r){return typeof r=="object"&&r!==null&&r.type==="MultiPolygon"&&Array.isArray(r.coordinates)&&Ue(r.coordinates)}function Wa(r){const e=typeof r=="object"&&r!==null,i=e&&"type"in r&&typeof r.type=="string"&&(r.type==="Point"||r.type==="LineString"||r.type==="Polygon"||r.type==="MultiPoint"||r.type==="MultiLineString"||r.type==="MultiPolygon"),n=e&&"coordinates"in r&&Array.isArray(r.coordinates);return i&&n}function Gt(r){return r.coordinates}function Nt(r){return xi(r.coordinates)}function Bt(r,e=!1){let t=r.coordinates;return t=kn(t),e?t.map(i=>[...i,i[0]]):t}function $a(r){return r.coordinates}function Za(r){return Na(r.coordinates)}function qa(r,e=!1){let t=r.coordinates;return t=Ba(t),e?t.map(i=>i.map(n=>[...n,n[0]])):t}function Xa(r){if(We(r))return Gt(r);if($e(r))return Nt(r);if(Ze(r))return Bt(r);if(qe(r))return $a(r);if(Xe(r))return Za(r);if(He(r))return qa(r);throw new Error("Geometry type not supported")}function xr(r){return r.coordinates.map(e=>({type:"Point",coordinates:e}))}function br(r){return r.coordinates.map(e=>({type:"LineString",coordinates:e}))}function Tr(r){return r.coordinates.map(e=>({type:"Polygon",coordinates:e}))}function Mr(r){return{type:"MultiPoint",coordinates:r.map(e=>e.coordinates)}}function Pr(r){return{type:"MultiLineString",coordinates:r.map(e=>e.coordinates)}}function Er(r){return{type:"MultiPolygon",coordinates:r.map(e=>e.coordinates)}}function Ha(r,e){return{type:"Feature",properties:e||{},geometry:r}}function Ya(r,e){return{type:"FeatureCollection",features:r.map((t,i)=>Ha(t))}}function Ka(r){return r.geometry}function Ja(r){return r.features.map(Ka)}function Dn(r){let e=Number.POSITIVE_INFINITY,t=Number.NEGATIVE_INFINITY;for(const i of r)e===void 0?i>=i&&(e=t=i):(e>i&&(e=i),t<i&&(t=i));return[e,t]}function fe(r){if(ce(r)&&(r=[r]),Ie(r)&&(r=r.flat()),Wa(r))return fe(Xa(r));const e=[],t=[];for(const a of r)e.push(a[0]),t.push(a[1]);const[i,n]=Dn(e),[o,s]=Dn(t);return[i,o,n,s]}function Gn(r,e){return[Math.min(r[0],e[0]),Math.min(r[1],e[1]),Math.max(r[2],e[2]),Math.max(r[3],e[3])]}function Qa(r,e){const t=r[2]>=e[0]&&e[2]>=r[0],i=r[3]>=e[1]&&e[3]>=r[1];return t&&i}function ec(r,e,t){return t===void 0&&(t=e),[r[0]-e,r[1]-t,r[2]+e,r[3]+t]}function Nn(r,e){if(e==0)return r;const t=Sr(r);return ec(r,...t.map(i=>i*e/2))}function zt(r){return[[r[0],r[1]],[r[2],r[1]],[r[2],r[3]],[r[0],r[3]]]}function Bn(r){return[[r[0],r[1]],[r[2],r[3]]]}function tc(r){return Ve(Bn(r))}function rc(r){return Ve(Bn(fe(r)))}function wt(r){return[(r[0]+r[2])/2,(r[1]+r[3])/2]}function Sr(r){return[r[2]-r[0],r[3]-r[1]]}function Pi(r){return[.5*(Ve(r[0],r[1])+Ve(r[2],r[3])),.5*(Ve(r[1],r[2])+Ve(r[3],r[0]))]}function Rr(r,e,t){return t?t==="contain"?e[0]>=e[1]?r[0]/e[0]:r[1]/e[1]:e[0]>=e[1]?r[1]/e[1]:r[0]/e[0]:Math.sqrt(r[0]*r[1]/(e[0]*e[1]))}function zn(r,e){return Rr(Pi(r),Pi(e))}function Ar(r,e,t,i=!0){if(r.has(e)&&i)return r.get(e);{const n=t();return r.set(e,n),n}}function Ei(r,e,t,i,n=!0){if(r.get(e)?.has(t)&&n)return r.get(e)?.get(t);{const o=i();return r.get(e)||r.set(e,new Map),r.get(e)?.set(t,o),o}}function ic(r){const e=parseInt(r.replace(/^#/,""),16),t=e>>16&255,i=e>>8&255,n=e&255;return[t,i,n]}function le(r){return ic(r).map(e=>e/255)}function nc(r,e){for(let t=0;t<e.length;t++)if(r.indexOf(e[t])==-1)return!1;return!0}function oc(r,e){return!r||!e||r.size!==e.size?!1:[...r].every(t=>e.has(t))}function Un(r,e){if(r!==void 0&&e!==void 0)return Math.max(r,e);if(r!==void 0)return r;if(e!==void 0)return e}function sc(r){let e;try{e=new URL(r)}catch{return!1}return e.protocol==="http:"||e.protocol==="https:"}function ee(r,e){return e?{...r,...e}:r}function ac(r,e){e===void 0&&(e={});var t=e.offsetLine||0,i=e.offsetColumn||0,n=r.split(`
`),o=0,s=n.map(function(u,g){var m=o+u.length+1,v={start:o,end:m,line:g};return o=m,v}),a=0;function c(u,g){return u.start<=g&&g<u.end}function l(u,g){return{line:t+u.line,column:i+g-u.start,character:g}}function h(u,g){typeof u=="string"&&(u=r.indexOf(u,g||0));for(var m=s[a],v=u>=m.end?1:-1;m;){if(c(m,u))return l(m,u);a+=v,m=s[a]}}return h}function cc(r,e,t){return ac(r,t)(e,t)}var Vn=/[a-zA-Z0-9:_-]/,Wn=/[\s\t\r\n]/,lc=/['"]/;function hc(r,e){for(var t="";e--;)t+=r;return t}function uc(r){var e="",t=[],i=a,n=null,o=null;function s(p){var x=cc(r,d),R=x.line,I=x.column,T=r.slice(0,d),f=/(^|\n).*$/.exec(T)[0].replace(/\t/g,"  "),w=r.slice(d),P=/.*(\n|$)/.exec(w)[0],M=""+f+P+`
`+hc(" ",f.length)+"^";throw new Error(p+" ("+R+":"+I+`). If this is valid SVG, it's probably a bug in svg-parser. Please raise an issue at https://github.com/Rich-Harris/svg-parser/issues â€“ thanks!

`+M)}function a(){for(;d<r.length&&r[d]!=="<"||!Vn.test(r[d+1]);)e+=r[d++];return c()}function c(){for(var p="";d<r.length&&r[d]!=="<";)p+=r[d++];return/\S/.test(p)&&n.children.push({type:"text",value:p}),r[d]==="<"?l:c}function l(){var p=r[d];if(p==="?")return c;if(p==="!"){if(r.slice(d+1,d+3)==="--")return h;if(r.slice(d+1,d+8)==="[CDATA[")return u;if(/doctype/i.test(r.slice(d+1,d+8)))return c}if(p==="/")return g;var x=m(),R={type:"element",tagName:x,properties:{},children:[]};n?n.children.push(R):o=R;for(var I;d<r.length&&(I=v());)R.properties[I.name]=I.value;var T=!1;return r[d]==="/"&&(d+=1,T=!0),r[d]!==">"&&s("Expected >"),T||(n=R,t.push(R)),c}function h(){var p=r.indexOf("-->",d);return~p||s("expected -->"),d=p+2,c}function u(){var p=r.indexOf("]]>",d);return~p||s("expected ]]>"),n.children.push(r.slice(d+7,p)),d=p+2,c}function g(){var p=m();return p||s("Expected tag name"),p!==n.tagName&&s("Expected closing tag </"+p+"> to match opening tag <"+n.tagName+">"),S(),r[d]!==">"&&s("Expected >"),t.pop(),n=t[t.length-1],c}function m(){for(var p="";d<r.length&&Vn.test(r[d]);)p+=r[d++];return p}function v(){if(!Wn.test(r[d]))return null;S();var p=m();if(!p)return null;var x=!0;return S(),r[d]==="="&&(d+=1,S(),x=b(),!isNaN(x)&&x.trim()!==""&&(x=+x)),{name:p,value:x}}function b(){return lc.test(r[d])?_():E()}function E(){var p="";do{var x=r[d];if(x===" "||x===">"||x==="/")return p;p+=x,d+=1}while(d<r.length);return p}function _(){for(var p=r[d++],x="",R=!1;d<r.length;){var I=r[d++];if(I===p&&!R)return x;I==="\\"&&!R&&(R=!0),x+=R?"\\"+I:I,R=!1}}function S(){for(;d<r.length&&Wn.test(r[d]);)d+=1}for(var d=a.length;d<r.length;)i||s("Unexpected character"),i=i(),d+=1;return i!==c&&s("Unexpected end of input"),o.tagName==="svg"&&(o.metadata=e),{type:"root",children:[o]}}function*dc(r){function*e(i){if("children"in i)for(const n of i.children)typeof n!="string"&&(yield*e(n));yield i}const t=uc(r);for(const i of e(t))if("tagName"in i&&i.tagName!=="svg"&&i.tagName!=="g"){const n=fc(i);n&&(yield n)}}function fc(r){const e=r?.tagName?.toLowerCase();if(e==="circle")return{type:"circle",coordinates:[se(r,"cx"),se(r,"cy")]};if(e==="line")return{type:"line",coordinates:[[se(r,"x1"),se(r,"y1")],[se(r,"x2"),se(r,"y2")]]};if(e==="polyline")return{type:"polyline",coordinates:$n(r)};if(e==="polygon")return{type:"polygon",coordinates:$n(r)};if(e==="rect")return{type:"rect",coordinates:[[se(r,"x"),se(r,"y")],[se(r,"x")+se(r,"width"),se(r,"y")],[se(r,"x")+se(r,"width"),se(r,"y")+se(r,"height")],[se(r,"x"),se(r,"y")+se(r,"height")],[se(r,"x"),se(r,"y")]]};throw new Error(`Unsupported SVG element: ${e}`)}function se(r,e){const t=r?.properties?.[e];return Number(t)||0}function $n(r){const e=r?.properties?.points;return e?String(e).trim().split(/\s+/).map(t=>{const i=t.split(",").map(n=>Number(n));return[i[0],i[1]]}):[]}function Zn(r){return r.map(e=>e.join(",")).join(" ")}function pc(r){return`<svg xmlns="http://www.w3.org/2000/svg">
  ${r.map(gc).join(`
`)}
</svg>`}function gc(r){if(r.type==="circle")return Ut("circle",{...r.attributes,cx:r.coordinates[0],cy:r.coordinates[1]});if(r.type==="line")return Ut("line",{...r.attributes,x1:r.coordinates[0][0],y1:r.coordinates[0][1],x2:r.coordinates[1][0],y2:r.coordinates[1][1]});if(r.type==="polyline")return Ut("polyline",{...r.attributes,points:Zn(r.coordinates)});if(r.type==="polygon")return Ut("polygon",{...r.attributes,points:Zn(r.coordinates)});if(r.type==="rect")return Ut("rect",{...r.attributes,x:r.coordinates[0][0],y:r.coordinates[0][1],width:r.coordinates[1][0]-r.coordinates[0][0],height:r.coordinates[2][1]-r.coordinates[0][1]});throw new Error("Unknown SVG element")}function Ut(r,e){const t=Object.entries(e).map(([i,n])=>`${i}="${n}"`);return`<${r} ${t.join(" ")} />`}function mc([r,e]){const i=6378137*Va(r),n=6378137*Math.log(Math.tan(Math.PI/4+e*(Math.PI/180)/2));return[i,n]}function Si([r,e]){const i=Math.PI*6378137,n=r/i*180;let o=e/i*180;return o=180/Math.PI*(2*Math.atan(Math.exp(o*Math.PI/180))-Math.PI/2),[n,o]}let vc=class En{geoCenter;geoRectangle;geoSize;geoResolution;geoRectangleBbox;projectedGeoCenter;projectedGeoRectangle;projectedGeoSize;projectedGeoResolution;projectedGeoRectangleBbox;rotation;projectedGeoPerViewportScale;viewportCenter;viewportRectangle;viewportSize;viewportResolution;viewportBbox;devicePixelRatio;canvasCenter;canvasRectangle;canvasSize;canvasResolution;canvasBbox;projectedGeoPerCanvasScale;projectedGeoToViewportTransform=[1,0,0,1,0,0];projectedGeoToClipTransform=[1,0,0,1,0,0];viewportToClipTransform=[1,0,0,1,0,0];constructor(e,t,i,n,o=1){this.projectedGeoCenter=t,this.projectedGeoPerViewportScale=i,this.rotation=n,this.viewportSize=e,this.devicePixelRatio=o,this.projectedGeoRectangle=this.computeProjectedGeoRectangle(this.projectedGeoCenter,this.projectedGeoPerViewportScale,this.rotation,this.viewportSize),this.projectedGeoRectangleBbox=fe(this.projectedGeoRectangle),this.projectedGeoSize=[this.viewportSize[0]*i,this.viewportSize[1]*i],this.projectedGeoResolution=this.projectedGeoSize[0]*this.projectedGeoSize[1],this.geoCenter=Si(this.projectedGeoCenter),this.geoRectangle=this.projectedGeoRectangle.map(s=>Si(s)),this.geoRectangleBbox=fe(this.geoRectangle),this.geoSize=Sr(this.geoRectangleBbox),this.geoResolution=this.geoSize[0]*this.geoSize[1],this.viewportResolution=this.viewportSize[0]*this.viewportSize[1],this.viewportCenter=[this.viewportSize[0]/2,this.viewportSize[1]/2],this.viewportBbox=[0,0,...this.viewportSize],this.viewportRectangle=zt(this.viewportBbox),this.canvasCenter=[this.viewportCenter[0]*this.devicePixelRatio,this.viewportSize[1]*this.devicePixelRatio],this.canvasSize=[this.viewportSize[0]*this.devicePixelRatio,this.viewportSize[1]*this.devicePixelRatio],this.canvasResolution=this.canvasSize[0]*this.canvasSize[1],this.canvasBbox=[0,0,...this.canvasSize],this.canvasRectangle=zt(this.canvasBbox),this.projectedGeoPerCanvasScale=this.projectedGeoPerViewportScale/this.devicePixelRatio,this.projectedGeoToViewportTransform=this.composeProjectedGeoToViewportTransform(),this.projectedGeoToClipTransform=this.composeProjectedGeoToClipTransform(),this.viewportToClipTransform=this.composeViewportToClipTransform()}static fromWarpedMapList(e,t,i,n="contain",o=1){const s=t.getProjectedCenter(),a=t.getProjectedBbox();if(!s||!a)throw new Error("WarpedMapList has no projected center or bbox");const c=Sr(a),l=Rr(c,e,n)*(1/o);return new En(e,s,l,0,i)}static fromProjectedGeoBbox(e,t,i,n="contain"){const o=wt(t),s=Sr(t),a=Rr(s,e,n);return new En(e,o,a,0,i)}getProjectedGeoBufferedRectangle(e){const t=Nn(this.viewportBbox,e);return zt(t).map(i=>dt(Rn(this.projectedGeoToViewportTransform),i))}composeProjectedGeoToViewportTransform(){return _i(this.viewportCenter[0],this.viewportCenter[1],1/this.projectedGeoPerViewportScale,-1/this.projectedGeoPerViewportScale,-this.rotation,-this.projectedGeoCenter[0],-this.projectedGeoCenter[1])}composeProjectedGeoToClipTransform(){return _i(0,0,2/(this.projectedGeoPerViewportScale*this.viewportSize[0]),2/(this.projectedGeoPerViewportScale*this.viewportSize[1]),-this.rotation,-this.projectedGeoCenter[0],-this.projectedGeoCenter[1])}composeViewportToClipTransform(){return _i(0,0,2/this.viewportSize[0],-2/this.viewportSize[1],0,-this.viewportCenter[0],-this.viewportCenter[1])}computeProjectedGeoRectangle(e,t,i,n){const o=t*n[0]/2,s=t*n[1]/2,a=Math.cos(i),c=Math.sin(i),l=o*a,h=o*c,u=s*a,g=s*c,m=e[0],v=e[1];return[[m-l+g,v-h-u],[m-l-g,v-h+u],[m+l-g,v+h+u],[m+l+g,v+h-u]]}};function Ri(r){return Array.isArray(r)?`[${r.map(e=>Ri(e)).join(",")}]`:typeof r=="number"?`${r}`:typeof r=="string"?`"${r}"`:typeof r=="object"&&r!==null?Object.keys(r).sort().map(e=>`${e}:${Ri(r[e])}`).join("|"):String(r)}async function yc(r){const e=await crypto.subtle.digest("SHA-1",new TextEncoder().encode(r));return Array.from(new Uint8Array(e)).map(n=>n.toString(16).padStart(2,"0")).join("")}async function qn(r,e=16){return(await yc(String(r))).slice(0,e)}async function wc(r,e){return await qn(Ri(r),e)}var H;(function(r){r.assertEqual=n=>n;function e(n){}r.assertIs=e;function t(n){throw new Error}r.assertNever=t,r.arrayToEnum=n=>{const o={};for(const s of n)o[s]=s;return o},r.getValidEnumValues=n=>{const o=r.objectKeys(n).filter(a=>typeof n[n[a]]!="number"),s={};for(const a of o)s[a]=n[a];return r.objectValues(s)},r.objectValues=n=>r.objectKeys(n).map(function(o){return n[o]}),r.objectKeys=typeof Object.keys=="function"?n=>Object.keys(n):n=>{const o=[];for(const s in n)Object.prototype.hasOwnProperty.call(n,s)&&o.push(s);return o},r.find=(n,o)=>{for(const s of n)if(o(s))return s},r.isInteger=typeof Number.isInteger=="function"?n=>Number.isInteger(n):n=>typeof n=="number"&&isFinite(n)&&Math.floor(n)===n;function i(n,o=" | "){return n.map(s=>typeof s=="string"?`'${s}'`:s).join(o)}r.joinValues=i,r.jsonStringifyReplacer=(n,o)=>typeof o=="bigint"?o.toString():o})(H||(H={}));var Ai;(function(r){r.mergeShapes=(e,t)=>({...e,...t})})(Ai||(Ai={}));const O=H.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),nt=r=>{switch(typeof r){case"undefined":return O.undefined;case"string":return O.string;case"number":return isNaN(r)?O.nan:O.number;case"boolean":return O.boolean;case"function":return O.function;case"bigint":return O.bigint;case"symbol":return O.symbol;case"object":return Array.isArray(r)?O.array:r===null?O.null:r.then&&typeof r.then=="function"&&r.catch&&typeof r.catch=="function"?O.promise:typeof Map<"u"&&r instanceof Map?O.map:typeof Set<"u"&&r instanceof Set?O.set:typeof Date<"u"&&r instanceof Date?O.date:O.object;default:return O.unknown}},A=H.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),_c=r=>JSON.stringify(r,null,2).replace(/"([^"]+)":/g,"$1:");class be extends Error{constructor(e){super(),this.issues=[],this.addIssue=i=>{this.issues=[...this.issues,i]},this.addIssues=(i=[])=>{this.issues=[...this.issues,...i]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(o){return o.message},i={_errors:[]},n=o=>{for(const s of o.issues)if(s.code==="invalid_union")s.unionErrors.map(n);else if(s.code==="invalid_return_type")n(s.returnTypeError);else if(s.code==="invalid_arguments")n(s.argumentsError);else if(s.path.length===0)i._errors.push(t(s));else{let a=i,c=0;for(;c<s.path.length;){const l=s.path[c];c===s.path.length-1?(a[l]=a[l]||{_errors:[]},a[l]._errors.push(t(s))):a[l]=a[l]||{_errors:[]},a=a[l],c++}}};return n(this),i}static assert(e){if(!(e instanceof be))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,H.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},i=[];for(const n of this.issues)n.path.length>0?(t[n.path[0]]=t[n.path[0]]||[],t[n.path[0]].push(e(n))):i.push(e(n));return{formErrors:i,fieldErrors:t}}get formErrors(){return this.flatten()}}be.create=r=>new be(r);const _t=(r,e)=>{let t;switch(r.code){case A.invalid_type:r.received===O.undefined?t="Required":t=`Expected ${r.expected}, received ${r.received}`;break;case A.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(r.expected,H.jsonStringifyReplacer)}`;break;case A.unrecognized_keys:t=`Unrecognized key(s) in object: ${H.joinValues(r.keys,", ")}`;break;case A.invalid_union:t="Invalid input";break;case A.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${H.joinValues(r.options)}`;break;case A.invalid_enum_value:t=`Invalid enum value. Expected ${H.joinValues(r.options)}, received '${r.received}'`;break;case A.invalid_arguments:t="Invalid function arguments";break;case A.invalid_return_type:t="Invalid function return type";break;case A.invalid_date:t="Invalid date";break;case A.invalid_string:typeof r.validation=="object"?"includes"in r.validation?(t=`Invalid input: must include "${r.validation.includes}"`,typeof r.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${r.validation.position}`)):"startsWith"in r.validation?t=`Invalid input: must start with "${r.validation.startsWith}"`:"endsWith"in r.validation?t=`Invalid input: must end with "${r.validation.endsWith}"`:H.assertNever(r.validation):r.validation!=="regex"?t=`Invalid ${r.validation}`:t="Invalid";break;case A.too_small:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at least":"more than"} ${r.minimum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at least":"over"} ${r.minimum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${r.minimum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(r.minimum))}`:t="Invalid input";break;case A.too_big:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at most":"less than"} ${r.maximum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at most":"under"} ${r.maximum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="bigint"?t=`BigInt must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly":r.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(r.maximum))}`:t="Invalid input";break;case A.custom:t="Invalid input";break;case A.invalid_intersection_types:t="Intersection results could not be merged";break;case A.not_multiple_of:t=`Number must be a multiple of ${r.multipleOf}`;break;case A.not_finite:t="Number must be finite";break;default:t=e.defaultError,H.assertNever(r)}return{message:t}};let Xn=_t;function xc(r){Xn=r}function Ir(){return Xn}const Cr=r=>{const{data:e,path:t,errorMaps:i,issueData:n}=r,o=[...t,...n.path||[]],s={...n,path:o};if(n.message!==void 0)return{...n,path:o,message:n.message};let a="";const c=i.filter(l=>!!l).slice().reverse();for(const l of c)a=l(s,{data:e,defaultError:a}).message;return{...n,path:o,message:a}},bc=[];function j(r,e){const t=Ir(),i=Cr({issueData:e,data:r.data,path:r.path,errorMaps:[r.common.contextualErrorMap,r.schemaErrorMap,t,t===_t?void 0:_t].filter(n=>!!n)});r.common.issues.push(i)}class ge{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const i=[];for(const n of t){if(n.status==="aborted")return G;n.status==="dirty"&&e.dirty(),i.push(n.value)}return{status:e.value,value:i}}static async mergeObjectAsync(e,t){const i=[];for(const n of t){const o=await n.key,s=await n.value;i.push({key:o,value:s})}return ge.mergeObjectSync(e,i)}static mergeObjectSync(e,t){const i={};for(const n of t){const{key:o,value:s}=n;if(o.status==="aborted"||s.status==="aborted")return G;o.status==="dirty"&&e.dirty(),s.status==="dirty"&&e.dirty(),o.value!=="__proto__"&&(typeof s.value<"u"||n.alwaysSet)&&(i[o.value]=s.value)}return{status:e.value,value:i}}}const G=Object.freeze({status:"aborted"}),xt=r=>({status:"dirty",value:r}),ve=r=>({status:"valid",value:r}),Ii=r=>r.status==="aborted",Ci=r=>r.status==="dirty",Vt=r=>r.status==="valid",Wt=r=>typeof Promise<"u"&&r instanceof Promise;function Lr(r,e,t,i){if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e.get(r)}function Hn(r,e,t,i,n){if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(r,t),t}typeof SuppressedError=="function"&&SuppressedError;var F;(function(r){r.errToObj=e=>typeof e=="string"?{message:e}:e||{},r.toString=e=>typeof e=="string"?e:e?.message})(F||(F={}));var $t,Zt;class Oe{constructor(e,t,i,n){this._cachedPath=[],this.parent=e,this.data=t,this._path=i,this._key=n}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Yn=(r,e)=>{if(Vt(e))return{success:!0,data:e.value};if(!r.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new be(r.common.issues);return this._error=t,this._error}}};function B(r){if(!r)return{};const{errorMap:e,invalid_type_error:t,required_error:i,description:n}=r;if(e&&(t||i))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:n}:{errorMap:(s,a)=>{var c,l;const{message:h}=r;return s.code==="invalid_enum_value"?{message:h??a.defaultError}:typeof a.data>"u"?{message:(c=h??i)!==null&&c!==void 0?c:a.defaultError}:s.code!=="invalid_type"?{message:a.defaultError}:{message:(l=h??t)!==null&&l!==void 0?l:a.defaultError}},description:n}}class z{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return nt(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:nt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new ge,ctx:{common:e.parent.common,data:e.data,parsedType:nt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Wt(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const i=this.safeParse(e,t);if(i.success)return i.data;throw i.error}safeParse(e,t){var i;const n={common:{issues:[],async:(i=t?.async)!==null&&i!==void 0?i:!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:nt(e)},o=this._parseSync({data:e,path:n.path,parent:n});return Yn(n,o)}async parseAsync(e,t){const i=await this.safeParseAsync(e,t);if(i.success)return i.data;throw i.error}async safeParseAsync(e,t){const i={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:nt(e)},n=this._parse({data:e,path:i.path,parent:i}),o=await(Wt(n)?n:Promise.resolve(n));return Yn(i,o)}refine(e,t){const i=n=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(n):t;return this._refinement((n,o)=>{const s=e(n),a=()=>o.addIssue({code:A.custom,...i(n)});return typeof Promise<"u"&&s instanceof Promise?s.then(c=>c?!0:(a(),!1)):s?!0:(a(),!1)})}refinement(e,t){return this._refinement((i,n)=>e(i)?!0:(n.addIssue(typeof t=="function"?t(i,n):t),!1))}_refinement(e){return new ke({schema:this,typeName:D.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return De.create(this,this._def)}nullable(){return ct.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Le.create(this,this._def)}promise(){return Pt.create(this,this._def)}or(e){return Yt.create([this,e],this._def)}and(e){return Kt.create(this,e,this._def)}transform(e){return new ke({...B(this._def),schema:this,typeName:D.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new rr({...B(this._def),innerType:this,defaultValue:t,typeName:D.ZodDefault})}brand(){return new ji({typeName:D.ZodBranded,type:this,...B(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new ir({...B(this._def),innerType:this,catchValue:t,typeName:D.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return nr.create(this,e)}readonly(){return or.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Tc=/^c[^\s-]{8,}$/i,Mc=/^[0-9a-z]+$/,Pc=/^[0-9A-HJKMNP-TV-Z]{26}$/,Ec=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Sc=/^[a-z0-9_-]{21}$/i,Rc=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Ac=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Ic="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Li;const Cc=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Lc=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,kc=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Kn="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",jc=new RegExp(`^${Kn}$`);function Jn(r){let e="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return r.precision?e=`${e}\\.\\d{${r.precision}}`:r.precision==null&&(e=`${e}(\\.\\d+)?`),e}function Oc(r){return new RegExp(`^${Jn(r)}$`)}function Qn(r){let e=`${Kn}T${Jn(r)}`;const t=[];return t.push(r.local?"Z?":"Z"),r.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Fc(r,e){return!!((e==="v4"||!e)&&Cc.test(r)||(e==="v6"||!e)&&Lc.test(r))}class Ce extends z{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==O.string){const o=this._getOrReturnCtx(e);return j(o,{code:A.invalid_type,expected:O.string,received:o.parsedType}),G}const i=new ge;let n;for(const o of this._def.checks)if(o.kind==="min")e.data.length<o.value&&(n=this._getOrReturnCtx(e,n),j(n,{code:A.too_small,minimum:o.value,type:"string",inclusive:!0,exact:!1,message:o.message}),i.dirty());else if(o.kind==="max")e.data.length>o.value&&(n=this._getOrReturnCtx(e,n),j(n,{code:A.too_big,maximum:o.value,type:"string",inclusive:!0,exact:!1,message:o.message}),i.dirty());else if(o.kind==="length"){const s=e.data.length>o.value,a=e.data.length<o.value;(s||a)&&(n=this._getOrReturnCtx(e,n),s?j(n,{code:A.too_big,maximum:o.value,type:"string",inclusive:!0,exact:!0,message:o.message}):a&&j(n,{code:A.too_small,minimum:o.value,type:"string",inclusive:!0,exact:!0,message:o.message}),i.dirty())}else if(o.kind==="email")Ac.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"email",code:A.invalid_string,message:o.message}),i.dirty());else if(o.kind==="emoji")Li||(Li=new RegExp(Ic,"u")),Li.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"emoji",code:A.invalid_string,message:o.message}),i.dirty());else if(o.kind==="uuid")Ec.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"uuid",code:A.invalid_string,message:o.message}),i.dirty());else if(o.kind==="nanoid")Sc.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"nanoid",code:A.invalid_string,message:o.message}),i.dirty());else if(o.kind==="cuid")Tc.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"cuid",code:A.invalid_string,message:o.message}),i.dirty());else if(o.kind==="cuid2")Mc.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"cuid2",code:A.invalid_string,message:o.message}),i.dirty());else if(o.kind==="ulid")Pc.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"ulid",code:A.invalid_string,message:o.message}),i.dirty());else if(o.kind==="url")try{new URL(e.data)}catch{n=this._getOrReturnCtx(e,n),j(n,{validation:"url",code:A.invalid_string,message:o.message}),i.dirty()}else o.kind==="regex"?(o.regex.lastIndex=0,o.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"regex",code:A.invalid_string,message:o.message}),i.dirty())):o.kind==="trim"?e.data=e.data.trim():o.kind==="includes"?e.data.includes(o.value,o.position)||(n=this._getOrReturnCtx(e,n),j(n,{code:A.invalid_string,validation:{includes:o.value,position:o.position},message:o.message}),i.dirty()):o.kind==="toLowerCase"?e.data=e.data.toLowerCase():o.kind==="toUpperCase"?e.data=e.data.toUpperCase():o.kind==="startsWith"?e.data.startsWith(o.value)||(n=this._getOrReturnCtx(e,n),j(n,{code:A.invalid_string,validation:{startsWith:o.value},message:o.message}),i.dirty()):o.kind==="endsWith"?e.data.endsWith(o.value)||(n=this._getOrReturnCtx(e,n),j(n,{code:A.invalid_string,validation:{endsWith:o.value},message:o.message}),i.dirty()):o.kind==="datetime"?Qn(o).test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{code:A.invalid_string,validation:"datetime",message:o.message}),i.dirty()):o.kind==="date"?jc.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{code:A.invalid_string,validation:"date",message:o.message}),i.dirty()):o.kind==="time"?Oc(o).test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{code:A.invalid_string,validation:"time",message:o.message}),i.dirty()):o.kind==="duration"?Rc.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"duration",code:A.invalid_string,message:o.message}),i.dirty()):o.kind==="ip"?Fc(e.data,o.version)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"ip",code:A.invalid_string,message:o.message}),i.dirty()):o.kind==="base64"?kc.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"base64",code:A.invalid_string,message:o.message}),i.dirty()):H.assertNever(o);return{status:i.value,value:e.data}}_regex(e,t,i){return this.refinement(n=>e.test(n),{validation:t,code:A.invalid_string,...F.errToObj(i)})}_addCheck(e){return new Ce({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...F.errToObj(e)})}url(e){return this._addCheck({kind:"url",...F.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...F.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...F.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...F.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...F.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...F.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...F.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...F.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...F.errToObj(e)})}datetime(e){var t,i;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:(t=e?.offset)!==null&&t!==void 0?t:!1,local:(i=e?.local)!==null&&i!==void 0?i:!1,...F.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...F.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...F.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...F.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...F.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...F.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...F.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...F.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...F.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...F.errToObj(t)})}nonempty(e){return this.min(1,F.errToObj(e))}trim(){return new Ce({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Ce({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Ce({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Ce.create=r=>{var e;return new Ce({checks:[],typeName:D.ZodString,coerce:(e=r?.coerce)!==null&&e!==void 0?e:!1,...B(r)})};function Dc(r,e){const t=(r.toString().split(".")[1]||"").length,i=(e.toString().split(".")[1]||"").length,n=t>i?t:i,o=parseInt(r.toFixed(n).replace(".","")),s=parseInt(e.toFixed(n).replace(".",""));return o%s/Math.pow(10,n)}class ot extends z{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==O.number){const o=this._getOrReturnCtx(e);return j(o,{code:A.invalid_type,expected:O.number,received:o.parsedType}),G}let i;const n=new ge;for(const o of this._def.checks)o.kind==="int"?H.isInteger(e.data)||(i=this._getOrReturnCtx(e,i),j(i,{code:A.invalid_type,expected:"integer",received:"float",message:o.message}),n.dirty()):o.kind==="min"?(o.inclusive?e.data<o.value:e.data<=o.value)&&(i=this._getOrReturnCtx(e,i),j(i,{code:A.too_small,minimum:o.value,type:"number",inclusive:o.inclusive,exact:!1,message:o.message}),n.dirty()):o.kind==="max"?(o.inclusive?e.data>o.value:e.data>=o.value)&&(i=this._getOrReturnCtx(e,i),j(i,{code:A.too_big,maximum:o.value,type:"number",inclusive:o.inclusive,exact:!1,message:o.message}),n.dirty()):o.kind==="multipleOf"?Dc(e.data,o.value)!==0&&(i=this._getOrReturnCtx(e,i),j(i,{code:A.not_multiple_of,multipleOf:o.value,message:o.message}),n.dirty()):o.kind==="finite"?Number.isFinite(e.data)||(i=this._getOrReturnCtx(e,i),j(i,{code:A.not_finite,message:o.message}),n.dirty()):H.assertNever(o);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,F.toString(t))}gt(e,t){return this.setLimit("min",e,!1,F.toString(t))}lte(e,t){return this.setLimit("max",e,!0,F.toString(t))}lt(e,t){return this.setLimit("max",e,!1,F.toString(t))}setLimit(e,t,i,n){return new ot({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:i,message:F.toString(n)}]})}_addCheck(e){return new ot({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:F.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:F.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:F.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:F.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:F.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:F.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:F.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:F.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:F.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&H.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const i of this._def.checks){if(i.kind==="finite"||i.kind==="int"||i.kind==="multipleOf")return!0;i.kind==="min"?(t===null||i.value>t)&&(t=i.value):i.kind==="max"&&(e===null||i.value<e)&&(e=i.value)}return Number.isFinite(t)&&Number.isFinite(e)}}ot.create=r=>new ot({checks:[],typeName:D.ZodNumber,coerce:r?.coerce||!1,...B(r)});class st extends z{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==O.bigint){const o=this._getOrReturnCtx(e);return j(o,{code:A.invalid_type,expected:O.bigint,received:o.parsedType}),G}let i;const n=new ge;for(const o of this._def.checks)o.kind==="min"?(o.inclusive?e.data<o.value:e.data<=o.value)&&(i=this._getOrReturnCtx(e,i),j(i,{code:A.too_small,type:"bigint",minimum:o.value,inclusive:o.inclusive,message:o.message}),n.dirty()):o.kind==="max"?(o.inclusive?e.data>o.value:e.data>=o.value)&&(i=this._getOrReturnCtx(e,i),j(i,{code:A.too_big,type:"bigint",maximum:o.value,inclusive:o.inclusive,message:o.message}),n.dirty()):o.kind==="multipleOf"?e.data%o.value!==BigInt(0)&&(i=this._getOrReturnCtx(e,i),j(i,{code:A.not_multiple_of,multipleOf:o.value,message:o.message}),n.dirty()):H.assertNever(o);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,F.toString(t))}gt(e,t){return this.setLimit("min",e,!1,F.toString(t))}lte(e,t){return this.setLimit("max",e,!0,F.toString(t))}lt(e,t){return this.setLimit("max",e,!1,F.toString(t))}setLimit(e,t,i,n){return new st({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:i,message:F.toString(n)}]})}_addCheck(e){return new st({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:F.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:F.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:F.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:F.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:F.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}st.create=r=>{var e;return new st({checks:[],typeName:D.ZodBigInt,coerce:(e=r?.coerce)!==null&&e!==void 0?e:!1,...B(r)})};class qt extends z{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==O.boolean){const i=this._getOrReturnCtx(e);return j(i,{code:A.invalid_type,expected:O.boolean,received:i.parsedType}),G}return ve(e.data)}}qt.create=r=>new qt({typeName:D.ZodBoolean,coerce:r?.coerce||!1,...B(r)});class pt extends z{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==O.date){const o=this._getOrReturnCtx(e);return j(o,{code:A.invalid_type,expected:O.date,received:o.parsedType}),G}if(isNaN(e.data.getTime())){const o=this._getOrReturnCtx(e);return j(o,{code:A.invalid_date}),G}const i=new ge;let n;for(const o of this._def.checks)o.kind==="min"?e.data.getTime()<o.value&&(n=this._getOrReturnCtx(e,n),j(n,{code:A.too_small,message:o.message,inclusive:!0,exact:!1,minimum:o.value,type:"date"}),i.dirty()):o.kind==="max"?e.data.getTime()>o.value&&(n=this._getOrReturnCtx(e,n),j(n,{code:A.too_big,message:o.message,inclusive:!0,exact:!1,maximum:o.value,type:"date"}),i.dirty()):H.assertNever(o);return{status:i.value,value:new Date(e.data.getTime())}}_addCheck(e){return new pt({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:F.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:F.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}pt.create=r=>new pt({checks:[],coerce:r?.coerce||!1,typeName:D.ZodDate,...B(r)});class kr extends z{_parse(e){if(this._getType(e)!==O.symbol){const i=this._getOrReturnCtx(e);return j(i,{code:A.invalid_type,expected:O.symbol,received:i.parsedType}),G}return ve(e.data)}}kr.create=r=>new kr({typeName:D.ZodSymbol,...B(r)});class Xt extends z{_parse(e){if(this._getType(e)!==O.undefined){const i=this._getOrReturnCtx(e);return j(i,{code:A.invalid_type,expected:O.undefined,received:i.parsedType}),G}return ve(e.data)}}Xt.create=r=>new Xt({typeName:D.ZodUndefined,...B(r)});class Ht extends z{_parse(e){if(this._getType(e)!==O.null){const i=this._getOrReturnCtx(e);return j(i,{code:A.invalid_type,expected:O.null,received:i.parsedType}),G}return ve(e.data)}}Ht.create=r=>new Ht({typeName:D.ZodNull,...B(r)});class bt extends z{constructor(){super(...arguments),this._any=!0}_parse(e){return ve(e.data)}}bt.create=r=>new bt({typeName:D.ZodAny,...B(r)});class gt extends z{constructor(){super(...arguments),this._unknown=!0}_parse(e){return ve(e.data)}}gt.create=r=>new gt({typeName:D.ZodUnknown,...B(r)});class Ye extends z{_parse(e){const t=this._getOrReturnCtx(e);return j(t,{code:A.invalid_type,expected:O.never,received:t.parsedType}),G}}Ye.create=r=>new Ye({typeName:D.ZodNever,...B(r)});class jr extends z{_parse(e){if(this._getType(e)!==O.undefined){const i=this._getOrReturnCtx(e);return j(i,{code:A.invalid_type,expected:O.void,received:i.parsedType}),G}return ve(e.data)}}jr.create=r=>new jr({typeName:D.ZodVoid,...B(r)});class Le extends z{_parse(e){const{ctx:t,status:i}=this._processInputParams(e),n=this._def;if(t.parsedType!==O.array)return j(t,{code:A.invalid_type,expected:O.array,received:t.parsedType}),G;if(n.exactLength!==null){const s=t.data.length>n.exactLength.value,a=t.data.length<n.exactLength.value;(s||a)&&(j(t,{code:s?A.too_big:A.too_small,minimum:a?n.exactLength.value:void 0,maximum:s?n.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:n.exactLength.message}),i.dirty())}if(n.minLength!==null&&t.data.length<n.minLength.value&&(j(t,{code:A.too_small,minimum:n.minLength.value,type:"array",inclusive:!0,exact:!1,message:n.minLength.message}),i.dirty()),n.maxLength!==null&&t.data.length>n.maxLength.value&&(j(t,{code:A.too_big,maximum:n.maxLength.value,type:"array",inclusive:!0,exact:!1,message:n.maxLength.message}),i.dirty()),t.common.async)return Promise.all([...t.data].map((s,a)=>n.type._parseAsync(new Oe(t,s,t.path,a)))).then(s=>ge.mergeArray(i,s));const o=[...t.data].map((s,a)=>n.type._parseSync(new Oe(t,s,t.path,a)));return ge.mergeArray(i,o)}get element(){return this._def.type}min(e,t){return new Le({...this._def,minLength:{value:e,message:F.toString(t)}})}max(e,t){return new Le({...this._def,maxLength:{value:e,message:F.toString(t)}})}length(e,t){return new Le({...this._def,exactLength:{value:e,message:F.toString(t)}})}nonempty(e){return this.min(1,e)}}Le.create=(r,e)=>new Le({type:r,minLength:null,maxLength:null,exactLength:null,typeName:D.ZodArray,...B(e)});function Tt(r){if(r instanceof te){const e={};for(const t in r.shape){const i=r.shape[t];e[t]=De.create(Tt(i))}return new te({...r._def,shape:()=>e})}else return r instanceof Le?new Le({...r._def,type:Tt(r.element)}):r instanceof De?De.create(Tt(r.unwrap())):r instanceof ct?ct.create(Tt(r.unwrap())):r instanceof Fe?Fe.create(r.items.map(e=>Tt(e))):r}class te extends z{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=H.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==O.object){const l=this._getOrReturnCtx(e);return j(l,{code:A.invalid_type,expected:O.object,received:l.parsedType}),G}const{status:i,ctx:n}=this._processInputParams(e),{shape:o,keys:s}=this._getCached(),a=[];if(!(this._def.catchall instanceof Ye&&this._def.unknownKeys==="strip"))for(const l in n.data)s.includes(l)||a.push(l);const c=[];for(const l of s){const h=o[l],u=n.data[l];c.push({key:{status:"valid",value:l},value:h._parse(new Oe(n,u,n.path,l)),alwaysSet:l in n.data})}if(this._def.catchall instanceof Ye){const l=this._def.unknownKeys;if(l==="passthrough")for(const h of a)c.push({key:{status:"valid",value:h},value:{status:"valid",value:n.data[h]}});else if(l==="strict")a.length>0&&(j(n,{code:A.unrecognized_keys,keys:a}),i.dirty());else if(l!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const l=this._def.catchall;for(const h of a){const u=n.data[h];c.push({key:{status:"valid",value:h},value:l._parse(new Oe(n,u,n.path,h)),alwaysSet:h in n.data})}}return n.common.async?Promise.resolve().then(async()=>{const l=[];for(const h of c){const u=await h.key,g=await h.value;l.push({key:u,value:g,alwaysSet:h.alwaysSet})}return l}).then(l=>ge.mergeObjectSync(i,l)):ge.mergeObjectSync(i,c)}get shape(){return this._def.shape()}strict(e){return F.errToObj,new te({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,i)=>{var n,o,s,a;const c=(s=(o=(n=this._def).errorMap)===null||o===void 0?void 0:o.call(n,t,i).message)!==null&&s!==void 0?s:i.defaultError;return t.code==="unrecognized_keys"?{message:(a=F.errToObj(e).message)!==null&&a!==void 0?a:c}:{message:c}}}:{}})}strip(){return new te({...this._def,unknownKeys:"strip"})}passthrough(){return new te({...this._def,unknownKeys:"passthrough"})}extend(e){return new te({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new te({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:D.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new te({...this._def,catchall:e})}pick(e){const t={};return H.objectKeys(e).forEach(i=>{e[i]&&this.shape[i]&&(t[i]=this.shape[i])}),new te({...this._def,shape:()=>t})}omit(e){const t={};return H.objectKeys(this.shape).forEach(i=>{e[i]||(t[i]=this.shape[i])}),new te({...this._def,shape:()=>t})}deepPartial(){return Tt(this)}partial(e){const t={};return H.objectKeys(this.shape).forEach(i=>{const n=this.shape[i];e&&!e[i]?t[i]=n:t[i]=n.optional()}),new te({...this._def,shape:()=>t})}required(e){const t={};return H.objectKeys(this.shape).forEach(i=>{if(e&&!e[i])t[i]=this.shape[i];else{let o=this.shape[i];for(;o instanceof De;)o=o._def.innerType;t[i]=o}}),new te({...this._def,shape:()=>t})}keyof(){return eo(H.objectKeys(this.shape))}}te.create=(r,e)=>new te({shape:()=>r,unknownKeys:"strip",catchall:Ye.create(),typeName:D.ZodObject,...B(e)}),te.strictCreate=(r,e)=>new te({shape:()=>r,unknownKeys:"strict",catchall:Ye.create(),typeName:D.ZodObject,...B(e)}),te.lazycreate=(r,e)=>new te({shape:r,unknownKeys:"strip",catchall:Ye.create(),typeName:D.ZodObject,...B(e)});class Yt extends z{_parse(e){const{ctx:t}=this._processInputParams(e),i=this._def.options;function n(o){for(const a of o)if(a.result.status==="valid")return a.result;for(const a of o)if(a.result.status==="dirty")return t.common.issues.push(...a.ctx.common.issues),a.result;const s=o.map(a=>new be(a.ctx.common.issues));return j(t,{code:A.invalid_union,unionErrors:s}),G}if(t.common.async)return Promise.all(i.map(async o=>{const s={...t,common:{...t.common,issues:[]},parent:null};return{result:await o._parseAsync({data:t.data,path:t.path,parent:s}),ctx:s}})).then(n);{let o;const s=[];for(const c of i){const l={...t,common:{...t.common,issues:[]},parent:null},h=c._parseSync({data:t.data,path:t.path,parent:l});if(h.status==="valid")return h;h.status==="dirty"&&!o&&(o={result:h,ctx:l}),l.common.issues.length&&s.push(l.common.issues)}if(o)return t.common.issues.push(...o.ctx.common.issues),o.result;const a=s.map(c=>new be(c));return j(t,{code:A.invalid_union,unionErrors:a}),G}}get options(){return this._def.options}}Yt.create=(r,e)=>new Yt({options:r,typeName:D.ZodUnion,...B(e)});const Ke=r=>r instanceof Qt?Ke(r.schema):r instanceof ke?Ke(r.innerType()):r instanceof er?[r.value]:r instanceof at?r.options:r instanceof tr?H.objectValues(r.enum):r instanceof rr?Ke(r._def.innerType):r instanceof Xt?[void 0]:r instanceof Ht?[null]:r instanceof De?[void 0,...Ke(r.unwrap())]:r instanceof ct?[null,...Ke(r.unwrap())]:r instanceof ji||r instanceof or?Ke(r.unwrap()):r instanceof ir?Ke(r._def.innerType):[];class Or extends z{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==O.object)return j(t,{code:A.invalid_type,expected:O.object,received:t.parsedType}),G;const i=this.discriminator,n=t.data[i],o=this.optionsMap.get(n);return o?t.common.async?o._parseAsync({data:t.data,path:t.path,parent:t}):o._parseSync({data:t.data,path:t.path,parent:t}):(j(t,{code:A.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[i]}),G)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,i){const n=new Map;for(const o of t){const s=Ke(o.shape[e]);if(!s.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const a of s){if(n.has(a))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(a)}`);n.set(a,o)}}return new Or({typeName:D.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:n,...B(i)})}}function ki(r,e){const t=nt(r),i=nt(e);if(r===e)return{valid:!0,data:r};if(t===O.object&&i===O.object){const n=H.objectKeys(e),o=H.objectKeys(r).filter(a=>n.indexOf(a)!==-1),s={...r,...e};for(const a of o){const c=ki(r[a],e[a]);if(!c.valid)return{valid:!1};s[a]=c.data}return{valid:!0,data:s}}else if(t===O.array&&i===O.array){if(r.length!==e.length)return{valid:!1};const n=[];for(let o=0;o<r.length;o++){const s=r[o],a=e[o],c=ki(s,a);if(!c.valid)return{valid:!1};n.push(c.data)}return{valid:!0,data:n}}else return t===O.date&&i===O.date&&+r==+e?{valid:!0,data:r}:{valid:!1}}class Kt extends z{_parse(e){const{status:t,ctx:i}=this._processInputParams(e),n=(o,s)=>{if(Ii(o)||Ii(s))return G;const a=ki(o.value,s.value);return a.valid?((Ci(o)||Ci(s))&&t.dirty(),{status:t.value,value:a.data}):(j(i,{code:A.invalid_intersection_types}),G)};return i.common.async?Promise.all([this._def.left._parseAsync({data:i.data,path:i.path,parent:i}),this._def.right._parseAsync({data:i.data,path:i.path,parent:i})]).then(([o,s])=>n(o,s)):n(this._def.left._parseSync({data:i.data,path:i.path,parent:i}),this._def.right._parseSync({data:i.data,path:i.path,parent:i}))}}Kt.create=(r,e,t)=>new Kt({left:r,right:e,typeName:D.ZodIntersection,...B(t)});class Fe extends z{_parse(e){const{status:t,ctx:i}=this._processInputParams(e);if(i.parsedType!==O.array)return j(i,{code:A.invalid_type,expected:O.array,received:i.parsedType}),G;if(i.data.length<this._def.items.length)return j(i,{code:A.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),G;!this._def.rest&&i.data.length>this._def.items.length&&(j(i,{code:A.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const o=[...i.data].map((s,a)=>{const c=this._def.items[a]||this._def.rest;return c?c._parse(new Oe(i,s,i.path,a)):null}).filter(s=>!!s);return i.common.async?Promise.all(o).then(s=>ge.mergeArray(t,s)):ge.mergeArray(t,o)}get items(){return this._def.items}rest(e){return new Fe({...this._def,rest:e})}}Fe.create=(r,e)=>{if(!Array.isArray(r))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Fe({items:r,typeName:D.ZodTuple,rest:null,...B(e)})};class Jt extends z{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:i}=this._processInputParams(e);if(i.parsedType!==O.object)return j(i,{code:A.invalid_type,expected:O.object,received:i.parsedType}),G;const n=[],o=this._def.keyType,s=this._def.valueType;for(const a in i.data)n.push({key:o._parse(new Oe(i,a,i.path,a)),value:s._parse(new Oe(i,i.data[a],i.path,a)),alwaysSet:a in i.data});return i.common.async?ge.mergeObjectAsync(t,n):ge.mergeObjectSync(t,n)}get element(){return this._def.valueType}static create(e,t,i){return t instanceof z?new Jt({keyType:e,valueType:t,typeName:D.ZodRecord,...B(i)}):new Jt({keyType:Ce.create(),valueType:e,typeName:D.ZodRecord,...B(t)})}}class Fr extends z{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:i}=this._processInputParams(e);if(i.parsedType!==O.map)return j(i,{code:A.invalid_type,expected:O.map,received:i.parsedType}),G;const n=this._def.keyType,o=this._def.valueType,s=[...i.data.entries()].map(([a,c],l)=>({key:n._parse(new Oe(i,a,i.path,[l,"key"])),value:o._parse(new Oe(i,c,i.path,[l,"value"]))}));if(i.common.async){const a=new Map;return Promise.resolve().then(async()=>{for(const c of s){const l=await c.key,h=await c.value;if(l.status==="aborted"||h.status==="aborted")return G;(l.status==="dirty"||h.status==="dirty")&&t.dirty(),a.set(l.value,h.value)}return{status:t.value,value:a}})}else{const a=new Map;for(const c of s){const l=c.key,h=c.value;if(l.status==="aborted"||h.status==="aborted")return G;(l.status==="dirty"||h.status==="dirty")&&t.dirty(),a.set(l.value,h.value)}return{status:t.value,value:a}}}}Fr.create=(r,e,t)=>new Fr({valueType:e,keyType:r,typeName:D.ZodMap,...B(t)});class mt extends z{_parse(e){const{status:t,ctx:i}=this._processInputParams(e);if(i.parsedType!==O.set)return j(i,{code:A.invalid_type,expected:O.set,received:i.parsedType}),G;const n=this._def;n.minSize!==null&&i.data.size<n.minSize.value&&(j(i,{code:A.too_small,minimum:n.minSize.value,type:"set",inclusive:!0,exact:!1,message:n.minSize.message}),t.dirty()),n.maxSize!==null&&i.data.size>n.maxSize.value&&(j(i,{code:A.too_big,maximum:n.maxSize.value,type:"set",inclusive:!0,exact:!1,message:n.maxSize.message}),t.dirty());const o=this._def.valueType;function s(c){const l=new Set;for(const h of c){if(h.status==="aborted")return G;h.status==="dirty"&&t.dirty(),l.add(h.value)}return{status:t.value,value:l}}const a=[...i.data.values()].map((c,l)=>o._parse(new Oe(i,c,i.path,l)));return i.common.async?Promise.all(a).then(c=>s(c)):s(a)}min(e,t){return new mt({...this._def,minSize:{value:e,message:F.toString(t)}})}max(e,t){return new mt({...this._def,maxSize:{value:e,message:F.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}mt.create=(r,e)=>new mt({valueType:r,minSize:null,maxSize:null,typeName:D.ZodSet,...B(e)});class Mt extends z{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==O.function)return j(t,{code:A.invalid_type,expected:O.function,received:t.parsedType}),G;function i(a,c){return Cr({data:a,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Ir(),_t].filter(l=>!!l),issueData:{code:A.invalid_arguments,argumentsError:c}})}function n(a,c){return Cr({data:a,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Ir(),_t].filter(l=>!!l),issueData:{code:A.invalid_return_type,returnTypeError:c}})}const o={errorMap:t.common.contextualErrorMap},s=t.data;if(this._def.returns instanceof Pt){const a=this;return ve(async function(...c){const l=new be([]),h=await a._def.args.parseAsync(c,o).catch(m=>{throw l.addIssue(i(c,m)),l}),u=await Reflect.apply(s,this,h);return await a._def.returns._def.type.parseAsync(u,o).catch(m=>{throw l.addIssue(n(u,m)),l})})}else{const a=this;return ve(function(...c){const l=a._def.args.safeParse(c,o);if(!l.success)throw new be([i(c,l.error)]);const h=Reflect.apply(s,this,l.data),u=a._def.returns.safeParse(h,o);if(!u.success)throw new be([n(h,u.error)]);return u.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new Mt({...this._def,args:Fe.create(e).rest(gt.create())})}returns(e){return new Mt({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,i){return new Mt({args:e||Fe.create([]).rest(gt.create()),returns:t||gt.create(),typeName:D.ZodFunction,...B(i)})}}class Qt extends z{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Qt.create=(r,e)=>new Qt({getter:r,typeName:D.ZodLazy,...B(e)});class er extends z{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return j(t,{received:t.data,code:A.invalid_literal,expected:this._def.value}),G}return{status:"valid",value:e.data}}get value(){return this._def.value}}er.create=(r,e)=>new er({value:r,typeName:D.ZodLiteral,...B(e)});function eo(r,e){return new at({values:r,typeName:D.ZodEnum,...B(e)})}class at extends z{constructor(){super(...arguments),$t.set(this,void 0)}_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),i=this._def.values;return j(t,{expected:H.joinValues(i),received:t.parsedType,code:A.invalid_type}),G}if(Lr(this,$t)||Hn(this,$t,new Set(this._def.values)),!Lr(this,$t).has(e.data)){const t=this._getOrReturnCtx(e),i=this._def.values;return j(t,{received:t.data,code:A.invalid_enum_value,options:i}),G}return ve(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return at.create(e,{...this._def,...t})}exclude(e,t=this._def){return at.create(this.options.filter(i=>!e.includes(i)),{...this._def,...t})}}$t=new WeakMap,at.create=eo;class tr extends z{constructor(){super(...arguments),Zt.set(this,void 0)}_parse(e){const t=H.getValidEnumValues(this._def.values),i=this._getOrReturnCtx(e);if(i.parsedType!==O.string&&i.parsedType!==O.number){const n=H.objectValues(t);return j(i,{expected:H.joinValues(n),received:i.parsedType,code:A.invalid_type}),G}if(Lr(this,Zt)||Hn(this,Zt,new Set(H.getValidEnumValues(this._def.values))),!Lr(this,Zt).has(e.data)){const n=H.objectValues(t);return j(i,{received:i.data,code:A.invalid_enum_value,options:n}),G}return ve(e.data)}get enum(){return this._def.values}}Zt=new WeakMap,tr.create=(r,e)=>new tr({values:r,typeName:D.ZodNativeEnum,...B(e)});class Pt extends z{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==O.promise&&t.common.async===!1)return j(t,{code:A.invalid_type,expected:O.promise,received:t.parsedType}),G;const i=t.parsedType===O.promise?t.data:Promise.resolve(t.data);return ve(i.then(n=>this._def.type.parseAsync(n,{path:t.path,errorMap:t.common.contextualErrorMap})))}}Pt.create=(r,e)=>new Pt({type:r,typeName:D.ZodPromise,...B(e)});class ke extends z{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===D.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:i}=this._processInputParams(e),n=this._def.effect||null,o={addIssue:s=>{j(i,s),s.fatal?t.abort():t.dirty()},get path(){return i.path}};if(o.addIssue=o.addIssue.bind(o),n.type==="preprocess"){const s=n.transform(i.data,o);if(i.common.async)return Promise.resolve(s).then(async a=>{if(t.value==="aborted")return G;const c=await this._def.schema._parseAsync({data:a,path:i.path,parent:i});return c.status==="aborted"?G:c.status==="dirty"||t.value==="dirty"?xt(c.value):c});{if(t.value==="aborted")return G;const a=this._def.schema._parseSync({data:s,path:i.path,parent:i});return a.status==="aborted"?G:a.status==="dirty"||t.value==="dirty"?xt(a.value):a}}if(n.type==="refinement"){const s=a=>{const c=n.refinement(a,o);if(i.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return a};if(i.common.async===!1){const a=this._def.schema._parseSync({data:i.data,path:i.path,parent:i});return a.status==="aborted"?G:(a.status==="dirty"&&t.dirty(),s(a.value),{status:t.value,value:a.value})}else return this._def.schema._parseAsync({data:i.data,path:i.path,parent:i}).then(a=>a.status==="aborted"?G:(a.status==="dirty"&&t.dirty(),s(a.value).then(()=>({status:t.value,value:a.value}))))}if(n.type==="transform")if(i.common.async===!1){const s=this._def.schema._parseSync({data:i.data,path:i.path,parent:i});if(!Vt(s))return s;const a=n.transform(s.value,o);if(a instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:a}}else return this._def.schema._parseAsync({data:i.data,path:i.path,parent:i}).then(s=>Vt(s)?Promise.resolve(n.transform(s.value,o)).then(a=>({status:t.value,value:a})):s);H.assertNever(n)}}ke.create=(r,e,t)=>new ke({schema:r,typeName:D.ZodEffects,effect:e,...B(t)}),ke.createWithPreprocess=(r,e,t)=>new ke({schema:e,effect:{type:"preprocess",transform:r},typeName:D.ZodEffects,...B(t)});class De extends z{_parse(e){return this._getType(e)===O.undefined?ve(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}De.create=(r,e)=>new De({innerType:r,typeName:D.ZodOptional,...B(e)});class ct extends z{_parse(e){return this._getType(e)===O.null?ve(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}ct.create=(r,e)=>new ct({innerType:r,typeName:D.ZodNullable,...B(e)});class rr extends z{_parse(e){const{ctx:t}=this._processInputParams(e);let i=t.data;return t.parsedType===O.undefined&&(i=this._def.defaultValue()),this._def.innerType._parse({data:i,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}rr.create=(r,e)=>new rr({innerType:r,typeName:D.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...B(e)});class ir extends z{_parse(e){const{ctx:t}=this._processInputParams(e),i={...t,common:{...t.common,issues:[]}},n=this._def.innerType._parse({data:i.data,path:i.path,parent:{...i}});return Wt(n)?n.then(o=>({status:"valid",value:o.status==="valid"?o.value:this._def.catchValue({get error(){return new be(i.common.issues)},input:i.data})})):{status:"valid",value:n.status==="valid"?n.value:this._def.catchValue({get error(){return new be(i.common.issues)},input:i.data})}}removeCatch(){return this._def.innerType}}ir.create=(r,e)=>new ir({innerType:r,typeName:D.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...B(e)});class Dr extends z{_parse(e){if(this._getType(e)!==O.nan){const i=this._getOrReturnCtx(e);return j(i,{code:A.invalid_type,expected:O.nan,received:i.parsedType}),G}return{status:"valid",value:e.data}}}Dr.create=r=>new Dr({typeName:D.ZodNaN,...B(r)});const Gc=Symbol("zod_brand");class ji extends z{_parse(e){const{ctx:t}=this._processInputParams(e),i=t.data;return this._def.type._parse({data:i,path:t.path,parent:t})}unwrap(){return this._def.type}}class nr extends z{_parse(e){const{status:t,ctx:i}=this._processInputParams(e);if(i.common.async)return(async()=>{const o=await this._def.in._parseAsync({data:i.data,path:i.path,parent:i});return o.status==="aborted"?G:o.status==="dirty"?(t.dirty(),xt(o.value)):this._def.out._parseAsync({data:o.value,path:i.path,parent:i})})();{const n=this._def.in._parseSync({data:i.data,path:i.path,parent:i});return n.status==="aborted"?G:n.status==="dirty"?(t.dirty(),{status:"dirty",value:n.value}):this._def.out._parseSync({data:n.value,path:i.path,parent:i})}}static create(e,t){return new nr({in:e,out:t,typeName:D.ZodPipeline})}}class or extends z{_parse(e){const t=this._def.innerType._parse(e),i=n=>(Vt(n)&&(n.value=Object.freeze(n.value)),n);return Wt(t)?t.then(n=>i(n)):i(t)}unwrap(){return this._def.innerType}}or.create=(r,e)=>new or({innerType:r,typeName:D.ZodReadonly,...B(e)});function to(r,e={},t){return r?bt.create().superRefine((i,n)=>{var o,s;if(!r(i)){const a=typeof e=="function"?e(i):typeof e=="string"?{message:e}:e,c=(s=(o=a.fatal)!==null&&o!==void 0?o:t)!==null&&s!==void 0?s:!0,l=typeof a=="string"?{message:a}:a;n.addIssue({code:"custom",...l,fatal:c})}}):bt.create()}const Nc={object:te.lazycreate};var D;(function(r){r.ZodString="ZodString",r.ZodNumber="ZodNumber",r.ZodNaN="ZodNaN",r.ZodBigInt="ZodBigInt",r.ZodBoolean="ZodBoolean",r.ZodDate="ZodDate",r.ZodSymbol="ZodSymbol",r.ZodUndefined="ZodUndefined",r.ZodNull="ZodNull",r.ZodAny="ZodAny",r.ZodUnknown="ZodUnknown",r.ZodNever="ZodNever",r.ZodVoid="ZodVoid",r.ZodArray="ZodArray",r.ZodObject="ZodObject",r.ZodUnion="ZodUnion",r.ZodDiscriminatedUnion="ZodDiscriminatedUnion",r.ZodIntersection="ZodIntersection",r.ZodTuple="ZodTuple",r.ZodRecord="ZodRecord",r.ZodMap="ZodMap",r.ZodSet="ZodSet",r.ZodFunction="ZodFunction",r.ZodLazy="ZodLazy",r.ZodLiteral="ZodLiteral",r.ZodEnum="ZodEnum",r.ZodEffects="ZodEffects",r.ZodNativeEnum="ZodNativeEnum",r.ZodOptional="ZodOptional",r.ZodNullable="ZodNullable",r.ZodDefault="ZodDefault",r.ZodCatch="ZodCatch",r.ZodPromise="ZodPromise",r.ZodBranded="ZodBranded",r.ZodPipeline="ZodPipeline",r.ZodReadonly="ZodReadonly"})(D||(D={}));const Bc=(r,e={message:`Input not instance of ${r.name}`})=>to(t=>t instanceof r,e),ro=Ce.create,io=ot.create,zc=Dr.create,Uc=st.create,no=qt.create,Vc=pt.create,Wc=kr.create,$c=Xt.create,Zc=Ht.create,qc=bt.create,Xc=gt.create,Hc=Ye.create,Yc=jr.create,Kc=Le.create,Jc=te.create,Qc=te.strictCreate,el=Yt.create,tl=Or.create,rl=Kt.create,il=Fe.create,nl=Jt.create,ol=Fr.create,sl=mt.create,al=Mt.create,cl=Qt.create,ll=er.create,hl=at.create,ul=tr.create,dl=Pt.create,oo=ke.create,fl=De.create,pl=ct.create,gl=ke.createWithPreprocess,ml=nr.create;var y=Object.freeze({__proto__:null,defaultErrorMap:_t,setErrorMap:xc,getErrorMap:Ir,makeIssue:Cr,EMPTY_PATH:bc,addIssueToContext:j,ParseStatus:ge,INVALID:G,DIRTY:xt,OK:ve,isAborted:Ii,isDirty:Ci,isValid:Vt,isAsync:Wt,get util(){return H},get objectUtil(){return Ai},ZodParsedType:O,getParsedType:nt,ZodType:z,datetimeRegex:Qn,ZodString:Ce,ZodNumber:ot,ZodBigInt:st,ZodBoolean:qt,ZodDate:pt,ZodSymbol:kr,ZodUndefined:Xt,ZodNull:Ht,ZodAny:bt,ZodUnknown:gt,ZodNever:Ye,ZodVoid:jr,ZodArray:Le,ZodObject:te,ZodUnion:Yt,ZodDiscriminatedUnion:Or,ZodIntersection:Kt,ZodTuple:Fe,ZodRecord:Jt,ZodMap:Fr,ZodSet:mt,ZodFunction:Mt,ZodLazy:Qt,ZodLiteral:er,ZodEnum:at,ZodNativeEnum:tr,ZodPromise:Pt,ZodEffects:ke,ZodTransformer:ke,ZodOptional:De,ZodNullable:ct,ZodDefault:rr,ZodCatch:ir,ZodNaN:Dr,BRAND:Gc,ZodBranded:ji,ZodPipeline:nr,ZodReadonly:or,custom:to,Schema:z,ZodSchema:z,late:Nc,get ZodFirstPartyTypeKind(){return D},coerce:{string:r=>Ce.create({...r,coerce:!0}),number:r=>ot.create({...r,coerce:!0}),boolean:r=>qt.create({...r,coerce:!0}),bigint:r=>st.create({...r,coerce:!0}),date:r=>pt.create({...r,coerce:!0})},any:qc,array:Kc,bigint:Uc,boolean:no,date:Vc,discriminatedUnion:tl,effect:oo,enum:hl,function:al,instanceof:Bc,intersection:rl,lazy:cl,literal:ll,map:ol,nan:zc,nativeEnum:ul,never:Hc,null:Zc,nullable:pl,number:io,object:Jc,oboolean:()=>no().optional(),onumber:()=>io().optional(),optional:fl,ostring:()=>ro().optional(),pipeline:ml,preprocess:gl,promise:dl,record:nl,set:sl,strictObject:Qc,string:ro,symbol:Wc,transformer:oo,tuple:il,undefined:$c,union:el,unknown:Xc,void:Yc,NEVER:G,ZodIssueCode:A,quotelessJson:_c,ZodError:be});const Gr=/^https?:\/\/library.stanford.edu\/iiif\/image-api\/1.1\/compliance.html#level(?<level>[012])$/,so=y.string().regex(Gr),vl=so,Nr="http://library.stanford.edu/iiif/image-api/1.1/context.json",ao="http://iiif.io/api/image/1/context.json",co=y.literal(Nr),lo=y.object({"@context":co,"@id":y.string().url(),profile:so.optional(),width:y.number().int(),height:y.number().int(),scale_factors:y.number().array().optional(),tile_width:y.number().optional(),tile_height:y.number().optional()}),ho=y.object({width:y.number().int(),height:y.number().int()}),uo=y.object({width:y.number().int(),height:y.number().int().optional(),scaleFactors:y.array(y.number().int())}),yl=["ImageService1","ImageService2","ImageService3"],fo=y.enum(yl),Br=/^https?:\/\/iiif.io\/api\/image\/2.*level(?<level>[012])(.json)?$/,po=y.string().regex(Br),wl=y.object({formats:y.string().array().optional(),maxArea:y.number().int().optional(),maxHeight:y.number().int().optional(),maxWidth:y.number().int().optional(),qualities:y.string().array().optional(),supports:y.string().array().optional()}),zr=po.or(y.array(y.union([po,wl,y.any()]))),Ur="http://iiif.io/api/image/2/context.json",go=y.literal(Ur).or(y.literal("https://iiif.io/api/image/2/context.json")),Oi=y.object({"@id":y.string().url(),"@type":y.literal("iiif:Image").or(y.literal("ImageService2")).optional(),"@context":go,protocol:y.literal("http://iiif.io/api/image"),width:y.number().int(),height:y.number().int(),profile:zr,sizes:ho.array().optional(),tiles:uo.array().optional()}),_l=["level0","level1","level2"],mo=y.enum(_l),Fi=y.object({id:y.string().url(),type:y.literal("ImageService3"),protocol:y.literal("http://iiif.io/api/image"),profile:mo,width:y.number().int(),height:y.number().int(),maxWidth:y.number().int().optional(),maxHeight:y.number().int().optional(),maxArea:y.number().int().optional(),sizes:ho.array().optional(),tiles:uo.array().optional(),extraFeatures:y.string().array().optional()}),xl=y.object({"@id":y.string().url(),"@type":fo.optional(),profile:vl.or(zr).or(mo),width:y.number().int().optional(),height:y.number().int().optional(),"@context":co.or(y.literal("http://iiif.io/api/image/1/context.json")).or(go).optional()}),bl=["level0","level1","level2"],Tl=y.object({id:y.string().url(),type:y.literal("ImageService2"),profile:zr}).or(y.object({"@id":y.string().url(),"@type":y.literal("ImageService2"),profile:zr})),Ml=y.object({id:y.string().url(),type:fo,profile:y.enum(bl)}),Pl=y.union([Tl,Ml]),vo=xl.or(Pl),yo=y.string().or(y.number()).or(y.boolean()),wo=yo.or(yo.array()),_o=y.object({"@language":y.string().optional(),"@value":wo}),vt=wo.or(_o).or(_o.array()),xo=y.union([y.any(),y.object({label:vt.optional(),value:vt.optional()})]).transform(r=>{if(r&&typeof r=="object"&&"label"in r&&"value"in r)return r}).array(),El=y.object({width:y.number().int().optional(),height:y.number().int().optional(),service:vo}),Sl=y.object({resource:El}),bo=y.object({"@id":y.string().url(),"@type":y.literal("sc:Canvas"),width:y.number().int(),height:y.number().int(),images:Sl.array().length(1),label:vt.optional(),metadata:xo.optional()}),Rl=y.object({canvases:bo.array().nonempty()}),To=y.object({"@id":y.string().url(),"@type":y.literal("sc:Manifest"),sequences:Rl.array().length(1),label:vt.optional(),description:vt.optional(),metadata:xo.optional()}),Mo=y.lazy(()=>y.object({"@id":y.string().url(),"@type":y.literal("sc:Manifest"),label:vt.optional()})),Di=y.lazy(()=>y.object({"@id":y.string().url(),"@type":y.literal("sc:Collection"),label:vt.optional(),manifests:Mo.array().optional(),collections:Di.array().optional(),members:Mo.or(Di).array().optional()})),Al=y.string().or(y.number()).or(y.boolean()),yt=y.record(y.string(),Al.array()),Po=y.union([y.any(),y.object({label:yt.optional(),value:yt.optional()})]).transform(r=>{if(r&&typeof r=="object"&&"label"in r&&"value"in r)return r}).array(),Eo=y.object({type:y.literal("Image"),width:y.number().int().optional(),height:y.number().int().optional(),service:vo.array()}),Il=y.object({type:y.literal("Annotation"),body:Eo.or(Eo.array().length(1))}),Cl=y.object({type:y.literal("AnnotationPage"),items:Il.array().length(1)}),So=y.object({id:y.string().url(),type:y.literal("Canvas"),width:y.number().int(),height:y.number().int(),items:Cl.array().length(1),label:yt.optional(),metadata:Po.optional()}),Ro=y.object({id:y.string().url(),type:y.literal("Manifest"),items:So.array().nonempty(),label:yt.optional(),description:yt.optional(),metadata:Po.optional()}),Ll=y.lazy(()=>y.object({id:y.string().url(),type:y.literal("Manifest"),label:yt.optional()})),Ao=y.lazy(()=>y.object({id:y.string().url(),type:y.literal("Collection"),label:yt.optional(),items:Ll.or(Ao).array()})),Io=lo.or(Oi).or(Fi);bo.or(So);const kl=To.or(Ro);Di.or(Ao),To.or(Oi),Ro.or(Fi),kl.or(Io);function Co({width:r,height:e},t,i,n){const o=i*t.originalWidth,s=n*t.originalHeight,a=i*t.originalWidth+t.width*t.scaleFactor>r?r-i*t.originalWidth:t.width*t.scaleFactor,c=n*t.originalHeight+t.height*t.scaleFactor>e?e-n*t.originalHeight:t.height*t.scaleFactor;let l=t.width,h=t.height;return o+t.width*t.scaleFactor>r&&(l=Math.floor((r-o+t.scaleFactor-1)/t.scaleFactor)),s+t.height*t.scaleFactor>e&&(h=Math.floor((e-s+t.scaleFactor-1)/t.scaleFactor)),{region:{x:o,y:s,width:a,height:c},size:{width:l,height:h}}}function jl({width:r,height:e},t=768){const i=Math.max(r,e)/t,n=Math.ceil(Math.log(i)/Math.log(2));return{scaleFactors:Array.from({length:n},(o,s)=>2**s),width:t}}function Ol({width:r,height:e},t,i){const n=t.height||t.width,o=t.width*i,s=n*i;return{scaleFactor:i,width:t.width,height:n,originalWidth:o,originalHeight:s,columns:Math.ceil(r/o),rows:Math.ceil(e/s)}}function Fl(r,e){return e.map(t=>t.scaleFactors.map(i=>Ol(r,t,i))).flat()}function Dl(r){return!!r.some(e=>e.width&&e.scaleFactors&&e.scaleFactors.length)}function Gl(r,e,t){if(!e||!Dl(e))if(t)e=[jl(r)];else throw new Error("Image does not support tiles or custom regions and sizes.");return Fl(r,e)}function Nl(r,e,t="cover"){if(t==="cover"||t==="contain"){const i=e.width/r.width,n=e.height/r.height,o=t==="cover"?Math.max(i,n):Math.min(i,n),s=r.width*o,a=r.height*o;return{width:s,height:a}}else throw new Error('Mode must be either "cover" or "contain"')}const Bl=.8,zl=1.5;function Lo(r,e,t="cover",{sizes:i,tileZoomLevels:n,supportsAnyRegionAndSize:o,maxWidth:s,maxHeight:a,maxArea:c}){let{width:l,height:h}=Nl(r,e,t);if(s&&l>s&&(h=h/l*s,l=s),a&&h>a&&(l=l/h*a,h=a),c&&l*h>c){const g=h/l,v=Math.floor(Math.sqrt(c/g))*g;l=Math.floor(v)/g,h=l*g}const u=r.width/r.height;if(l=Math.floor(l),h=Math.round(l/u),i){let g;for(const m of i){const v=m.width/l;if(v>=Bl&&v<=zl){g=m;break}}if(g)return{size:g}}if(o)return{size:{width:Math.round(l),height:Math.round(h)}};if(n){const g=r.width/l,m=n.map(({scaleFactor:S},d)=>({index:d,scaleFactor:S,diff:Math.abs(S-g)})).sort((S,d)=>S.diff-d.diff),v=n[m[0].index],b=Math.ceil(r.width/(v.scaleFactor*n[0].width)),E=Math.ceil(r.height/(v.scaleFactor*n[0].height)),_=[];for(let S=0;S<E;S++){const d=[];for(let p=0;p<b;p++){const x=Co(r,v,p,S);d.push(x)}_.push(d)}return _}throw new Error("Unable to create thumbnail")}const ko=["regionByPx","sizeByWh"];function Ul(r){const e=r.match(Gr);if(e&&e.groups)return parseInt(e.groups.level)}function jo(r){const e=r.match(Br);if(e&&e.groups)return parseInt(e.groups.level)}function Vl(r){return{maxWidth:r?.maxWidth,maxHeight:r?.maxHeight,maxArea:r?.maxArea,supportsAnyRegionAndSize:ko.every(e=>r?.supports&&r?.supports?.includes(e))}}function Wl(r){if("type"in r&&r.type==="ImageService3")return 3;if("type"in r&&r.type==="ImageService2"||"@type"in r&&r["@type"]==="ImageService2"||"@context"in r&&r["@context"]===Ur)return 2;if("@context"in r&&(r["@context"]===Nr||r["@context"]===ao))return 1;if("profile"in r){let e;return Array.isArray(r.profile)?e=r.profile[0]:e=r.profile,e.match(Gr)?1:e.match(Br)?2:3}else throw new Error("Unsupported IIIF Image Service")}function Gi(r){if("type"in r||"@type"in r){const e=r.profile;let t=!1;return e==="level0"||typeof e=="string"&&e.endsWith("level0.json")?"extraFeatures"in r&&(t=ko.every(i=>r.extraFeatures&&r.extraFeatures.includes(i))):t=!0,{maxWidth:"maxWidth"in r?r.maxWidth:void 0,maxHeight:"maxHeight"in r?r.maxHeight:void 0,maxArea:"maxArea"in r?r.maxArea:void 0,supportsAnyRegionAndSize:t}}else if(Array.isArray(r.profile)){let e=!1,t=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY,n=Number.NEGATIVE_INFINITY;return r.profile.forEach(o=>{if(typeof o=="string"){const s=jo(o);s&&(e=e||s>=1)}else{const{maxWidth:s,maxHeight:a,maxArea:c,supportsAnyRegionAndSize:l}=Vl(o);s!==void 0&&(i=Math.max(s,i)),a!==void 0&&(t=Math.max(a,t)),c!==void 0&&(n=Math.max(c,n)),e=e||l}}),{maxWidth:i>=0?i:void 0,maxHeight:t>=0?t:void 0,maxArea:n>=0?n:void 0,supportsAnyRegionAndSize:e}}else if("profile"in r&&r.profile){const e=Ul(r.profile),t=jo(r.profile);return e?{supportsAnyRegionAndSize:e>=1}:t?{supportsAnyRegionAndSize:t>=1}:{supportsAnyRegionAndSize:!1}}else throw new Error("Invalid Image")}const $l="image";class Zl{embedded=!0;uri;type=$l;maxWidth;maxHeight;maxArea;supportsAnyRegionAndSize;width;height;majorVersion;constructor(e,t){if(t){const i=e;let n,o;if(Array.isArray(i.service)?i.service.forEach(s=>{try{const a=Wl(s);(!o||a>o)&&(o=a,n=s)}catch{}}):n=i.service,!n)throw new Error("Unsupported IIIF Image Service");if("@id"in n)this.uri=n["@id"];else if("id"in n)this.uri=n.id;else throw new Error("Unsupported IIIF Image Service");if("type"in n&&n.type==="ImageService3")this.majorVersion=3;else if("type"in n&&n.type==="ImageService2"||"@type"in n&&n["@type"]==="ImageService2"||"@context"in n&&n["@context"]===Ur)this.majorVersion=2;else if("@context"in n&&(n["@context"]===Nr||n["@context"]===ao))this.majorVersion=1;else if("profile"in n){let s;Array.isArray(n.profile)?s=n.profile[0]:s=n.profile,s.match(Gr)?this.majorVersion=1:s.match(Br)?this.majorVersion=2:this.majorVersion=3}else throw new Error("Unsupported IIIF Image Service");if("profile"in n){const s=Gi(n);this.supportsAnyRegionAndSize=s.supportsAnyRegionAndSize,this.maxWidth=s.maxWidth,this.maxHeight=s.maxHeight,this.maxArea=s.maxArea}else this.supportsAnyRegionAndSize=!1}else{if("@id"in e)this.uri=e["@id"];else if("id"in e)this.uri=e.id;else throw new Error("Unsupported IIIF Image");if("type"in e&&e.type==="ImageService3")this.majorVersion=3;else if("@type"in e&&e["@type"]==="iiif:Image"||"@context"in e&&e["@context"]===Ur)this.majorVersion=2;else if("@context"in e&&e["@context"]===Nr)this.majorVersion=1;else throw new Error("Unsupported IIIF Image");if("profile"in e){const i=Gi(e);this.supportsAnyRegionAndSize=i.supportsAnyRegionAndSize,this.maxWidth=i.maxWidth,this.maxHeight=i.maxHeight,this.maxArea=i.maxArea}else this.supportsAnyRegionAndSize=!1}if(e.width!==void 0)this.width=e.width;else if(t)this.width=t.width;else throw new Error("Width not present on either Canvas or Image Resource");if(e.height!==void 0)this.height=e.height;else if(t)this.height=t.height;else throw new Error("Height not present on either Canvas or Image Resource")}getImageUrl(e){const{region:t,size:i}=e;let n,o,s,a,c;t?(c=`${t.x},${t.y},${t.width},${t.height}`,s=t.height,a=t.width):(c="full",s=this.height,a=this.width);let l;if(i){n=Math.round(i.width),o=Math.round(i.height);const g=String(n);let m=String(o);const v=a/s,E=o*v/v;o===Math.round(E)&&(m=""),l=`${g},${m}`}else n=this.width,o=this.height,l=this.majorVersion===2?"full":"max";const h=n*o;if(this.maxWidth!==void 0&&n>this.maxWidth)throw new Error(`Width of requested image is too large: ${n} > ${this.maxWidth}`);if(this.maxHeight!==void 0&&o>this.maxHeight)throw new Error(`Height of requested image is too large: ${o} > ${this.maxHeight}`);if(this.maxArea!==void 0&&h>this.maxArea)throw new Error(`Area of requested image is too large: ${h} > ${this.maxArea}`);const u=this.majorVersion===1?"native":"default";return`${this.uri}/${c}/${l}/0/${u}.jpg`}getThumbnail(e,t="cover"){return Lo({width:this.width,height:this.height},e,t,{supportsAnyRegionAndSize:this.supportsAnyRegionAndSize,maxWidth:this.maxWidth,maxHeight:this.maxHeight,maxArea:this.maxArea})}}class Ni extends Zl{tileZoomLevels;sizes;embedded=!1;constructor(e){super(e);const t=Gi(e);let i;"tiles"in e&&(i=e.tiles),this.tileZoomLevels=Gl({width:this.width,height:this.height},i,t.supportsAnyRegionAndSize),"sizes"in e&&(this.sizes=e.sizes)}static parse(e,t=null){let i;return t===1?i=lo.parse(e):t===2?i=Oi.parse(e):t===3?i=Fi.parse(e):i=Io.parse(e),new Ni(i)}getIiifTile(e,t,i){return Co({width:this.width,height:this.height},e,t,i)}getThumbnail(e,t="cover"){return Lo({width:this.width,height:this.height},e,t,{supportsAnyRegionAndSize:this.supportsAnyRegionAndSize,sizes:this.sizes,tileZoomLevels:this.tileZoomLevels,maxWidth:this.maxWidth,maxHeight:this.maxHeight,maxArea:this.maxArea})}}const Oo=y.record(y.string(),y.string().array());y.object({label:Oo.optional(),value:Oo.optional()});var _e=63710088e-1,Fo={centimeters:_e*100,centimetres:_e*100,degrees:_e/111325,feet:_e*3.28084,inches:_e*39.37,kilometers:_e/1e3,kilometres:_e/1e3,meters:_e,metres:_e,miles:_e/1609.344,millimeters:_e*1e3,millimetres:_e*1e3,nauticalmiles:_e/1852,radians:1,yards:_e*1.0936};function ql(r,e,t){t===void 0&&(t={});var i={type:"Feature"};return(t.id===0||t.id)&&(i.id=t.id),t.bbox&&(i.bbox=t.bbox),i.properties=e||{},i.geometry=r,i}function Xl(r,e,t){if(t===void 0&&(t={}),!r)throw new Error("coordinates is required");if(!Array.isArray(r))throw new Error("coordinates must be an Array");if(r.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!Do(r[0])||!Do(r[1]))throw new Error("coordinates must contain numbers");var i={type:"Point",coordinates:r};return ql(i,e,t)}function Hl(r,e){e===void 0&&(e="kilometers");var t=Fo[e];if(!t)throw new Error(e+" units is invalid");return r*t}function Yl(r,e){e===void 0&&(e="kilometers");var t=Fo[e];if(!t)throw new Error(e+" units is invalid");return r/t}function Bi(r){var e=r%(2*Math.PI);return e*180/Math.PI}function je(r){var e=r%360;return e*Math.PI/180}function Do(r){return!isNaN(r)&&r!==null&&!Array.isArray(r)}function Et(r){if(!r)throw new Error("coord is required");if(!Array.isArray(r)){if(r.type==="Feature"&&r.geometry!==null&&r.geometry.type==="Point")return r.geometry.coordinates;if(r.type==="Point")return r.coordinates}if(Array.isArray(r)&&r.length>=2&&!Array.isArray(r[0])&&!Array.isArray(r[1]))return r;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function Kl(r){return r.type==="Feature"?r.geometry:r}function Go(r,e,t){if(t===void 0&&(t={}),t.final===!0)return Jl(r,e);var i=Et(r),n=Et(e),o=je(i[0]),s=je(n[0]),a=je(i[1]),c=je(n[1]),l=Math.sin(s-o)*Math.cos(c),h=Math.cos(a)*Math.sin(c)-Math.sin(a)*Math.cos(c)*Math.cos(s-o);return Bi(Math.atan2(l,h))}function Jl(r,e){var t=Go(e,r);return t=(t+180)%360,t}function Ql(r,e,t,i){i===void 0&&(i={});var n=Et(r),o=je(n[0]),s=je(n[1]),a=je(t),c=Yl(e,i.units),l=Math.asin(Math.sin(s)*Math.cos(c)+Math.cos(s)*Math.sin(c)*Math.cos(a)),h=o+Math.atan2(Math.sin(a)*Math.sin(c)*Math.cos(s),Math.cos(c)-Math.sin(s)*Math.sin(l)),u=Bi(h),g=Bi(l);return Xl([u,g],i.properties)}function zi(r,e,t){t===void 0&&(t={});var i=Et(r),n=Et(e),o=je(n[1]-i[1]),s=je(n[0]-i[0]),a=je(i[1]),c=je(n[1]),l=Math.pow(Math.sin(o/2),2)+Math.pow(Math.sin(s/2),2)*Math.cos(a)*Math.cos(c);return Hl(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)),t.units)}function Vr(r,e){var t=zi(r,e),i=Go(r,e),n=Ql(r,t/2,i);return n}function No(r){if(r.__esModule)return r;var e=r.default;if(typeof e=="function"){var t=function i(){return this instanceof i?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(i){var n=Object.getOwnPropertyDescriptor(r,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:function(){return r[i]}})}),t}var Z={};const eh=Object.prototype.toString;function sr(r){const e=eh.call(r);return e.endsWith("Array]")&&!e.includes("Big")}const th=Object.freeze(Object.defineProperty({__proto__:null,isAnyArray:sr},Symbol.toStringTag,{value:"Module"})),rh=No(th);function ih(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!sr(r))throw new TypeError("input must be an array");if(r.length===0)throw new TypeError("input must not be empty");var t=e.fromIndex,i=t===void 0?0:t,n=e.toIndex,o=n===void 0?r.length:n;if(i<0||i>=r.length||!Number.isInteger(i))throw new Error("fromIndex must be a positive integer smaller than length");if(o<=i||o>r.length||!Number.isInteger(o))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var s=r[i],a=i+1;a<o;a++)r[a]>s&&(s=r[a]);return s}function nh(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!sr(r))throw new TypeError("input must be an array");if(r.length===0)throw new TypeError("input must not be empty");var t=e.fromIndex,i=t===void 0?0:t,n=e.toIndex,o=n===void 0?r.length:n;if(i<0||i>=r.length||!Number.isInteger(i))throw new Error("fromIndex must be a positive integer smaller than length");if(o<=i||o>r.length||!Number.isInteger(o))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var s=r[i],a=i+1;a<o;a++)r[a]<s&&(s=r[a]);return s}function oh(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(sr(r)){if(r.length===0)throw new TypeError("input must not be empty")}else throw new TypeError("input must be an array");var t;if(e.output!==void 0){if(!sr(e.output))throw new TypeError("output option must be an array if specified");t=e.output}else t=new Array(r.length);var i=nh(r),n=ih(r);if(i===n)throw new RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");var o=e.min,s=o===void 0?e.autoMinMax?i:0:o,a=e.max,c=a===void 0?e.autoMinMax?n:1:a;if(s>=c)throw new RangeError("min option must be smaller than max option");for(var l=(c-s)/(n-i),h=0;h<r.length;h++)t[h]=(r[h]-i)*l+s;return t}const sh=Object.freeze(Object.defineProperty({__proto__:null,default:oh},Symbol.toStringTag,{value:"Module"})),ah=No(sh);Object.defineProperty(Z,"__esModule",{value:!0});var xe=rh,Bo=ah;const Wr=" ".repeat(2),zo=" ".repeat(4);function ch(){return Uo(this)}function Uo(r,e={}){const{maxRows:t=15,maxColumns:i=10,maxNumSize:n=8,padMinus:o="auto"}=e;return`${r.constructor.name} {
${Wr}[
${zo}${lh(r,t,i,n,o)}
${Wr}]
${Wr}rows: ${r.rows}
${Wr}columns: ${r.columns}
}`}function lh(r,e,t,i,n){const{rows:o,columns:s}=r,a=Math.min(o,e),c=Math.min(s,t),l=[];if(n==="auto"){n=!1;e:for(let h=0;h<a;h++)for(let u=0;u<c;u++)if(r.get(h,u)<0){n=!0;break e}}for(let h=0;h<a;h++){let u=[];for(let g=0;g<c;g++)u.push(hh(r.get(h,g),i,n));l.push(`${u.join(" ")}`)}return c!==s&&(l[l.length-1]+=` ... ${s-t} more columns`),a!==o&&l.push(`... ${o-e} more rows`),l.join(`
${zo}`)}function hh(r,e,t){return(r>=0&&t?` ${Vo(r,e-1)}`:Vo(r,e)).padEnd(e)}function Vo(r,e){let t=r.toString();if(t.length<=e)return t;let i=r.toFixed(e);if(i.length>e&&(i=r.toFixed(Math.max(0,e-(i.length-e)))),i.length<=e&&!i.startsWith("0.000")&&!i.startsWith("-0.000"))return i;let n=r.toExponential(e);return n.length>e&&(n=r.toExponential(Math.max(0,e-(n.length-e)))),n.slice(0)}function uh(r,e){r.prototype.add=function(t){return typeof t=="number"?this.addS(t):this.addM(t)},r.prototype.addS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)+t);return this},r.prototype.addM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)+t.get(i,n));return this},r.add=function(t,i){return new e(t).add(i)},r.prototype.sub=function(t){return typeof t=="number"?this.subS(t):this.subM(t)},r.prototype.subS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)-t);return this},r.prototype.subM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)-t.get(i,n));return this},r.sub=function(t,i){return new e(t).sub(i)},r.prototype.subtract=r.prototype.sub,r.prototype.subtractS=r.prototype.subS,r.prototype.subtractM=r.prototype.subM,r.subtract=r.sub,r.prototype.mul=function(t){return typeof t=="number"?this.mulS(t):this.mulM(t)},r.prototype.mulS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)*t);return this},r.prototype.mulM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)*t.get(i,n));return this},r.mul=function(t,i){return new e(t).mul(i)},r.prototype.multiply=r.prototype.mul,r.prototype.multiplyS=r.prototype.mulS,r.prototype.multiplyM=r.prototype.mulM,r.multiply=r.mul,r.prototype.div=function(t){return typeof t=="number"?this.divS(t):this.divM(t)},r.prototype.divS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)/t);return this},r.prototype.divM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)/t.get(i,n));return this},r.div=function(t,i){return new e(t).div(i)},r.prototype.divide=r.prototype.div,r.prototype.divideS=r.prototype.divS,r.prototype.divideM=r.prototype.divM,r.divide=r.div,r.prototype.mod=function(t){return typeof t=="number"?this.modS(t):this.modM(t)},r.prototype.modS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)%t);return this},r.prototype.modM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)%t.get(i,n));return this},r.mod=function(t,i){return new e(t).mod(i)},r.prototype.modulus=r.prototype.mod,r.prototype.modulusS=r.prototype.modS,r.prototype.modulusM=r.prototype.modM,r.modulus=r.mod,r.prototype.and=function(t){return typeof t=="number"?this.andS(t):this.andM(t)},r.prototype.andS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)&t);return this},r.prototype.andM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)&t.get(i,n));return this},r.and=function(t,i){return new e(t).and(i)},r.prototype.or=function(t){return typeof t=="number"?this.orS(t):this.orM(t)},r.prototype.orS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)|t);return this},r.prototype.orM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)|t.get(i,n));return this},r.or=function(t,i){return new e(t).or(i)},r.prototype.xor=function(t){return typeof t=="number"?this.xorS(t):this.xorM(t)},r.prototype.xorS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)^t);return this},r.prototype.xorM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)^t.get(i,n));return this},r.xor=function(t,i){return new e(t).xor(i)},r.prototype.leftShift=function(t){return typeof t=="number"?this.leftShiftS(t):this.leftShiftM(t)},r.prototype.leftShiftS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)<<t);return this},r.prototype.leftShiftM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)<<t.get(i,n));return this},r.leftShift=function(t,i){return new e(t).leftShift(i)},r.prototype.signPropagatingRightShift=function(t){return typeof t=="number"?this.signPropagatingRightShiftS(t):this.signPropagatingRightShiftM(t)},r.prototype.signPropagatingRightShiftS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)>>t);return this},r.prototype.signPropagatingRightShiftM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)>>t.get(i,n));return this},r.signPropagatingRightShift=function(t,i){return new e(t).signPropagatingRightShift(i)},r.prototype.rightShift=function(t){return typeof t=="number"?this.rightShiftS(t):this.rightShiftM(t)},r.prototype.rightShiftS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)>>>t);return this},r.prototype.rightShiftM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)>>>t.get(i,n));return this},r.rightShift=function(t,i){return new e(t).rightShift(i)},r.prototype.zeroFillRightShift=r.prototype.rightShift,r.prototype.zeroFillRightShiftS=r.prototype.rightShiftS,r.prototype.zeroFillRightShiftM=r.prototype.rightShiftM,r.zeroFillRightShift=r.rightShift,r.prototype.not=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,~this.get(t,i));return this},r.not=function(t){return new e(t).not()},r.prototype.abs=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.abs(this.get(t,i)));return this},r.abs=function(t){return new e(t).abs()},r.prototype.acos=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.acos(this.get(t,i)));return this},r.acos=function(t){return new e(t).acos()},r.prototype.acosh=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.acosh(this.get(t,i)));return this},r.acosh=function(t){return new e(t).acosh()},r.prototype.asin=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.asin(this.get(t,i)));return this},r.asin=function(t){return new e(t).asin()},r.prototype.asinh=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.asinh(this.get(t,i)));return this},r.asinh=function(t){return new e(t).asinh()},r.prototype.atan=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.atan(this.get(t,i)));return this},r.atan=function(t){return new e(t).atan()},r.prototype.atanh=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.atanh(this.get(t,i)));return this},r.atanh=function(t){return new e(t).atanh()},r.prototype.cbrt=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.cbrt(this.get(t,i)));return this},r.cbrt=function(t){return new e(t).cbrt()},r.prototype.ceil=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.ceil(this.get(t,i)));return this},r.ceil=function(t){return new e(t).ceil()},r.prototype.clz32=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.clz32(this.get(t,i)));return this},r.clz32=function(t){return new e(t).clz32()},r.prototype.cos=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.cos(this.get(t,i)));return this},r.cos=function(t){return new e(t).cos()},r.prototype.cosh=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.cosh(this.get(t,i)));return this},r.cosh=function(t){return new e(t).cosh()},r.prototype.exp=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.exp(this.get(t,i)));return this},r.exp=function(t){return new e(t).exp()},r.prototype.expm1=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.expm1(this.get(t,i)));return this},r.expm1=function(t){return new e(t).expm1()},r.prototype.floor=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.floor(this.get(t,i)));return this},r.floor=function(t){return new e(t).floor()},r.prototype.fround=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.fround(this.get(t,i)));return this},r.fround=function(t){return new e(t).fround()},r.prototype.log=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.log(this.get(t,i)));return this},r.log=function(t){return new e(t).log()},r.prototype.log1p=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.log1p(this.get(t,i)));return this},r.log1p=function(t){return new e(t).log1p()},r.prototype.log10=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.log10(this.get(t,i)));return this},r.log10=function(t){return new e(t).log10()},r.prototype.log2=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.log2(this.get(t,i)));return this},r.log2=function(t){return new e(t).log2()},r.prototype.round=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.round(this.get(t,i)));return this},r.round=function(t){return new e(t).round()},r.prototype.sign=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.sign(this.get(t,i)));return this},r.sign=function(t){return new e(t).sign()},r.prototype.sin=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.sin(this.get(t,i)));return this},r.sin=function(t){return new e(t).sin()},r.prototype.sinh=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.sinh(this.get(t,i)));return this},r.sinh=function(t){return new e(t).sinh()},r.prototype.sqrt=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.sqrt(this.get(t,i)));return this},r.sqrt=function(t){return new e(t).sqrt()},r.prototype.tan=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.tan(this.get(t,i)));return this},r.tan=function(t){return new e(t).tan()},r.prototype.tanh=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.tanh(this.get(t,i)));return this},r.tanh=function(t){return new e(t).tanh()},r.prototype.trunc=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.trunc(this.get(t,i)));return this},r.trunc=function(t){return new e(t).trunc()},r.pow=function(t,i){return new e(t).pow(i)},r.prototype.pow=function(t){return typeof t=="number"?this.powS(t):this.powM(t)},r.prototype.powS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,Math.pow(this.get(i,n),t));return this},r.prototype.powM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,Math.pow(this.get(i,n),t.get(i,n)));return this}}function Pe(r,e,t){let i=t?r.rows:r.rows-1;if(e<0||e>i)throw new RangeError("Row index out of range")}function Ee(r,e,t){let i=t?r.columns:r.columns-1;if(e<0||e>i)throw new RangeError("Column index out of range")}function St(r,e){if(e.to1DArray&&(e=e.to1DArray()),e.length!==r.columns)throw new RangeError("vector size must be the same as the number of columns");return e}function Rt(r,e){if(e.to1DArray&&(e=e.to1DArray()),e.length!==r.rows)throw new RangeError("vector size must be the same as the number of rows");return e}function Ui(r,e){if(!xe.isAnyArray(e))throw new TypeError("row indices must be an array");for(let t=0;t<e.length;t++)if(e[t]<0||e[t]>=r.rows)throw new RangeError("row indices are out of range")}function Vi(r,e){if(!xe.isAnyArray(e))throw new TypeError("column indices must be an array");for(let t=0;t<e.length;t++)if(e[t]<0||e[t]>=r.columns)throw new RangeError("column indices are out of range")}function Wi(r,e,t,i,n){if(arguments.length!==5)throw new RangeError("expected 4 arguments");if(Zr("startRow",e),Zr("endRow",t),Zr("startColumn",i),Zr("endColumn",n),e>t||i>n||e<0||e>=r.rows||t<0||t>=r.rows||i<0||i>=r.columns||n<0||n>=r.columns)throw new RangeError("Submatrix indices are out of range")}function $r(r,e=0){let t=[];for(let i=0;i<r;i++)t.push(e);return t}function Zr(r,e){if(typeof e!="number")throw new TypeError(`${r} must be a number`)}function At(r){if(r.isEmpty())throw new Error("Empty matrix has no elements to index")}function dh(r){let e=$r(r.rows);for(let t=0;t<r.rows;++t)for(let i=0;i<r.columns;++i)e[t]+=r.get(t,i);return e}function fh(r){let e=$r(r.columns);for(let t=0;t<r.rows;++t)for(let i=0;i<r.columns;++i)e[i]+=r.get(t,i);return e}function ph(r){let e=0;for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)e+=r.get(t,i);return e}function gh(r){let e=$r(r.rows,1);for(let t=0;t<r.rows;++t)for(let i=0;i<r.columns;++i)e[t]*=r.get(t,i);return e}function mh(r){let e=$r(r.columns,1);for(let t=0;t<r.rows;++t)for(let i=0;i<r.columns;++i)e[i]*=r.get(t,i);return e}function vh(r){let e=1;for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)e*=r.get(t,i);return e}function yh(r,e,t){const i=r.rows,n=r.columns,o=[];for(let s=0;s<i;s++){let a=0,c=0,l=0;for(let h=0;h<n;h++)l=r.get(s,h)-t[s],a+=l,c+=l*l;e?o.push((c-a*a/n)/(n-1)):o.push((c-a*a/n)/n)}return o}function wh(r,e,t){const i=r.rows,n=r.columns,o=[];for(let s=0;s<n;s++){let a=0,c=0,l=0;for(let h=0;h<i;h++)l=r.get(h,s)-t[s],a+=l,c+=l*l;e?o.push((c-a*a/i)/(i-1)):o.push((c-a*a/i)/i)}return o}function _h(r,e,t){const i=r.rows,n=r.columns,o=i*n;let s=0,a=0,c=0;for(let l=0;l<i;l++)for(let h=0;h<n;h++)c=r.get(l,h)-t,s+=c,a+=c*c;return e?(a-s*s/o)/(o-1):(a-s*s/o)/o}function xh(r,e){for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)r.set(t,i,r.get(t,i)-e[t])}function bh(r,e){for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)r.set(t,i,r.get(t,i)-e[i])}function Th(r,e){for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)r.set(t,i,r.get(t,i)-e)}function Mh(r){const e=[];for(let t=0;t<r.rows;t++){let i=0;for(let n=0;n<r.columns;n++)i+=Math.pow(r.get(t,n),2)/(r.columns-1);e.push(Math.sqrt(i))}return e}function Ph(r,e){for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)r.set(t,i,r.get(t,i)/e[t])}function Eh(r){const e=[];for(let t=0;t<r.columns;t++){let i=0;for(let n=0;n<r.rows;n++)i+=Math.pow(r.get(n,t),2)/(r.rows-1);e.push(Math.sqrt(i))}return e}function Sh(r,e){for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)r.set(t,i,r.get(t,i)/e[i])}function Rh(r){const e=r.size-1;let t=0;for(let i=0;i<r.columns;i++)for(let n=0;n<r.rows;n++)t+=Math.pow(r.get(n,i),2)/e;return Math.sqrt(t)}function Ah(r,e){for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)r.set(t,i,r.get(t,i)/e)}let re=class de{static from1DArray(e,t,i){if(e*t!==i.length)throw new RangeError("data length does not match given dimensions");let n=new k(e,t);for(let o=0;o<e;o++)for(let s=0;s<t;s++)n.set(o,s,i[o*t+s]);return n}static rowVector(e){let t=new k(1,e.length);for(let i=0;i<e.length;i++)t.set(0,i,e[i]);return t}static columnVector(e){let t=new k(e.length,1);for(let i=0;i<e.length;i++)t.set(i,0,e[i]);return t}static zeros(e,t){return new k(e,t)}static ones(e,t){return new k(e,t).fill(1)}static rand(e,t,i={}){if(typeof i!="object")throw new TypeError("options must be an object");const{random:n=Math.random}=i;let o=new k(e,t);for(let s=0;s<e;s++)for(let a=0;a<t;a++)o.set(s,a,n());return o}static randInt(e,t,i={}){if(typeof i!="object")throw new TypeError("options must be an object");const{min:n=0,max:o=1e3,random:s=Math.random}=i;if(!Number.isInteger(n))throw new TypeError("min must be an integer");if(!Number.isInteger(o))throw new TypeError("max must be an integer");if(n>=o)throw new RangeError("min must be smaller than max");let a=o-n,c=new k(e,t);for(let l=0;l<e;l++)for(let h=0;h<t;h++){let u=n+Math.round(s()*a);c.set(l,h,u)}return c}static eye(e,t,i){t===void 0&&(t=e),i===void 0&&(i=1);let n=Math.min(e,t),o=this.zeros(e,t);for(let s=0;s<n;s++)o.set(s,s,i);return o}static diag(e,t,i){let n=e.length;t===void 0&&(t=n),i===void 0&&(i=t);let o=Math.min(n,t,i),s=this.zeros(t,i);for(let a=0;a<o;a++)s.set(a,a,e[a]);return s}static min(e,t){e=this.checkMatrix(e),t=this.checkMatrix(t);let i=e.rows,n=e.columns,o=new k(i,n);for(let s=0;s<i;s++)for(let a=0;a<n;a++)o.set(s,a,Math.min(e.get(s,a),t.get(s,a)));return o}static max(e,t){e=this.checkMatrix(e),t=this.checkMatrix(t);let i=e.rows,n=e.columns,o=new this(i,n);for(let s=0;s<i;s++)for(let a=0;a<n;a++)o.set(s,a,Math.max(e.get(s,a),t.get(s,a)));return o}static checkMatrix(e){return de.isMatrix(e)?e:new k(e)}static isMatrix(e){return e!=null&&e.klass==="Matrix"}get size(){return this.rows*this.columns}apply(e){if(typeof e!="function")throw new TypeError("callback must be a function");for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)e.call(this,t,i);return this}to1DArray(){let e=[];for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)e.push(this.get(t,i));return e}to2DArray(){let e=[];for(let t=0;t<this.rows;t++){e.push([]);for(let i=0;i<this.columns;i++)e[t].push(this.get(t,i))}return e}toJSON(){return this.to2DArray()}isRowVector(){return this.rows===1}isColumnVector(){return this.columns===1}isVector(){return this.rows===1||this.columns===1}isSquare(){return this.rows===this.columns}isEmpty(){return this.rows===0||this.columns===0}isSymmetric(){if(this.isSquare()){for(let e=0;e<this.rows;e++)for(let t=0;t<=e;t++)if(this.get(e,t)!==this.get(t,e))return!1;return!0}return!1}isDistance(){if(!this.isSymmetric())return!1;for(let e=0;e<this.rows;e++)if(this.get(e,e)!==0)return!1;return!0}isEchelonForm(){let e=0,t=0,i=-1,n=!0,o=!1;for(;e<this.rows&&n;){for(t=0,o=!1;t<this.columns&&o===!1;)this.get(e,t)===0?t++:this.get(e,t)===1&&t>i?(o=!0,i=t):(n=!1,o=!0);e++}return n}isReducedEchelonForm(){let e=0,t=0,i=-1,n=!0,o=!1;for(;e<this.rows&&n;){for(t=0,o=!1;t<this.columns&&o===!1;)this.get(e,t)===0?t++:this.get(e,t)===1&&t>i?(o=!0,i=t):(n=!1,o=!0);for(let s=t+1;s<this.rows;s++)this.get(e,s)!==0&&(n=!1);e++}return n}echelonForm(){let e=this.clone(),t=0,i=0;for(;t<e.rows&&i<e.columns;){let n=t;for(let o=t;o<e.rows;o++)e.get(o,i)>e.get(n,i)&&(n=o);if(e.get(n,i)===0)i++;else{e.swapRows(t,n);let o=e.get(t,i);for(let s=i;s<e.columns;s++)e.set(t,s,e.get(t,s)/o);for(let s=t+1;s<e.rows;s++){let a=e.get(s,i)/e.get(t,i);e.set(s,i,0);for(let c=i+1;c<e.columns;c++)e.set(s,c,e.get(s,c)-e.get(t,c)*a)}t++,i++}}return e}reducedEchelonForm(){let e=this.echelonForm(),t=e.columns,i=e.rows,n=i-1;for(;n>=0;)if(e.maxRow(n)===0)n--;else{let o=0,s=!1;for(;o<i&&s===!1;)e.get(n,o)===1?s=!0:o++;for(let a=0;a<n;a++){let c=e.get(a,o);for(let l=o;l<t;l++){let h=e.get(a,l)-c*e.get(n,l);e.set(a,l,h)}}n--}return e}set(){throw new Error("set method is unimplemented")}get(){throw new Error("get method is unimplemented")}repeat(e={}){if(typeof e!="object")throw new TypeError("options must be an object");const{rows:t=1,columns:i=1}=e;if(!Number.isInteger(t)||t<=0)throw new TypeError("rows must be a positive integer");if(!Number.isInteger(i)||i<=0)throw new TypeError("columns must be a positive integer");let n=new k(this.rows*t,this.columns*i);for(let o=0;o<t;o++)for(let s=0;s<i;s++)n.setSubMatrix(this,this.rows*o,this.columns*s);return n}fill(e){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,e);return this}neg(){return this.mulS(-1)}getRow(e){Pe(this,e);let t=[];for(let i=0;i<this.columns;i++)t.push(this.get(e,i));return t}getRowVector(e){return k.rowVector(this.getRow(e))}setRow(e,t){Pe(this,e),t=St(this,t);for(let i=0;i<this.columns;i++)this.set(e,i,t[i]);return this}swapRows(e,t){Pe(this,e),Pe(this,t);for(let i=0;i<this.columns;i++){let n=this.get(e,i);this.set(e,i,this.get(t,i)),this.set(t,i,n)}return this}getColumn(e){Ee(this,e);let t=[];for(let i=0;i<this.rows;i++)t.push(this.get(i,e));return t}getColumnVector(e){return k.columnVector(this.getColumn(e))}setColumn(e,t){Ee(this,e),t=Rt(this,t);for(let i=0;i<this.rows;i++)this.set(i,e,t[i]);return this}swapColumns(e,t){Ee(this,e),Ee(this,t);for(let i=0;i<this.rows;i++){let n=this.get(i,e);this.set(i,e,this.get(i,t)),this.set(i,t,n)}return this}addRowVector(e){e=St(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)+e[i]);return this}subRowVector(e){e=St(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)-e[i]);return this}mulRowVector(e){e=St(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)*e[i]);return this}divRowVector(e){e=St(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)/e[i]);return this}addColumnVector(e){e=Rt(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)+e[t]);return this}subColumnVector(e){e=Rt(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)-e[t]);return this}mulColumnVector(e){e=Rt(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)*e[t]);return this}divColumnVector(e){e=Rt(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)/e[t]);return this}mulRow(e,t){Pe(this,e);for(let i=0;i<this.columns;i++)this.set(e,i,this.get(e,i)*t);return this}mulColumn(e,t){Ee(this,e);for(let i=0;i<this.rows;i++)this.set(i,e,this.get(i,e)*t);return this}max(e){if(this.isEmpty())return NaN;switch(e){case"row":{const t=new Array(this.rows).fill(Number.NEGATIVE_INFINITY);for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)>t[i]&&(t[i]=this.get(i,n));return t}case"column":{const t=new Array(this.columns).fill(Number.NEGATIVE_INFINITY);for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)>t[n]&&(t[n]=this.get(i,n));return t}case void 0:{let t=this.get(0,0);for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)>t&&(t=this.get(i,n));return t}default:throw new Error(`invalid option: ${e}`)}}maxIndex(){At(this);let e=this.get(0,0),t=[0,0];for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)>e&&(e=this.get(i,n),t[0]=i,t[1]=n);return t}min(e){if(this.isEmpty())return NaN;switch(e){case"row":{const t=new Array(this.rows).fill(Number.POSITIVE_INFINITY);for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)<t[i]&&(t[i]=this.get(i,n));return t}case"column":{const t=new Array(this.columns).fill(Number.POSITIVE_INFINITY);for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)<t[n]&&(t[n]=this.get(i,n));return t}case void 0:{let t=this.get(0,0);for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)<t&&(t=this.get(i,n));return t}default:throw new Error(`invalid option: ${e}`)}}minIndex(){At(this);let e=this.get(0,0),t=[0,0];for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)<e&&(e=this.get(i,n),t[0]=i,t[1]=n);return t}maxRow(e){if(Pe(this,e),this.isEmpty())return NaN;let t=this.get(e,0);for(let i=1;i<this.columns;i++)this.get(e,i)>t&&(t=this.get(e,i));return t}maxRowIndex(e){Pe(this,e),At(this);let t=this.get(e,0),i=[e,0];for(let n=1;n<this.columns;n++)this.get(e,n)>t&&(t=this.get(e,n),i[1]=n);return i}minRow(e){if(Pe(this,e),this.isEmpty())return NaN;let t=this.get(e,0);for(let i=1;i<this.columns;i++)this.get(e,i)<t&&(t=this.get(e,i));return t}minRowIndex(e){Pe(this,e),At(this);let t=this.get(e,0),i=[e,0];for(let n=1;n<this.columns;n++)this.get(e,n)<t&&(t=this.get(e,n),i[1]=n);return i}maxColumn(e){if(Ee(this,e),this.isEmpty())return NaN;let t=this.get(0,e);for(let i=1;i<this.rows;i++)this.get(i,e)>t&&(t=this.get(i,e));return t}maxColumnIndex(e){Ee(this,e),At(this);let t=this.get(0,e),i=[0,e];for(let n=1;n<this.rows;n++)this.get(n,e)>t&&(t=this.get(n,e),i[0]=n);return i}minColumn(e){if(Ee(this,e),this.isEmpty())return NaN;let t=this.get(0,e);for(let i=1;i<this.rows;i++)this.get(i,e)<t&&(t=this.get(i,e));return t}minColumnIndex(e){Ee(this,e),At(this);let t=this.get(0,e),i=[0,e];for(let n=1;n<this.rows;n++)this.get(n,e)<t&&(t=this.get(n,e),i[0]=n);return i}diag(){let e=Math.min(this.rows,this.columns),t=[];for(let i=0;i<e;i++)t.push(this.get(i,i));return t}norm(e="frobenius"){switch(e){case"max":return this.max();case"frobenius":return Math.sqrt(this.dot(this));default:throw new RangeError(`unknown norm type: ${e}`)}}cumulativeSum(){let e=0;for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)e+=this.get(t,i),this.set(t,i,e);return this}dot(e){de.isMatrix(e)&&(e=e.to1DArray());let t=this.to1DArray();if(t.length!==e.length)throw new RangeError("vectors do not have the same size");let i=0;for(let n=0;n<t.length;n++)i+=t[n]*e[n];return i}mmul(e){e=k.checkMatrix(e);let t=this.rows,i=this.columns,n=e.columns,o=new k(t,n),s=new Float64Array(i);for(let a=0;a<n;a++){for(let c=0;c<i;c++)s[c]=e.get(c,a);for(let c=0;c<t;c++){let l=0;for(let h=0;h<i;h++)l+=this.get(c,h)*s[h];o.set(c,a,l)}}return o}strassen2x2(e){e=k.checkMatrix(e);let t=new k(2,2);const i=this.get(0,0),n=e.get(0,0),o=this.get(0,1),s=e.get(0,1),a=this.get(1,0),c=e.get(1,0),l=this.get(1,1),h=e.get(1,1),u=(i+l)*(n+h),g=(a+l)*n,m=i*(s-h),v=l*(c-n),b=(i+o)*h,E=(a-i)*(n+s),_=(o-l)*(c+h),S=u+v-b+_,d=m+b,p=g+v,x=u-g+m+E;return t.set(0,0,S),t.set(0,1,d),t.set(1,0,p),t.set(1,1,x),t}strassen3x3(e){e=k.checkMatrix(e);let t=new k(3,3);const i=this.get(0,0),n=this.get(0,1),o=this.get(0,2),s=this.get(1,0),a=this.get(1,1),c=this.get(1,2),l=this.get(2,0),h=this.get(2,1),u=this.get(2,2),g=e.get(0,0),m=e.get(0,1),v=e.get(0,2),b=e.get(1,0),E=e.get(1,1),_=e.get(1,2),S=e.get(2,0),d=e.get(2,1),p=e.get(2,2),x=(i+n+o-s-a-h-u)*E,R=(i-s)*(-m+E),I=a*(-g+m+b-E-_-S+p),T=(-i+s+a)*(g-m+E),f=(s+a)*(-g+m),w=i*g,P=(-i+l+h)*(g-v+_),M=(-i+l)*(v-_),$=(l+h)*(-g+v),Y=(i+n+o-a-c-l-h)*_,X=h*(-g+v+b-E-_-S+d),W=(-o+h+u)*(E+S-d),ae=(o-u)*(E-d),pe=o*S,ye=(h+u)*(-S+d),Q=(-o+a+c)*(_+S-p),Ae=(o-c)*(_-p),V=(a+c)*(-S+p),oe=n*b,we=c*d,me=s*v,ue=l*m,Qp=u*p,eg=w+pe+oe,tg=x+T+f+w+W+pe+ye,rg=w+P+$+Y+pe+Q+V,ig=R+I+T+w+pe+Q+Ae,ng=R+T+f+w+we,og=pe+Q+Ae+V+me,sg=w+P+M+X+W+ae+pe,ag=W+ae+pe+ye+ue,cg=w+P+M+$+Qp;return t.set(0,0,eg),t.set(0,1,tg),t.set(0,2,rg),t.set(1,0,ig),t.set(1,1,ng),t.set(1,2,og),t.set(2,0,sg),t.set(2,1,ag),t.set(2,2,cg),t}mmulStrassen(e){e=k.checkMatrix(e);let t=this.clone(),i=t.rows,n=t.columns,o=e.rows,s=e.columns;n!==o&&console.warn(`Multiplying ${i} x ${n} and ${o} x ${s} matrix: dimensions do not match.`);function a(u,g,m){let v=u.rows,b=u.columns;if(v===g&&b===m)return u;{let E=de.zeros(g,m);return E=E.setSubMatrix(u,0,0),E}}let c=Math.max(i,o),l=Math.max(n,s);t=a(t,c,l),e=a(e,c,l);function h(u,g,m,v){if(m<=512||v<=512)return u.mmul(g);m%2===1&&v%2===1?(u=a(u,m+1,v+1),g=a(g,m+1,v+1)):m%2===1?(u=a(u,m+1,v),g=a(g,m+1,v)):v%2===1&&(u=a(u,m,v+1),g=a(g,m,v+1));let b=parseInt(u.rows/2,10),E=parseInt(u.columns/2,10),_=u.subMatrix(0,b-1,0,E-1),S=g.subMatrix(0,b-1,0,E-1),d=u.subMatrix(0,b-1,E,u.columns-1),p=g.subMatrix(0,b-1,E,g.columns-1),x=u.subMatrix(b,u.rows-1,0,E-1),R=g.subMatrix(b,g.rows-1,0,E-1),I=u.subMatrix(b,u.rows-1,E,u.columns-1),T=g.subMatrix(b,g.rows-1,E,g.columns-1),f=h(de.add(_,I),de.add(S,T),b,E),w=h(de.add(x,I),S,b,E),P=h(_,de.sub(p,T),b,E),M=h(I,de.sub(R,S),b,E),$=h(de.add(_,d),T,b,E),Y=h(de.sub(x,_),de.add(S,p),b,E),X=h(de.sub(d,I),de.add(R,T),b,E),W=de.add(f,M);W.sub($),W.add(X);let ae=de.add(P,$),pe=de.add(w,M),ye=de.sub(f,w);ye.add(P),ye.add(Y);let Q=de.zeros(2*W.rows,2*W.columns);return Q=Q.setSubMatrix(W,0,0),Q=Q.setSubMatrix(ae,W.rows,0),Q=Q.setSubMatrix(pe,0,W.columns),Q=Q.setSubMatrix(ye,W.rows,W.columns),Q.subMatrix(0,m-1,0,v-1)}return h(t,e,c,l)}scaleRows(e={}){if(typeof e!="object")throw new TypeError("options must be an object");const{min:t=0,max:i=1}=e;if(!Number.isFinite(t))throw new TypeError("min must be a number");if(!Number.isFinite(i))throw new TypeError("max must be a number");if(t>=i)throw new RangeError("min must be smaller than max");let n=new k(this.rows,this.columns);for(let o=0;o<this.rows;o++){const s=this.getRow(o);s.length>0&&Bo(s,{min:t,max:i,output:s}),n.setRow(o,s)}return n}scaleColumns(e={}){if(typeof e!="object")throw new TypeError("options must be an object");const{min:t=0,max:i=1}=e;if(!Number.isFinite(t))throw new TypeError("min must be a number");if(!Number.isFinite(i))throw new TypeError("max must be a number");if(t>=i)throw new RangeError("min must be smaller than max");let n=new k(this.rows,this.columns);for(let o=0;o<this.columns;o++){const s=this.getColumn(o);s.length&&Bo(s,{min:t,max:i,output:s}),n.setColumn(o,s)}return n}flipRows(){const e=Math.ceil(this.columns/2);for(let t=0;t<this.rows;t++)for(let i=0;i<e;i++){let n=this.get(t,i),o=this.get(t,this.columns-1-i);this.set(t,i,o),this.set(t,this.columns-1-i,n)}return this}flipColumns(){const e=Math.ceil(this.rows/2);for(let t=0;t<this.columns;t++)for(let i=0;i<e;i++){let n=this.get(i,t),o=this.get(this.rows-1-i,t);this.set(i,t,o),this.set(this.rows-1-i,t,n)}return this}kroneckerProduct(e){e=k.checkMatrix(e);let t=this.rows,i=this.columns,n=e.rows,o=e.columns,s=new k(t*n,i*o);for(let a=0;a<t;a++)for(let c=0;c<i;c++)for(let l=0;l<n;l++)for(let h=0;h<o;h++)s.set(n*a+l,o*c+h,this.get(a,c)*e.get(l,h));return s}kroneckerSum(e){if(e=k.checkMatrix(e),!this.isSquare()||!e.isSquare())throw new Error("Kronecker Sum needs two Square Matrices");let t=this.rows,i=e.rows,n=this.kroneckerProduct(k.eye(i,i)),o=k.eye(t,t).kroneckerProduct(e);return n.add(o)}transpose(){let e=new k(this.columns,this.rows);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)e.set(i,t,this.get(t,i));return e}sortRows(e=Wo){for(let t=0;t<this.rows;t++)this.setRow(t,this.getRow(t).sort(e));return this}sortColumns(e=Wo){for(let t=0;t<this.columns;t++)this.setColumn(t,this.getColumn(t).sort(e));return this}subMatrix(e,t,i,n){Wi(this,e,t,i,n);let o=new k(t-e+1,n-i+1);for(let s=e;s<=t;s++)for(let a=i;a<=n;a++)o.set(s-e,a-i,this.get(s,a));return o}subMatrixRow(e,t,i){if(t===void 0&&(t=0),i===void 0&&(i=this.columns-1),t>i||t<0||t>=this.columns||i<0||i>=this.columns)throw new RangeError("Argument out of range");let n=new k(e.length,i-t+1);for(let o=0;o<e.length;o++)for(let s=t;s<=i;s++){if(e[o]<0||e[o]>=this.rows)throw new RangeError(`Row index out of range: ${e[o]}`);n.set(o,s-t,this.get(e[o],s))}return n}subMatrixColumn(e,t,i){if(t===void 0&&(t=0),i===void 0&&(i=this.rows-1),t>i||t<0||t>=this.rows||i<0||i>=this.rows)throw new RangeError("Argument out of range");let n=new k(i-t+1,e.length);for(let o=0;o<e.length;o++)for(let s=t;s<=i;s++){if(e[o]<0||e[o]>=this.columns)throw new RangeError(`Column index out of range: ${e[o]}`);n.set(s-t,o,this.get(s,e[o]))}return n}setSubMatrix(e,t,i){if(e=k.checkMatrix(e),e.isEmpty())return this;let n=t+e.rows-1,o=i+e.columns-1;Wi(this,t,n,i,o);for(let s=0;s<e.rows;s++)for(let a=0;a<e.columns;a++)this.set(t+s,i+a,e.get(s,a));return this}selection(e,t){Ui(this,e),Vi(this,t);let i=new k(e.length,t.length);for(let n=0;n<e.length;n++){let o=e[n];for(let s=0;s<t.length;s++){let a=t[s];i.set(n,s,this.get(o,a))}}return i}trace(){let e=Math.min(this.rows,this.columns),t=0;for(let i=0;i<e;i++)t+=this.get(i,i);return t}clone(){return this.constructor.copy(this,new k(this.rows,this.columns))}static copy(e,t){for(const[i,n,o]of e.entries())t.set(i,n,o);return t}sum(e){switch(e){case"row":return dh(this);case"column":return fh(this);case void 0:return ph(this);default:throw new Error(`invalid option: ${e}`)}}product(e){switch(e){case"row":return gh(this);case"column":return mh(this);case void 0:return vh(this);default:throw new Error(`invalid option: ${e}`)}}mean(e){const t=this.sum(e);switch(e){case"row":{for(let i=0;i<this.rows;i++)t[i]/=this.columns;return t}case"column":{for(let i=0;i<this.columns;i++)t[i]/=this.rows;return t}case void 0:return t/this.size;default:throw new Error(`invalid option: ${e}`)}}variance(e,t={}){if(typeof e=="object"&&(t=e,e=void 0),typeof t!="object")throw new TypeError("options must be an object");const{unbiased:i=!0,mean:n=this.mean(e)}=t;if(typeof i!="boolean")throw new TypeError("unbiased must be a boolean");switch(e){case"row":{if(!xe.isAnyArray(n))throw new TypeError("mean must be an array");return yh(this,i,n)}case"column":{if(!xe.isAnyArray(n))throw new TypeError("mean must be an array");return wh(this,i,n)}case void 0:{if(typeof n!="number")throw new TypeError("mean must be a number");return _h(this,i,n)}default:throw new Error(`invalid option: ${e}`)}}standardDeviation(e,t){typeof e=="object"&&(t=e,e=void 0);const i=this.variance(e,t);if(e===void 0)return Math.sqrt(i);for(let n=0;n<i.length;n++)i[n]=Math.sqrt(i[n]);return i}center(e,t={}){if(typeof e=="object"&&(t=e,e=void 0),typeof t!="object")throw new TypeError("options must be an object");const{center:i=this.mean(e)}=t;switch(e){case"row":{if(!xe.isAnyArray(i))throw new TypeError("center must be an array");return xh(this,i),this}case"column":{if(!xe.isAnyArray(i))throw new TypeError("center must be an array");return bh(this,i),this}case void 0:{if(typeof i!="number")throw new TypeError("center must be a number");return Th(this,i),this}default:throw new Error(`invalid option: ${e}`)}}scale(e,t={}){if(typeof e=="object"&&(t=e,e=void 0),typeof t!="object")throw new TypeError("options must be an object");let i=t.scale;switch(e){case"row":{if(i===void 0)i=Mh(this);else if(!xe.isAnyArray(i))throw new TypeError("scale must be an array");return Ph(this,i),this}case"column":{if(i===void 0)i=Eh(this);else if(!xe.isAnyArray(i))throw new TypeError("scale must be an array");return Sh(this,i),this}case void 0:{if(i===void 0)i=Rh(this);else if(typeof i!="number")throw new TypeError("scale must be a number");return Ah(this,i),this}default:throw new Error(`invalid option: ${e}`)}}toString(e){return Uo(this,e)}[Symbol.iterator](){return this.entries()}*entries(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)yield[e,t,this.get(e,t)]}*values(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)yield this.get(e,t)}};re.prototype.klass="Matrix",typeof Symbol<"u"&&(re.prototype[Symbol.for("nodejs.util.inspect.custom")]=ch);function Wo(r,e){return r-e}function Ih(r){return r.every(e=>typeof e=="number")}re.random=re.rand,re.randomInt=re.randInt,re.diagonal=re.diag,re.prototype.diagonal=re.prototype.diag,re.identity=re.eye,re.prototype.negate=re.prototype.neg,re.prototype.tensorProduct=re.prototype.kroneckerProduct;let k=class Sn extends re{data;#e(e,t){if(this.data=[],Number.isInteger(t)&&t>=0)for(let i=0;i<e;i++)this.data.push(new Float64Array(t));else throw new TypeError("nColumns must be a positive integer");this.rows=e,this.columns=t}constructor(e,t){if(super(),Sn.isMatrix(e))this.#e(e.rows,e.columns),Sn.copy(e,this);else if(Number.isInteger(e)&&e>=0)this.#e(e,t);else if(xe.isAnyArray(e)){const i=e;if(e=i.length,t=e?i[0].length:0,typeof t!="number")throw new TypeError("Data must be a 2D array with at least one element");this.data=[];for(let n=0;n<e;n++){if(i[n].length!==t)throw new RangeError("Inconsistent array dimensions");if(!Ih(i[n]))throw new TypeError("Input data contains non-numeric values");this.data.push(Float64Array.from(i[n]))}this.rows=e,this.columns=t}else throw new TypeError("First argument must be a positive number or an array")}set(e,t,i){return this.data[e][t]=i,this}get(e,t){return this.data[e][t]}removeRow(e){return Pe(this,e),this.data.splice(e,1),this.rows-=1,this}addRow(e,t){return t===void 0&&(t=e,e=this.rows),Pe(this,e,!0),t=Float64Array.from(St(this,t)),this.data.splice(e,0,t),this.rows+=1,this}removeColumn(e){Ee(this,e);for(let t=0;t<this.rows;t++){const i=new Float64Array(this.columns-1);for(let n=0;n<e;n++)i[n]=this.data[t][n];for(let n=e+1;n<this.columns;n++)i[n-1]=this.data[t][n];this.data[t]=i}return this.columns-=1,this}addColumn(e,t){typeof t>"u"&&(t=e,e=this.columns),Ee(this,e,!0),t=Rt(this,t);for(let i=0;i<this.rows;i++){const n=new Float64Array(this.columns+1);let o=0;for(;o<e;o++)n[o]=this.data[i][o];for(n[o++]=t[i];o<this.columns+1;o++)n[o]=this.data[i][o-1];this.data[i]=n}return this.columns+=1,this}};uh(re,k);class lt extends re{#e;get size(){return this.#e.size}get rows(){return this.#e.rows}get columns(){return this.#e.columns}get diagonalSize(){return this.rows}static isSymmetricMatrix(e){return k.isMatrix(e)&&e.klassType==="SymmetricMatrix"}static zeros(e){return new this(e)}static ones(e){return new this(e).fill(1)}constructor(e){if(super(),k.isMatrix(e)){if(!e.isSymmetric())throw new TypeError("not symmetric data");this.#e=k.copy(e,new k(e.rows,e.rows))}else if(Number.isInteger(e)&&e>=0)this.#e=new k(e,e);else if(this.#e=new k(e),!this.isSymmetric())throw new TypeError("not symmetric data")}clone(){const e=new lt(this.diagonalSize);for(const[t,i,n]of this.upperRightEntries())e.set(t,i,n);return e}toMatrix(){return new k(this)}get(e,t){return this.#e.get(e,t)}set(e,t,i){return this.#e.set(e,t,i),this.#e.set(t,e,i),this}removeCross(e){return this.#e.removeRow(e),this.#e.removeColumn(e),this}addCross(e,t){t===void 0&&(t=e,e=this.diagonalSize);const i=t.slice();return i.splice(e,1),this.#e.addRow(e,i),this.#e.addColumn(e,t),this}applyMask(e){if(e.length!==this.diagonalSize)throw new RangeError("Mask size do not match with matrix size");const t=[];for(const[i,n]of e.entries())n||t.push(i);t.reverse();for(const i of t)this.removeCross(i);return this}toCompact(){const{diagonalSize:e}=this,t=new Array(e*(e+1)/2);for(let i=0,n=0,o=0;o<t.length;o++)t[o]=this.get(n,i),++i>=e&&(i=++n);return t}static fromCompact(e){const t=e.length,i=(Math.sqrt(8*t+1)-1)/2;if(!Number.isInteger(i))throw new TypeError(`This array is not a compact representation of a Symmetric Matrix, ${JSON.stringify(e)}`);const n=new lt(i);for(let o=0,s=0,a=0;a<t;a++)n.set(o,s,e[a]),++o>=i&&(o=++s);return n}*upperRightEntries(){for(let e=0,t=0;e<this.diagonalSize;void 0){const i=this.get(e,t);yield[e,t,i],++t>=this.diagonalSize&&(t=++e)}}*upperRightValues(){for(let e=0,t=0;e<this.diagonalSize;void 0)yield this.get(e,t),++t>=this.diagonalSize&&(t=++e)}}lt.prototype.klassType="SymmetricMatrix";class qr extends lt{static isDistanceMatrix(e){return lt.isSymmetricMatrix(e)&&e.klassSubType==="DistanceMatrix"}constructor(e){if(super(e),!this.isDistance())throw new TypeError("Provided arguments do no produce a distance matrix")}set(e,t,i){return e===t&&(i=0),super.set(e,t,i)}addCross(e,t){return t===void 0&&(t=e,e=this.diagonalSize),t=t.slice(),t[e]=0,super.addCross(e,t)}toSymmetricMatrix(){return new lt(this)}clone(){const e=new qr(this.diagonalSize);for(const[t,i,n]of this.upperRightEntries())t!==i&&e.set(t,i,n);return e}toCompact(){const{diagonalSize:e}=this,t=(e-1)*e/2,i=new Array(t);for(let n=1,o=0,s=0;s<i.length;s++)i[s]=this.get(o,n),++n>=e&&(n=++o+1);return i}static fromCompact(e){const t=e.length,i=(Math.sqrt(8*t+1)+1)/2;if(!Number.isInteger(i))throw new TypeError(`This array is not a compact representation of a DistanceMatrix, ${JSON.stringify(e)}`);const n=new this(i);for(let o=1,s=0,a=0;a<t;a++)n.set(o,s,e[a]),++o>=i&&(o=++s+1);return n}}qr.prototype.klassSubType="DistanceMatrix";class Je extends re{constructor(e,t,i){super(),this.matrix=e,this.rows=t,this.columns=i}}class Ch extends Je{constructor(e,t){Ee(e,t),super(e,e.rows,1),this.column=t}set(e,t,i){return this.matrix.set(e,this.column,i),this}get(e){return this.matrix.get(e,this.column)}}class Lh extends Je{constructor(e,t){Vi(e,t),super(e,e.rows,t.length),this.columnIndices=t}set(e,t,i){return this.matrix.set(e,this.columnIndices[t],i),this}get(e,t){return this.matrix.get(e,this.columnIndices[t])}}class kh extends Je{constructor(e){super(e,e.rows,e.columns)}set(e,t,i){return this.matrix.set(e,this.columns-t-1,i),this}get(e,t){return this.matrix.get(e,this.columns-t-1)}}class jh extends Je{constructor(e){super(e,e.rows,e.columns)}set(e,t,i){return this.matrix.set(this.rows-e-1,t,i),this}get(e,t){return this.matrix.get(this.rows-e-1,t)}}class Oh extends Je{constructor(e,t){Pe(e,t),super(e,1,e.columns),this.row=t}set(e,t,i){return this.matrix.set(this.row,t,i),this}get(e,t){return this.matrix.get(this.row,t)}}class Fh extends Je{constructor(e,t){Ui(e,t),super(e,t.length,e.columns),this.rowIndices=t}set(e,t,i){return this.matrix.set(this.rowIndices[e],t,i),this}get(e,t){return this.matrix.get(this.rowIndices[e],t)}}class Xr extends Je{constructor(e,t,i){Ui(e,t),Vi(e,i),super(e,t.length,i.length),this.rowIndices=t,this.columnIndices=i}set(e,t,i){return this.matrix.set(this.rowIndices[e],this.columnIndices[t],i),this}get(e,t){return this.matrix.get(this.rowIndices[e],this.columnIndices[t])}}class Dh extends Je{constructor(e,t,i,n,o){Wi(e,t,i,n,o),super(e,i-t+1,o-n+1),this.startRow=t,this.startColumn=n}set(e,t,i){return this.matrix.set(this.startRow+e,this.startColumn+t,i),this}get(e,t){return this.matrix.get(this.startRow+e,this.startColumn+t)}}class Gh extends Je{constructor(e){super(e,e.columns,e.rows)}set(e,t,i){return this.matrix.set(t,e,i),this}get(e,t){return this.matrix.get(t,e)}}class $o extends re{constructor(e,t={}){const{rows:i=1}=t;if(e.length%i!==0)throw new Error("the data length is not divisible by the number of rows");super(),this.rows=i,this.columns=e.length/i,this.data=e}set(e,t,i){let n=this._calculateIndex(e,t);return this.data[n]=i,this}get(e,t){let i=this._calculateIndex(e,t);return this.data[i]}_calculateIndex(e,t){return e*this.columns+t}}let Te=class extends re{constructor(e){super(),this.data=e,this.rows=e.length,this.columns=e[0].length}set(e,t,i){return this.data[e][t]=i,this}get(e,t){return this.data[e][t]}};function Nh(r,e){if(xe.isAnyArray(r))return r[0]&&xe.isAnyArray(r[0])?new Te(r):new $o(r,e);throw new Error("the argument is not an array")}class Hr{constructor(e){e=Te.checkMatrix(e);let t=e.clone(),i=t.rows,n=t.columns,o=new Float64Array(i),s=1,a,c,l,h,u,g,m,v,b;for(a=0;a<i;a++)o[a]=a;for(v=new Float64Array(i),c=0;c<n;c++){for(a=0;a<i;a++)v[a]=t.get(a,c);for(a=0;a<i;a++){for(b=Math.min(a,c),u=0,l=0;l<b;l++)u+=t.get(a,l)*v[l];v[a]-=u,t.set(a,c,v[a])}for(h=c,a=c+1;a<i;a++)Math.abs(v[a])>Math.abs(v[h])&&(h=a);if(h!==c){for(l=0;l<n;l++)g=t.get(h,l),t.set(h,l,t.get(c,l)),t.set(c,l,g);m=o[h],o[h]=o[c],o[c]=m,s=-s}if(c<i&&t.get(c,c)!==0)for(a=c+1;a<i;a++)t.set(a,c,t.get(a,c)/t.get(c,c))}this.LU=t,this.pivotVector=o,this.pivotSign=s}isSingular(){let e=this.LU,t=e.columns;for(let i=0;i<t;i++)if(e.get(i,i)===0)return!0;return!1}solve(e){e=k.checkMatrix(e);let t=this.LU;if(t.rows!==e.rows)throw new Error("Invalid matrix dimensions");if(this.isSingular())throw new Error("LU matrix is singular");let i=e.columns,n=e.subMatrixRow(this.pivotVector,0,i-1),o=t.columns,s,a,c;for(c=0;c<o;c++)for(s=c+1;s<o;s++)for(a=0;a<i;a++)n.set(s,a,n.get(s,a)-n.get(c,a)*t.get(s,c));for(c=o-1;c>=0;c--){for(a=0;a<i;a++)n.set(c,a,n.get(c,a)/t.get(c,c));for(s=0;s<c;s++)for(a=0;a<i;a++)n.set(s,a,n.get(s,a)-n.get(c,a)*t.get(s,c))}return n}get determinant(){let e=this.LU;if(!e.isSquare())throw new Error("Matrix must be square");let t=this.pivotSign,i=e.columns;for(let n=0;n<i;n++)t*=e.get(n,n);return t}get lowerTriangularMatrix(){let e=this.LU,t=e.rows,i=e.columns,n=new k(t,i);for(let o=0;o<t;o++)for(let s=0;s<i;s++)o>s?n.set(o,s,e.get(o,s)):o===s?n.set(o,s,1):n.set(o,s,0);return n}get upperTriangularMatrix(){let e=this.LU,t=e.rows,i=e.columns,n=new k(t,i);for(let o=0;o<t;o++)for(let s=0;s<i;s++)o<=s?n.set(o,s,e.get(o,s)):n.set(o,s,0);return n}get pivotPermutationVector(){return Array.from(this.pivotVector)}}function Qe(r,e){let t=0;return Math.abs(r)>Math.abs(e)?(t=e/r,Math.abs(r)*Math.sqrt(1+t*t)):e!==0?(t=r/e,Math.abs(e)*Math.sqrt(1+t*t)):0}class $i{constructor(e){e=Te.checkMatrix(e);let t=e.clone(),i=e.rows,n=e.columns,o=new Float64Array(n),s,a,c,l;for(c=0;c<n;c++){let h=0;for(s=c;s<i;s++)h=Qe(h,t.get(s,c));if(h!==0){for(t.get(c,c)<0&&(h=-h),s=c;s<i;s++)t.set(s,c,t.get(s,c)/h);for(t.set(c,c,t.get(c,c)+1),a=c+1;a<n;a++){for(l=0,s=c;s<i;s++)l+=t.get(s,c)*t.get(s,a);for(l=-l/t.get(c,c),s=c;s<i;s++)t.set(s,a,t.get(s,a)+l*t.get(s,c))}}o[c]=-h}this.QR=t,this.Rdiag=o}solve(e){e=k.checkMatrix(e);let t=this.QR,i=t.rows;if(e.rows!==i)throw new Error("Matrix row dimensions must agree");if(!this.isFullRank())throw new Error("Matrix is rank deficient");let n=e.columns,o=e.clone(),s=t.columns,a,c,l,h;for(l=0;l<s;l++)for(c=0;c<n;c++){for(h=0,a=l;a<i;a++)h+=t.get(a,l)*o.get(a,c);for(h=-h/t.get(l,l),a=l;a<i;a++)o.set(a,c,o.get(a,c)+h*t.get(a,l))}for(l=s-1;l>=0;l--){for(c=0;c<n;c++)o.set(l,c,o.get(l,c)/this.Rdiag[l]);for(a=0;a<l;a++)for(c=0;c<n;c++)o.set(a,c,o.get(a,c)-o.get(l,c)*t.get(a,l))}return o.subMatrix(0,s-1,0,n-1)}isFullRank(){let e=this.QR.columns;for(let t=0;t<e;t++)if(this.Rdiag[t]===0)return!1;return!0}get upperTriangularMatrix(){let e=this.QR,t=e.columns,i=new k(t,t),n,o;for(n=0;n<t;n++)for(o=0;o<t;o++)n<o?i.set(n,o,e.get(n,o)):n===o?i.set(n,o,this.Rdiag[n]):i.set(n,o,0);return i}get orthogonalMatrix(){let e=this.QR,t=e.rows,i=e.columns,n=new k(t,i),o,s,a,c;for(a=i-1;a>=0;a--){for(o=0;o<t;o++)n.set(o,a,0);for(n.set(a,a,1),s=a;s<i;s++)if(e.get(a,a)!==0){for(c=0,o=a;o<t;o++)c+=e.get(o,a)*n.get(o,s);for(c=-c/e.get(a,a),o=a;o<t;o++)n.set(o,s,n.get(o,s)+c*e.get(o,a))}}return n}}let It=class{constructor(r,e={}){if(r=Te.checkMatrix(r),r.isEmpty())throw new Error("Matrix must be non-empty");let t=r.rows,i=r.columns;const{computeLeftSingularVectors:n=!0,computeRightSingularVectors:o=!0,autoTranspose:s=!1}=e;let a=!!n,c=!!o,l=!1,h;if(t<i)if(!s)h=r.clone(),console.warn("Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose");else{h=r.transpose(),t=h.rows,i=h.columns,l=!0;let f=a;a=c,c=f}else h=r.clone();let u=Math.min(t,i),g=Math.min(t+1,i),m=new Float64Array(g),v=new k(t,u),b=new k(i,i),E=new Float64Array(i),_=new Float64Array(t),S=new Float64Array(g);for(let f=0;f<g;f++)S[f]=f;let d=Math.min(t-1,i),p=Math.max(0,Math.min(i-2,t)),x=Math.max(d,p);for(let f=0;f<x;f++){if(f<d){m[f]=0;for(let w=f;w<t;w++)m[f]=Qe(m[f],h.get(w,f));if(m[f]!==0){h.get(f,f)<0&&(m[f]=-m[f]);for(let w=f;w<t;w++)h.set(w,f,h.get(w,f)/m[f]);h.set(f,f,h.get(f,f)+1)}m[f]=-m[f]}for(let w=f+1;w<i;w++){if(f<d&&m[f]!==0){let P=0;for(let M=f;M<t;M++)P+=h.get(M,f)*h.get(M,w);P=-P/h.get(f,f);for(let M=f;M<t;M++)h.set(M,w,h.get(M,w)+P*h.get(M,f))}E[w]=h.get(f,w)}if(a&&f<d)for(let w=f;w<t;w++)v.set(w,f,h.get(w,f));if(f<p){E[f]=0;for(let w=f+1;w<i;w++)E[f]=Qe(E[f],E[w]);if(E[f]!==0){E[f+1]<0&&(E[f]=0-E[f]);for(let w=f+1;w<i;w++)E[w]/=E[f];E[f+1]+=1}if(E[f]=-E[f],f+1<t&&E[f]!==0){for(let w=f+1;w<t;w++)_[w]=0;for(let w=f+1;w<t;w++)for(let P=f+1;P<i;P++)_[w]+=E[P]*h.get(w,P);for(let w=f+1;w<i;w++){let P=-E[w]/E[f+1];for(let M=f+1;M<t;M++)h.set(M,w,h.get(M,w)+P*_[M])}}if(c)for(let w=f+1;w<i;w++)b.set(w,f,E[w])}}let R=Math.min(i,t+1);if(d<i&&(m[d]=h.get(d,d)),t<R&&(m[R-1]=0),p+1<R&&(E[p]=h.get(p,R-1)),E[R-1]=0,a){for(let f=d;f<u;f++){for(let w=0;w<t;w++)v.set(w,f,0);v.set(f,f,1)}for(let f=d-1;f>=0;f--)if(m[f]!==0){for(let w=f+1;w<u;w++){let P=0;for(let M=f;M<t;M++)P+=v.get(M,f)*v.get(M,w);P=-P/v.get(f,f);for(let M=f;M<t;M++)v.set(M,w,v.get(M,w)+P*v.get(M,f))}for(let w=f;w<t;w++)v.set(w,f,-v.get(w,f));v.set(f,f,1+v.get(f,f));for(let w=0;w<f-1;w++)v.set(w,f,0)}else{for(let w=0;w<t;w++)v.set(w,f,0);v.set(f,f,1)}}if(c)for(let f=i-1;f>=0;f--){if(f<p&&E[f]!==0)for(let w=f+1;w<i;w++){let P=0;for(let M=f+1;M<i;M++)P+=b.get(M,f)*b.get(M,w);P=-P/b.get(f+1,f);for(let M=f+1;M<i;M++)b.set(M,w,b.get(M,w)+P*b.get(M,f))}for(let w=0;w<i;w++)b.set(w,f,0);b.set(f,f,1)}let I=R-1,T=Number.EPSILON;for(;R>0;){let f,w;for(f=R-2;f>=-1&&f!==-1;f--){const P=Number.MIN_VALUE+T*Math.abs(m[f]+Math.abs(m[f+1]));if(Math.abs(E[f])<=P||Number.isNaN(E[f])){E[f]=0;break}}if(f===R-2)w=4;else{let P;for(P=R-1;P>=f&&P!==f;P--){let M=(P!==R?Math.abs(E[P]):0)+(P!==f+1?Math.abs(E[P-1]):0);if(Math.abs(m[P])<=T*M){m[P]=0;break}}P===f?w=3:P===R-1?w=1:(w=2,f=P)}switch(f++,w){case 1:{let P=E[R-2];E[R-2]=0;for(let M=R-2;M>=f;M--){let $=Qe(m[M],P),Y=m[M]/$,X=P/$;if(m[M]=$,M!==f&&(P=-X*E[M-1],E[M-1]=Y*E[M-1]),c)for(let W=0;W<i;W++)$=Y*b.get(W,M)+X*b.get(W,R-1),b.set(W,R-1,-X*b.get(W,M)+Y*b.get(W,R-1)),b.set(W,M,$)}break}case 2:{let P=E[f-1];E[f-1]=0;for(let M=f;M<R;M++){let $=Qe(m[M],P),Y=m[M]/$,X=P/$;if(m[M]=$,P=-X*E[M],E[M]=Y*E[M],a)for(let W=0;W<t;W++)$=Y*v.get(W,M)+X*v.get(W,f-1),v.set(W,f-1,-X*v.get(W,M)+Y*v.get(W,f-1)),v.set(W,M,$)}break}case 3:{const P=Math.max(Math.abs(m[R-1]),Math.abs(m[R-2]),Math.abs(E[R-2]),Math.abs(m[f]),Math.abs(E[f])),M=m[R-1]/P,$=m[R-2]/P,Y=E[R-2]/P,X=m[f]/P,W=E[f]/P,ae=(($+M)*($-M)+Y*Y)/2,pe=M*Y*(M*Y);let ye=0;(ae!==0||pe!==0)&&(ae<0?ye=0-Math.sqrt(ae*ae+pe):ye=Math.sqrt(ae*ae+pe),ye=pe/(ae+ye));let Q=(X+M)*(X-M)+ye,Ae=X*W;for(let V=f;V<R-1;V++){let oe=Qe(Q,Ae);oe===0&&(oe=Number.MIN_VALUE);let we=Q/oe,me=Ae/oe;if(V!==f&&(E[V-1]=oe),Q=we*m[V]+me*E[V],E[V]=we*E[V]-me*m[V],Ae=me*m[V+1],m[V+1]=we*m[V+1],c)for(let ue=0;ue<i;ue++)oe=we*b.get(ue,V)+me*b.get(ue,V+1),b.set(ue,V+1,-me*b.get(ue,V)+we*b.get(ue,V+1)),b.set(ue,V,oe);if(oe=Qe(Q,Ae),oe===0&&(oe=Number.MIN_VALUE),we=Q/oe,me=Ae/oe,m[V]=oe,Q=we*E[V]+me*m[V+1],m[V+1]=-me*E[V]+we*m[V+1],Ae=me*E[V+1],E[V+1]=we*E[V+1],a&&V<t-1)for(let ue=0;ue<t;ue++)oe=we*v.get(ue,V)+me*v.get(ue,V+1),v.set(ue,V+1,-me*v.get(ue,V)+we*v.get(ue,V+1)),v.set(ue,V,oe)}E[R-2]=Q;break}case 4:{if(m[f]<=0&&(m[f]=m[f]<0?-m[f]:0,c))for(let P=0;P<=I;P++)b.set(P,f,-b.get(P,f));for(;f<I&&!(m[f]>=m[f+1]);){let P=m[f];if(m[f]=m[f+1],m[f+1]=P,c&&f<i-1)for(let M=0;M<i;M++)P=b.get(M,f+1),b.set(M,f+1,b.get(M,f)),b.set(M,f,P);if(a&&f<t-1)for(let M=0;M<t;M++)P=v.get(M,f+1),v.set(M,f+1,v.get(M,f)),v.set(M,f,P);f++}R--;break}}}if(l){let f=b;b=v,v=f}this.m=t,this.n=i,this.s=m,this.U=v,this.V=b}solve(r){let e=r,t=this.threshold,i=this.s.length,n=k.zeros(i,i);for(let u=0;u<i;u++)Math.abs(this.s[u])<=t?n.set(u,u,0):n.set(u,u,1/this.s[u]);let o=this.U,s=this.rightSingularVectors,a=s.mmul(n),c=s.rows,l=o.rows,h=k.zeros(c,l);for(let u=0;u<c;u++)for(let g=0;g<l;g++){let m=0;for(let v=0;v<i;v++)m+=a.get(u,v)*o.get(g,v);h.set(u,g,m)}return h.mmul(e)}solveForDiagonal(r){return this.solve(k.diag(r))}inverse(){let r=this.V,e=this.threshold,t=r.rows,i=r.columns,n=new k(t,this.s.length);for(let l=0;l<t;l++)for(let h=0;h<i;h++)Math.abs(this.s[h])>e&&n.set(l,h,r.get(l,h)/this.s[h]);let o=this.U,s=o.rows,a=o.columns,c=new k(t,s);for(let l=0;l<t;l++)for(let h=0;h<s;h++){let u=0;for(let g=0;g<a;g++)u+=n.get(l,g)*o.get(h,g);c.set(l,h,u)}return c}get condition(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]}get norm2(){return this.s[0]}get rank(){let r=Math.max(this.m,this.n)*this.s[0]*Number.EPSILON,e=0,t=this.s;for(let i=0,n=t.length;i<n;i++)t[i]>r&&e++;return e}get diagonal(){return Array.from(this.s)}get threshold(){return Number.EPSILON/2*Math.max(this.m,this.n)*this.s[0]}get leftSingularVectors(){return this.U}get rightSingularVectors(){return this.V}get diagonalMatrix(){return k.diag(this.s)}};function Bh(r,e=!1){return r=Te.checkMatrix(r),e?new It(r).inverse():Zo(r,k.eye(r.rows))}function Zo(r,e,t=!1){return r=Te.checkMatrix(r),e=Te.checkMatrix(e),t?new It(r).solve(e):r.isSquare()?new Hr(r).solve(e):new $i(r).solve(e)}function Yr(r){if(r=k.checkMatrix(r),r.isSquare()){if(r.columns===0)return 1;let e,t,i,n;if(r.columns===2)return e=r.get(0,0),t=r.get(0,1),i=r.get(1,0),n=r.get(1,1),e*n-t*i;if(r.columns===3){let o,s,a;return o=new Xr(r,[1,2],[1,2]),s=new Xr(r,[1,2],[0,2]),a=new Xr(r,[1,2],[0,1]),e=r.get(0,0),t=r.get(0,1),i=r.get(0,2),e*Yr(o)-t*Yr(s)+i*Yr(a)}else return new Hr(r).determinant}else throw Error("determinant can only be calculated for a square matrix")}function zh(r,e){let t=[];for(let i=0;i<r;i++)i!==e&&t.push(i);return t}function Uh(r,e,t,i=1e-9,n=1e-9){if(r>n)return new Array(e.rows+1).fill(0);{let o=e.addRow(t,[0]);for(let s=0;s<o.rows;s++)Math.abs(o.get(s,0))<i&&o.set(s,0,0);return o.to1DArray()}}function Vh(r,e={}){const{thresholdValue:t=1e-9,thresholdError:i=1e-9}=e;r=k.checkMatrix(r);let n=r.rows,o=new k(n,n);for(let s=0;s<n;s++){let a=k.columnVector(r.getRow(s)),c=r.subMatrixRow(zh(n,s)).transpose(),l=new It(c).solve(a),h=k.sub(a,c.mmul(l)).abs().max();o.setRow(s,Uh(h,l,s,t,i))}return o}function Wh(r,e=Number.EPSILON){if(r=k.checkMatrix(r),r.isEmpty())return r.transpose();let t=new It(r,{autoTranspose:!0}),i=t.leftSingularVectors,n=t.rightSingularVectors,o=t.diagonal;for(let s=0;s<o.length;s++)Math.abs(o[s])>e?o[s]=1/o[s]:o[s]=0;return n.mmul(k.diag(o).mmul(i.transpose()))}function $h(r,e=r,t={}){r=new k(r);let i=!1;if(typeof e=="object"&&!k.isMatrix(e)&&!xe.isAnyArray(e)?(t=e,e=r,i=!0):e=new k(e),r.rows!==e.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:n=!0}=t;n&&(r=r.center("column"),i||(e=e.center("column")));const o=r.transpose().mmul(e);for(let s=0;s<o.rows;s++)for(let a=0;a<o.columns;a++)o.set(s,a,o.get(s,a)*(1/(r.rows-1)));return o}function Zh(r,e=r,t={}){r=new k(r);let i=!1;if(typeof e=="object"&&!k.isMatrix(e)&&!xe.isAnyArray(e)?(t=e,e=r,i=!0):e=new k(e),r.rows!==e.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:n=!0,scale:o=!0}=t;n&&(r.center("column"),i||e.center("column")),o&&(r.scale("column"),i||e.scale("column"));const s=r.standardDeviation("column",{unbiased:!0}),a=i?s:e.standardDeviation("column",{unbiased:!0}),c=r.transpose().mmul(e);for(let l=0;l<c.rows;l++)for(let h=0;h<c.columns;h++)c.set(l,h,c.get(l,h)*(1/(s[l]*a[h]))*(1/(r.rows-1)));return c}class qo{constructor(e,t={}){const{assumeSymmetric:i=!1}=t;if(e=Te.checkMatrix(e),!e.isSquare())throw new Error("Matrix is not a square matrix");if(e.isEmpty())throw new Error("Matrix must be non-empty");let n=e.columns,o=new k(n,n),s=new Float64Array(n),a=new Float64Array(n),c=e,l,h,u=!1;if(i?u=!0:u=e.isSymmetric(),u){for(l=0;l<n;l++)for(h=0;h<n;h++)o.set(l,h,c.get(l,h));qh(n,a,s,o),Xh(n,a,s,o)}else{let g=new k(n,n),m=new Float64Array(n);for(h=0;h<n;h++)for(l=0;l<n;l++)g.set(l,h,c.get(l,h));Hh(n,g,m,o),Yh(n,a,s,o,g)}this.n=n,this.e=a,this.d=s,this.V=o}get realEigenvalues(){return Array.from(this.d)}get imaginaryEigenvalues(){return Array.from(this.e)}get eigenvectorMatrix(){return this.V}get diagonalMatrix(){let e=this.n,t=this.e,i=this.d,n=new k(e,e),o,s;for(o=0;o<e;o++){for(s=0;s<e;s++)n.set(o,s,0);n.set(o,o,i[o]),t[o]>0?n.set(o,o+1,t[o]):t[o]<0&&n.set(o,o-1,t[o])}return n}}function qh(r,e,t,i){let n,o,s,a,c,l,h,u;for(c=0;c<r;c++)t[c]=i.get(r-1,c);for(a=r-1;a>0;a--){for(u=0,s=0,l=0;l<a;l++)u=u+Math.abs(t[l]);if(u===0)for(e[a]=t[a-1],c=0;c<a;c++)t[c]=i.get(a-1,c),i.set(a,c,0),i.set(c,a,0);else{for(l=0;l<a;l++)t[l]/=u,s+=t[l]*t[l];for(n=t[a-1],o=Math.sqrt(s),n>0&&(o=-o),e[a]=u*o,s=s-n*o,t[a-1]=n-o,c=0;c<a;c++)e[c]=0;for(c=0;c<a;c++){for(n=t[c],i.set(c,a,n),o=e[c]+i.get(c,c)*n,l=c+1;l<=a-1;l++)o+=i.get(l,c)*t[l],e[l]+=i.get(l,c)*n;e[c]=o}for(n=0,c=0;c<a;c++)e[c]/=s,n+=e[c]*t[c];for(h=n/(s+s),c=0;c<a;c++)e[c]-=h*t[c];for(c=0;c<a;c++){for(n=t[c],o=e[c],l=c;l<=a-1;l++)i.set(l,c,i.get(l,c)-(n*e[l]+o*t[l]));t[c]=i.get(a-1,c),i.set(a,c,0)}}t[a]=s}for(a=0;a<r-1;a++){if(i.set(r-1,a,i.get(a,a)),i.set(a,a,1),s=t[a+1],s!==0){for(l=0;l<=a;l++)t[l]=i.get(l,a+1)/s;for(c=0;c<=a;c++){for(o=0,l=0;l<=a;l++)o+=i.get(l,a+1)*i.get(l,c);for(l=0;l<=a;l++)i.set(l,c,i.get(l,c)-o*t[l])}}for(l=0;l<=a;l++)i.set(l,a+1,0)}for(c=0;c<r;c++)t[c]=i.get(r-1,c),i.set(r-1,c,0);i.set(r-1,r-1,1),e[0]=0}function Xh(r,e,t,i){let n,o,s,a,c,l,h,u,g,m,v,b,E,_,S,d;for(s=1;s<r;s++)e[s-1]=e[s];e[r-1]=0;let p=0,x=0,R=Number.EPSILON;for(l=0;l<r;l++){for(x=Math.max(x,Math.abs(t[l])+Math.abs(e[l])),h=l;h<r&&!(Math.abs(e[h])<=R*x);)h++;if(h>l)do{for(n=t[l],u=(t[l+1]-n)/(2*e[l]),g=Qe(u,1),u<0&&(g=-g),t[l]=e[l]/(u+g),t[l+1]=e[l]*(u+g),m=t[l+1],o=n-t[l],s=l+2;s<r;s++)t[s]-=o;for(p=p+o,u=t[h],v=1,b=v,E=v,_=e[l+1],S=0,d=0,s=h-1;s>=l;s--)for(E=b,b=v,d=S,n=v*e[s],o=v*u,g=Qe(u,e[s]),e[s+1]=S*g,S=e[s]/g,v=u/g,u=v*t[s]-S*n,t[s+1]=o+S*(v*n+S*t[s]),c=0;c<r;c++)o=i.get(c,s+1),i.set(c,s+1,S*i.get(c,s)+v*o),i.set(c,s,v*i.get(c,s)-S*o);u=-S*d*E*_*e[l]/m,e[l]=S*u,t[l]=v*u}while(Math.abs(e[l])>R*x);t[l]=t[l]+p,e[l]=0}for(s=0;s<r-1;s++){for(c=s,u=t[s],a=s+1;a<r;a++)t[a]<u&&(c=a,u=t[a]);if(c!==s)for(t[c]=t[s],t[s]=u,a=0;a<r;a++)u=i.get(a,s),i.set(a,s,i.get(a,c)),i.set(a,c,u)}}function Hh(r,e,t,i){let n=0,o=r-1,s,a,c,l,h,u,g;for(u=n+1;u<=o-1;u++){for(g=0,l=u;l<=o;l++)g=g+Math.abs(e.get(l,u-1));if(g!==0){for(c=0,l=o;l>=u;l--)t[l]=e.get(l,u-1)/g,c+=t[l]*t[l];for(a=Math.sqrt(c),t[u]>0&&(a=-a),c=c-t[u]*a,t[u]=t[u]-a,h=u;h<r;h++){for(s=0,l=o;l>=u;l--)s+=t[l]*e.get(l,h);for(s=s/c,l=u;l<=o;l++)e.set(l,h,e.get(l,h)-s*t[l])}for(l=0;l<=o;l++){for(s=0,h=o;h>=u;h--)s+=t[h]*e.get(l,h);for(s=s/c,h=u;h<=o;h++)e.set(l,h,e.get(l,h)-s*t[h])}t[u]=g*t[u],e.set(u,u-1,g*a)}}for(l=0;l<r;l++)for(h=0;h<r;h++)i.set(l,h,l===h?1:0);for(u=o-1;u>=n+1;u--)if(e.get(u,u-1)!==0){for(l=u+1;l<=o;l++)t[l]=e.get(l,u-1);for(h=u;h<=o;h++){for(a=0,l=u;l<=o;l++)a+=t[l]*i.get(l,h);for(a=a/t[u]/e.get(u,u-1),l=u;l<=o;l++)i.set(l,h,i.get(l,h)+a*t[l])}}}function Yh(r,e,t,i,n){let o=r-1,s=0,a=r-1,c=Number.EPSILON,l=0,h=0,u=0,g=0,m=0,v=0,b=0,E=0,_,S,d,p,x,R,I,T,f,w,P,M,$,Y,X;for(_=0;_<r;_++)for((_<s||_>a)&&(t[_]=n.get(_,_),e[_]=0),S=Math.max(_-1,0);S<r;S++)h=h+Math.abs(n.get(_,S));for(;o>=s;){for(p=o;p>s&&(v=Math.abs(n.get(p-1,p-1))+Math.abs(n.get(p,p)),v===0&&(v=h),!(Math.abs(n.get(p,p-1))<c*v));)p--;if(p===o)n.set(o,o,n.get(o,o)+l),t[o]=n.get(o,o),e[o]=0,o--,E=0;else if(p===o-1){if(I=n.get(o,o-1)*n.get(o-1,o),u=(n.get(o-1,o-1)-n.get(o,o))/2,g=u*u+I,b=Math.sqrt(Math.abs(g)),n.set(o,o,n.get(o,o)+l),n.set(o-1,o-1,n.get(o-1,o-1)+l),T=n.get(o,o),g>=0){for(b=u>=0?u+b:u-b,t[o-1]=T+b,t[o]=t[o-1],b!==0&&(t[o]=T-I/b),e[o-1]=0,e[o]=0,T=n.get(o,o-1),v=Math.abs(T)+Math.abs(b),u=T/v,g=b/v,m=Math.sqrt(u*u+g*g),u=u/m,g=g/m,S=o-1;S<r;S++)b=n.get(o-1,S),n.set(o-1,S,g*b+u*n.get(o,S)),n.set(o,S,g*n.get(o,S)-u*b);for(_=0;_<=o;_++)b=n.get(_,o-1),n.set(_,o-1,g*b+u*n.get(_,o)),n.set(_,o,g*n.get(_,o)-u*b);for(_=s;_<=a;_++)b=i.get(_,o-1),i.set(_,o-1,g*b+u*i.get(_,o)),i.set(_,o,g*i.get(_,o)-u*b)}else t[o-1]=T+u,t[o]=T+u,e[o-1]=b,e[o]=-b;o=o-2,E=0}else{if(T=n.get(o,o),f=0,I=0,p<o&&(f=n.get(o-1,o-1),I=n.get(o,o-1)*n.get(o-1,o)),E===10){for(l+=T,_=s;_<=o;_++)n.set(_,_,n.get(_,_)-T);v=Math.abs(n.get(o,o-1))+Math.abs(n.get(o-1,o-2)),T=f=.75*v,I=-.4375*v*v}if(E===30&&(v=(f-T)/2,v=v*v+I,v>0)){for(v=Math.sqrt(v),f<T&&(v=-v),v=T-I/((f-T)/2+v),_=s;_<=o;_++)n.set(_,_,n.get(_,_)-v);l+=v,T=f=I=.964}for(E=E+1,x=o-2;x>=p&&(b=n.get(x,x),m=T-b,v=f-b,u=(m*v-I)/n.get(x+1,x)+n.get(x,x+1),g=n.get(x+1,x+1)-b-m-v,m=n.get(x+2,x+1),v=Math.abs(u)+Math.abs(g)+Math.abs(m),u=u/v,g=g/v,m=m/v,!(x===p||Math.abs(n.get(x,x-1))*(Math.abs(g)+Math.abs(m))<c*(Math.abs(u)*(Math.abs(n.get(x-1,x-1))+Math.abs(b)+Math.abs(n.get(x+1,x+1))))));)x--;for(_=x+2;_<=o;_++)n.set(_,_-2,0),_>x+2&&n.set(_,_-3,0);for(d=x;d<=o-1&&(Y=d!==o-1,d!==x&&(u=n.get(d,d-1),g=n.get(d+1,d-1),m=Y?n.get(d+2,d-1):0,T=Math.abs(u)+Math.abs(g)+Math.abs(m),T!==0&&(u=u/T,g=g/T,m=m/T)),T!==0);d++)if(v=Math.sqrt(u*u+g*g+m*m),u<0&&(v=-v),v!==0){for(d!==x?n.set(d,d-1,-v*T):p!==x&&n.set(d,d-1,-n.get(d,d-1)),u=u+v,T=u/v,f=g/v,b=m/v,g=g/u,m=m/u,S=d;S<r;S++)u=n.get(d,S)+g*n.get(d+1,S),Y&&(u=u+m*n.get(d+2,S),n.set(d+2,S,n.get(d+2,S)-u*b)),n.set(d,S,n.get(d,S)-u*T),n.set(d+1,S,n.get(d+1,S)-u*f);for(_=0;_<=Math.min(o,d+3);_++)u=T*n.get(_,d)+f*n.get(_,d+1),Y&&(u=u+b*n.get(_,d+2),n.set(_,d+2,n.get(_,d+2)-u*m)),n.set(_,d,n.get(_,d)-u),n.set(_,d+1,n.get(_,d+1)-u*g);for(_=s;_<=a;_++)u=T*i.get(_,d)+f*i.get(_,d+1),Y&&(u=u+b*i.get(_,d+2),i.set(_,d+2,i.get(_,d+2)-u*m)),i.set(_,d,i.get(_,d)-u),i.set(_,d+1,i.get(_,d+1)-u*g)}}}if(h!==0){for(o=r-1;o>=0;o--)if(u=t[o],g=e[o],g===0)for(p=o,n.set(o,o,1),_=o-1;_>=0;_--){for(I=n.get(_,_)-u,m=0,S=p;S<=o;S++)m=m+n.get(_,S)*n.get(S,o);if(e[_]<0)b=I,v=m;else if(p=_,e[_]===0?n.set(_,o,I!==0?-m/I:-m/(c*h)):(T=n.get(_,_+1),f=n.get(_+1,_),g=(t[_]-u)*(t[_]-u)+e[_]*e[_],R=(T*v-b*m)/g,n.set(_,o,R),n.set(_+1,o,Math.abs(T)>Math.abs(b)?(-m-I*R)/T:(-v-f*R)/b)),R=Math.abs(n.get(_,o)),c*R*R>1)for(S=_;S<=o;S++)n.set(S,o,n.get(S,o)/R)}else if(g<0)for(p=o-1,Math.abs(n.get(o,o-1))>Math.abs(n.get(o-1,o))?(n.set(o-1,o-1,g/n.get(o,o-1)),n.set(o-1,o,-(n.get(o,o)-u)/n.get(o,o-1))):(X=Kr(0,-n.get(o-1,o),n.get(o-1,o-1)-u,g),n.set(o-1,o-1,X[0]),n.set(o-1,o,X[1])),n.set(o,o-1,0),n.set(o,o,1),_=o-2;_>=0;_--){for(w=0,P=0,S=p;S<=o;S++)w=w+n.get(_,S)*n.get(S,o-1),P=P+n.get(_,S)*n.get(S,o);if(I=n.get(_,_)-u,e[_]<0)b=I,m=w,v=P;else if(p=_,e[_]===0?(X=Kr(-w,-P,I,g),n.set(_,o-1,X[0]),n.set(_,o,X[1])):(T=n.get(_,_+1),f=n.get(_+1,_),M=(t[_]-u)*(t[_]-u)+e[_]*e[_]-g*g,$=(t[_]-u)*2*g,M===0&&$===0&&(M=c*h*(Math.abs(I)+Math.abs(g)+Math.abs(T)+Math.abs(f)+Math.abs(b))),X=Kr(T*m-b*w+g*P,T*v-b*P-g*w,M,$),n.set(_,o-1,X[0]),n.set(_,o,X[1]),Math.abs(T)>Math.abs(b)+Math.abs(g)?(n.set(_+1,o-1,(-w-I*n.get(_,o-1)+g*n.get(_,o))/T),n.set(_+1,o,(-P-I*n.get(_,o)-g*n.get(_,o-1))/T)):(X=Kr(-m-f*n.get(_,o-1),-v-f*n.get(_,o),b,g),n.set(_+1,o-1,X[0]),n.set(_+1,o,X[1]))),R=Math.max(Math.abs(n.get(_,o-1)),Math.abs(n.get(_,o))),c*R*R>1)for(S=_;S<=o;S++)n.set(S,o-1,n.get(S,o-1)/R),n.set(S,o,n.get(S,o)/R)}for(_=0;_<r;_++)if(_<s||_>a)for(S=_;S<r;S++)i.set(_,S,n.get(_,S));for(S=r-1;S>=s;S--)for(_=s;_<=a;_++){for(b=0,d=s;d<=Math.min(S,a);d++)b=b+i.get(_,d)*n.get(d,S);i.set(_,S,b)}}}function Kr(r,e,t,i){let n,o;return Math.abs(t)>Math.abs(i)?(n=i/t,o=t+n*i,[(r+n*e)/o,(e-n*r)/o]):(n=t/i,o=i+n*t,[(n*r+e)/o,(n*e-r)/o])}class Xo{constructor(e){if(e=Te.checkMatrix(e),!e.isSymmetric())throw new Error("Matrix is not symmetric");let t=e,i=t.rows,n=new k(i,i),o=!0,s,a,c;for(a=0;a<i;a++){let l=0;for(c=0;c<a;c++){let h=0;for(s=0;s<c;s++)h+=n.get(c,s)*n.get(a,s);h=(t.get(a,c)-h)/n.get(c,c),n.set(a,c,h),l=l+h*h}for(l=t.get(a,a)-l,o&=l>0,n.set(a,a,Math.sqrt(Math.max(l,0))),c=a+1;c<i;c++)n.set(a,c,0)}this.L=n,this.positiveDefinite=!!o}isPositiveDefinite(){return this.positiveDefinite}solve(e){e=Te.checkMatrix(e);let t=this.L,i=t.rows;if(e.rows!==i)throw new Error("Matrix dimensions do not match");if(this.isPositiveDefinite()===!1)throw new Error("Matrix is not positive definite");let n=e.columns,o=e.clone(),s,a,c;for(c=0;c<i;c++)for(a=0;a<n;a++){for(s=0;s<c;s++)o.set(c,a,o.get(c,a)-o.get(s,a)*t.get(c,s));o.set(c,a,o.get(c,a)/t.get(c,c))}for(c=i-1;c>=0;c--)for(a=0;a<n;a++){for(s=c+1;s<i;s++)o.set(c,a,o.get(c,a)-o.get(s,a)*t.get(s,c));o.set(c,a,o.get(c,a)/t.get(c,c))}return o}get lowerTriangularMatrix(){return this.L}}class Ho{constructor(e,t={}){e=Te.checkMatrix(e);let{Y:i}=t;const{scaleScores:n=!1,maxIterations:o=1e3,terminationCriteria:s=1e-10}=t;let a;if(i){if(xe.isAnyArray(i)&&typeof i[0]=="number"?i=k.columnVector(i):i=Te.checkMatrix(i),i.rows!==e.rows)throw new Error("Y should have the same number of rows as X");a=i.getColumnVector(0)}else a=e.getColumnVector(0);let c=1,l,h,u,g;for(let m=0;m<o&&c>s;m++)u=e.transpose().mmul(a).div(a.transpose().mmul(a).get(0,0)),u=u.div(u.norm()),l=e.mmul(u).div(u.transpose().mmul(u).get(0,0)),m>0&&(c=l.clone().sub(g).pow(2).sum()),g=l.clone(),i?(h=i.transpose().mmul(l).div(l.transpose().mmul(l).get(0,0)),h=h.div(h.norm()),a=i.mmul(h).div(h.transpose().mmul(h).get(0,0))):a=l;if(i){let m=e.transpose().mmul(l).div(l.transpose().mmul(l).get(0,0));m=m.div(m.norm());let v=e.clone().sub(l.clone().mmul(m.transpose())),b=a.transpose().mmul(l).div(l.transpose().mmul(l).get(0,0)),E=i.clone().sub(l.clone().mulS(b.get(0,0)).mmul(h.transpose()));this.t=l,this.p=m.transpose(),this.w=u.transpose(),this.q=h,this.u=a,this.s=l.transpose().mmul(l),this.xResidual=v,this.yResidual=E,this.betas=b}else this.w=u.transpose(),this.s=l.transpose().mmul(l).sqrt(),n?this.t=l.clone().div(this.s.get(0,0)):this.t=l,this.xResidual=e.sub(l.mmul(u.transpose()))}}Z.AbstractMatrix=re,Z.CHO=Xo,Z.CholeskyDecomposition=Xo,Z.DistanceMatrix=qr,Z.EVD=qo,Z.EigenvalueDecomposition=qo,Z.LU=Hr,Z.LuDecomposition=Hr;var Kh=Z.Matrix=k;Z.MatrixColumnSelectionView=Lh,Z.MatrixColumnView=Ch,Z.MatrixFlipColumnView=kh,Z.MatrixFlipRowView=jh,Z.MatrixRowSelectionView=Fh,Z.MatrixRowView=Oh,Z.MatrixSelectionView=Xr,Z.MatrixSubView=Dh,Z.MatrixTransposeView=Gh,Z.NIPALS=Ho,Z.Nipals=Ho,Z.QR=$i,Z.QrDecomposition=$i,Z.SVD=It;var Jh=Z.SingularValueDecomposition=It;Z.SymmetricMatrix=lt,Z.WrapperMatrix1D=$o,Z.WrapperMatrix2D=Te,Z.correlation=Zh,Z.covariance=$h;var Yo=Z.default=k;Z.determinant=Yr;var Qh=Z.inverse=Bh;Z.linearDependencies=Vh;var eu=Z.pseudoInverse=Wh;Z.solve=Zo,Z.wrap=Nh;const Se=Kh,tu=Jh;Yo.Matrix&&Yo.Matrix;const ru=Qh,Ko=eu;class ar{sourcePoints;destinationPoints;pointCount;pointCountMinimum;type;constructor(e,t,i,n){if(this.sourcePoints=e,this.destinationPoints=t,this.pointCount=this.sourcePoints.length,this.type=i,this.pointCountMinimum=n,this.pointCount<this.pointCountMinimum)throw new Error("Not enough control points. A "+this.type+" transformation requires a minimum of "+this.pointCountMinimum+" points, but "+this.pointCount+" are given.")}evaluate(e,t="function"){if(t=="function")return this.evaluateFunction(e);if(t=="partialDerivativeX")return this.evaluatePartialDerivativeX(e);if(t=="partialDerivativeY")return this.evaluatePartialDerivativeY(e);throw new Error("Evaluation of type "+t+" not supported")}}class Jo extends ar{helmertParametersMatrix;helmertParameters;scale;rotation;translation;constructor(e,t){super(e,t,"helmert",2);const i=Se.columnVector(t.flat()),n=Se.zeros(2*this.pointCount,4);for(let s=0;s<this.pointCount;s++)n.set(2*s,0,1),n.set(2*s,1,0),n.set(2*s,2,this.sourcePoints[s][0]),n.set(2*s,3,-this.sourcePoints[s][1]),n.set(2*s+1,0,0),n.set(2*s+1,1,1),n.set(2*s+1,2,this.sourcePoints[s][1]),n.set(2*s+1,3,this.sourcePoints[s][0]);const o=Ko(n);this.helmertParametersMatrix=o.mmul(i),this.helmertParameters=this.helmertParametersMatrix.to1DArray(),this.scale=Math.sqrt(this.helmertParameters[2]**2+this.helmertParameters[3]**2),this.rotation=Math.atan2(this.helmertParameters[3],this.helmertParameters[2]),this.translation=[this.helmertParameters[0],this.helmertParameters[1]]}evaluateFunction(e){if(!this.helmertParameters)throw new Error("Helmert parameters not computed");return[this.helmertParameters[0]+this.helmertParameters[2]*e[0]-this.helmertParameters[3]*e[1],this.helmertParameters[1]+this.helmertParameters[2]*e[1]+this.helmertParameters[3]*e[0]]}evaluatePartialDerivativeX(e){if(!this.helmertParameters)throw new Error("Helmert parameters not computed");return[this.helmertParameters[2],this.helmertParameters[3]]}evaluatePartialDerivativeY(e){if(!this.helmertParameters)throw new Error("Helmert parameters not computed");return[-this.helmertParameters[3],this.helmertParameters[2]]}}class iu extends ar{scale;sourcePointsCenter;destinationPointsCenter;translation;constructor(e,t){super(e,t,"straight",2);const i=new Jo(this.sourcePoints,this.destinationPoints);if(this.scale=i.scale,!this.scale)throw new Error("Scale could not be computed");this.sourcePointsCenter=this.sourcePoints.reduce((o,s)=>[o[0]+s[0],o[1]+s[1]]).map(o=>o/this.pointCount),this.destinationPointsCenter=this.destinationPoints.reduce((o,s)=>[o[0]+s[0],o[1]+s[1]]).map(o=>o/this.pointCount);const n=this.scale;this.translation=this.destinationPointsCenter.map((o,s)=>o-this.sourcePointsCenter[s]*n)}evaluateFunction(e){if(!this.scale||!this.translation)throw new Error("Straight parameters not computed");return[this.translation[0]+this.scale*e[0],this.translation[1]+this.scale*e[1]]}evaluatePartialDerivativeX(e){if(!this.scale||!this.translation)throw new Error("Straight parameters not computed");return[this.scale,0]}evaluatePartialDerivativeY(e){if(!this.scale||!this.translation)throw new Error("Straight parameters not computed");return[0,this.scale]}}class Zi extends ar{polynomialParametersMatrices;polynomialParameters;order;pointCountMinimum;constructor(e,t,i){i=i||1;const n=(i+1)*(i+2)/2;if(super(e,t,"polynomial"+i,n),this.order=i,this.pointCountMinimum=n,this.order<1||this.order>3)throw new Error("Only polynomial transformations of order 1, 2 or 3 are supported");const o=[Se.columnVector(this.destinationPoints.map(c=>c[0])),Se.columnVector(this.destinationPoints.map(c=>c[1]))],s=Se.zeros(this.pointCount,this.pointCountMinimum);for(let c=0;c<this.pointCount;c++)switch(this.order){case 1:s.set(c,0,1),s.set(c,1,this.sourcePoints[c][0]),s.set(c,2,this.sourcePoints[c][1]);break;case 2:s.set(c,0,1),s.set(c,1,this.sourcePoints[c][0]),s.set(c,2,this.sourcePoints[c][1]),s.set(c,3,this.sourcePoints[c][0]**2),s.set(c,4,this.sourcePoints[c][1]**2),s.set(c,5,this.sourcePoints[c][0]*this.sourcePoints[c][1]);break;case 3:s.set(c,0,1),s.set(c,1,this.sourcePoints[c][0]),s.set(c,2,this.sourcePoints[c][1]),s.set(c,3,this.sourcePoints[c][0]**2),s.set(c,4,this.sourcePoints[c][1]**2),s.set(c,5,this.sourcePoints[c][0]*this.sourcePoints[c][1]),s.set(c,6,this.sourcePoints[c][0]**3),s.set(c,7,this.sourcePoints[c][1]**3),s.set(c,8,this.sourcePoints[c][0]**2*this.sourcePoints[c][1]),s.set(c,9,this.sourcePoints[c][0]*this.sourcePoints[c][1]**2);break}const a=Ko(s);this.polynomialParametersMatrices=[a.mmul(o[0]),a.mmul(o[1])],this.polynomialParameters=this.polynomialParametersMatrices.map(c=>c.to1DArray())}evaluateFunction(e){if(!this.polynomialParameters)throw new Error("Polynomial parameters not computed");const t=[0,0];for(let i=0;i<2;i++)switch(this.order){case 1:t[i]+=this.polynomialParameters[i][0]+this.polynomialParameters[i][1]*e[0]+this.polynomialParameters[i][2]*e[1];break;case 2:t[i]+=this.polynomialParameters[i][0]+this.polynomialParameters[i][1]*e[0]+this.polynomialParameters[i][2]*e[1]+this.polynomialParameters[i][3]*e[0]**2+this.polynomialParameters[i][4]*e[1]**2+this.polynomialParameters[i][5]*e[0]*e[1];break;case 3:t[i]+=this.polynomialParameters[i][0]+this.polynomialParameters[i][1]*e[0]+this.polynomialParameters[i][2]*e[1]+this.polynomialParameters[i][3]*e[0]**2+this.polynomialParameters[i][4]*e[1]**2+this.polynomialParameters[i][5]*e[0]*e[1]+this.polynomialParameters[i][6]*e[0]**3+this.polynomialParameters[i][7]*e[1]**3+this.polynomialParameters[i][8]*e[0]**2*e[1]+this.polynomialParameters[i][9]*e[0]*e[1]**2;break}return t}evaluatePartialDerivativeX(e){if(!this.polynomialParameters)throw new Error("Polynomial parameters not computed");const t=[0,0];for(let i=0;i<2;i++)switch(this.order){case 1:t[i]+=this.polynomialParameters[i][1];break;case 2:t[i]+=this.polynomialParameters[i][1]+2*this.polynomialParameters[i][3]*e[0]+this.polynomialParameters[i][5]*e[1];break;case 3:t[i]+=this.polynomialParameters[i][1]+2*this.polynomialParameters[i][3]*e[0]+this.polynomialParameters[i][5]*e[1]+3*this.polynomialParameters[i][6]*e[0]**2+2*this.polynomialParameters[i][8]*e[0]*e[1]+this.polynomialParameters[i][9]*e[1]**2;break}return t}evaluatePartialDerivativeY(e){if(!this.polynomialParameters)throw new Error("Polynomial parameters not computed");const t=[0,0];for(let i=0;i<2;i++)switch(this.order){case 1:t[i]+=this.polynomialParameters[i][2];break;case 2:t[i]+=this.polynomialParameters[i][2]+2*this.polynomialParameters[i][4]*e[1]+this.polynomialParameters[i][5]*e[0];break;case 3:t[i]+=this.polynomialParameters[i][2]+2*this.polynomialParameters[i][4]*e[1]+this.polynomialParameters[i][5]*e[0]+3*this.polynomialParameters[i][7]*e[1]**2+this.polynomialParameters[i][8]*e[0]**2+2*this.polynomialParameters[i][9]*e[0]*e[1];break}return t}}class nu extends ar{projectiveParametersMatrix;projectiveParameters;constructor(e,t){super(e,t,"projective",4);const i=Se.zeros(2*this.pointCount,9);for(let o=0;o<this.pointCount;o++)i.set(2*o,0,-e[o][0]),i.set(2*o,1,-e[o][1]),i.set(2*o,2,-1),i.set(2*o,3,0),i.set(2*o,4,0),i.set(2*o,5,0),i.set(2*o,6,t[o][0]*e[o][0]),i.set(2*o,7,t[o][0]*e[o][1]),i.set(2*o,8,t[o][0]),i.set(2*o+1,0,0),i.set(2*o+1,1,0),i.set(2*o+1,2,0),i.set(2*o+1,3,-e[o][0]),i.set(2*o+1,4,-e[o][1]),i.set(2*o+1,5,-1),i.set(2*o+1,6,t[o][1]*e[o][0]),i.set(2*o+1,7,t[o][1]*e[o][1]),i.set(2*o+1,8,t[o][1]);const n=new tu(i);this.projectiveParametersMatrix=Se.from1DArray(3,3,n.rightSingularVectors.getColumn(8)).transpose(),this.projectiveParameters=this.projectiveParametersMatrix.to2DArray()}evaluateFunction(e){if(!this.projectiveParameters)throw new Error("projective parameters not computed");const t=this.projectiveParameters[0][2]*e[0]+this.projectiveParameters[1][2]*e[1]+this.projectiveParameters[2][2],i=this.projectiveParameters[0][0]*e[0]+this.projectiveParameters[1][0]*e[1]+this.projectiveParameters[2][0],n=this.projectiveParameters[0][1]*e[0]+this.projectiveParameters[1][1]*e[1]+this.projectiveParameters[2][1];return[i/t,n/t]}evaluatePartialDerivativeX(e){if(!this.projectiveParameters)throw new Error("projective parameters not computed");const t=this.projectiveParameters[0][2]*e[0]+this.projectiveParameters[1][2]*e[1]+this.projectiveParameters[2][2],i=this.projectiveParameters[0][0]*e[0]+this.projectiveParameters[1][0]*e[1]+this.projectiveParameters[2][0],n=this.projectiveParameters[0][1]*e[0]+this.projectiveParameters[1][1]*e[1]+this.projectiveParameters[2][1];return[(t*this.projectiveParameters[0][0]-this.projectiveParameters[0][2]*i)/t**2,(t*this.projectiveParameters[0][1]-this.projectiveParameters[0][2]*n)/t**2]}evaluatePartialDerivativeY(e){if(!this.projectiveParameters)throw new Error("projective parameters not computed");const t=this.projectiveParameters[0][2]*e[0]+this.projectiveParameters[1][2]*e[1]+this.projectiveParameters[2][2],i=this.projectiveParameters[0][0]*e[0]+this.projectiveParameters[1][0]*e[1]+this.projectiveParameters[2][0],n=this.projectiveParameters[0][1]*e[0]+this.projectiveParameters[1][1]*e[1]+this.projectiveParameters[2][1];return[(t*this.projectiveParameters[1][0]-this.projectiveParameters[1][2]*i)/t**2,(t*this.projectiveParameters[1][1]-this.projectiveParameters[1][2]*n)/t**2]}}class ou extends ar{kernelFunction;normFunction;weightsMatrices;rbfWeights;affineWeights;epsilon;constructor(e,t,i,n,o){super(e,t,"thinPlateSpline",3),this.kernelFunction=i,this.normFunction=n;const s=[Se.columnVector([...this.destinationPoints,[0,0],[0,0],[0,0]].map(u=>u[0])),Se.columnVector([...this.destinationPoints,[0,0],[0,0],[0,0]].map(u=>u[1]))],a=Se.zeros(this.pointCount,this.pointCount);for(let u=0;u<this.pointCount;u++)for(let g=0;g<this.pointCount;g++)a.set(u,g,n(this.sourcePoints[u],this.sourcePoints[g]));o===void 0&&(o=a.sum()/(Math.pow(this.pointCount,2)-this.pointCount)),this.epsilon=o;for(let u=0;u<this.pointCount;u++)for(let g=0;g<this.pointCount;g++)a.set(u,g,i(a.get(u,g),{epsilon:o}));const c=Se.zeros(this.pointCount,3),l=Se.zeros(this.pointCount+3,this.pointCount+3);for(let u=0;u<this.pointCount;u++)c.set(u,0,1),c.set(u,1,this.sourcePoints[u][0]),c.set(u,2,this.sourcePoints[u][1]);for(let u=0;u<this.pointCount+3;u++)for(let g=0;g<this.pointCount+3;g++)u<this.pointCount&&g<this.pointCount?l.set(u,g,a.get(u,g)):u>=this.pointCount&&g<this.pointCount?l.set(u,g,c.transpose().get(u-this.pointCount,g)):u<this.pointCount&&g>=this.pointCount&&l.set(u,g,c.get(u,g-this.pointCount));const h=ru(l);this.weightsMatrices=[h.mmul(s[0]),h.mmul(s[1])],this.rbfWeights=this.weightsMatrices.map(u=>u.selection([...Array(this.pointCount).keys()],[0]).to1DArray()),this.affineWeights=this.weightsMatrices.map(u=>u.selection([0,1,2].map(g=>g+this.pointCount),[0]).to1DArray())}evaluateFunction(e){if(!this.rbfWeights||!this.affineWeights)throw new Error("Weights not computed");const t=this.sourcePoints.map(n=>this.normFunction(e,n)),i=[0,0];for(let n=0;n<2;n++)i[n]=t.reduce((o,s,a)=>o+this.kernelFunction(s,{epsilon:this.epsilon})*this.rbfWeights[n][a],0),i[n]+=this.affineWeights[n][0]+this.affineWeights[n][1]*e[0]+this.affineWeights[n][2]*e[1];return i}evaluatePartialDerivativeX(e){if(!this.rbfWeights||!this.affineWeights)throw new Error("Weights not computed");const t=this.sourcePoints.map(n=>this.normFunction(e,n)),i=[0,0];for(let n=0;n<2;n++)i[n]=t.reduce((o,s,a)=>o+(s==0?0:this.kernelFunction(s,{derivative:1,epsilon:this.epsilon})*((e[0]-this.sourcePoints[a][0])/s)*this.rbfWeights[n][a]),0),i[n]+=this.affineWeights[n][1];return i}evaluatePartialDerivativeY(e){if(!this.rbfWeights||!this.affineWeights)throw new Error("Weights not computed");const t=this.sourcePoints.map(n=>this.normFunction(e,n)),i=[0,0];for(let n=0;n<2;n++)i[n]=t.reduce((o,s,a)=>o+(s==0?0:this.kernelFunction(s,{derivative:1,epsilon:this.epsilon})*((e[1]-this.sourcePoints[a][1])/s)*this.rbfWeights[n][a]),0),i[n]+=this.affineWeights[n][2];return i}}function su(r,e){if(e.derivative){if(e.derivative==1)return r===0?0:r+2*r*Math.log(r);throw new Error("Derivate of order "+e.derivative+" not implemented")}else return r===0?0:Math.pow(r,2)*Math.log(r)}function au(r,e){const t=[e[0]-r[0],e[1]-r[1]];return Math.sqrt(t[0]**2+t[1]**2)}const Qo={maxOffsetRatio:0,maxDepth:0,minOffsetDistance:1/0,minLineDistance:1/0,sourceMidPointFunction:Fn,destinationMidPointFunction:Fn,destinationDistanceFunction:Ve,returnDomain:"destination"};function es(r,e,t){r=xi(r);const i=ee(Qo,t),n=r.map(s=>({source:s,destination:e(s)})),o=rs(n,!1).map(s=>Jr(s,e,i,0)).flat(1);return is(o,!0).map(s=>i.returnDomain=="destination"?s.destination:s.source)}function ts(r,e,t){r=Ln(r);const i=ee(Qo,t),n=r.map(s=>({source:s,destination:e(s)})),o=rs(n,!0).map(s=>Jr(s,e,i,0)).flat(1);return is(o,!1).map(s=>i.returnDomain=="destination"?s.destination:s.source)}function Jr(r,e,t,i){if(i>=t.maxDepth||t.maxDepth<=0)return[r];const n=t.sourceMidPointFunction(r[0].source,r[1].source),o=t.destinationMidPointFunction(r[0].destination,r[1].destination),s=e(n),a=t.destinationDistanceFunction(r[0].destination,r[1].destination),c=t.destinationDistanceFunction(e(r[0].source),e(r[1].source)),l=t.destinationDistanceFunction(o,s);if(l/a>t.maxOffsetRatio&&l<t.minOffsetDistance&&c<t.minLineDistance){const h={source:n,destination:s};return[Jr([r[0],h],e,t,i+1),Jr([h,r[1]],e,t,i+1)].flat(1)}else return[r]}function rs(r,e=!1){const t=r.length-(e?0:1),i=[];for(let n=0;n<t;n++)i.push([r[n],r[(n+1)%r.length]]);return i}function is(r,e=!1){const t=r.map(i=>i[0]);return e&&t.push(r[r.length-1][1]),t}const cu={maxOffsetRatio:0,minOffsetDistance:1/0,minLineDistance:1/0,maxDepth:0,destinationIsGeographic:!1,sourceIsGeographic:!1,inputIsMultiGeometry:!1,differentHandedness:!1,evaluationType:"function",returnDomain:"normal"};function ns(r){const e={maxOffsetRatio:r.maxOffsetRatio,minOffsetDistance:r.minOffsetDistance,minLineDistance:r.minLineDistance,maxDepth:r.maxDepth};return r.sourceIsGeographic&&(e.sourceMidPointFunction=(t,i)=>Vr(t,i).geometry.coordinates),r.destinationIsGeographic&&(e.destinationMidPointFunction=(t,i)=>Vr(t,i).geometry.coordinates,e.destinationDistanceFunction=zi),r.returnDomain=="inverse"&&(e.returnDomain="source"),e}function os(r){const e={maxOffsetRatio:r.maxOffsetRatio,minOffsetDistance:r.minOffsetDistance,minLineDistance:r.minLineDistance,maxDepth:r.maxDepth};return r.destinationIsGeographic&&(e.sourceMidPointFunction=(t,i)=>Vr(t,i).geometry.coordinates),r.sourceIsGeographic&&(e.destinationMidPointFunction=(t,i)=>Vr(t,i).geometry.coordinates,e.destinationDistanceFunction=zi),r.returnDomain=="inverse"&&(e.returnDomain="source"),e}function Qr(r,e,t){return es(r,i=>e.transformForward(i),ns(t))}function ei(r,e,t){return es(r,i=>e.transformBackward(i),os(t))}function lu(r,e,t){return ts(r,i=>e.transformForward(i),ns(t))}function hu(r,e,t){return ts(r,i=>e.transformBackward(i),os(t))}function ti(r,e,t){return r.map(i=>lu(i,e,t))}function ri(r,e,t){return r.map(i=>hu(i,e,t))}class qi{gcps;sourcePoints;destinationPoints;type;options;forwardTransformation;backwardTransformation;constructor(e,t="polynomial",i){if(this.options=ee(cu,i),e.length===0)throw new Error("No control points");this.gcps=e.map(n=>{if("resource"in n&&"geo"in n)return{source:n.resource,destination:n.geo};if("source"in n&&"destination"in n)return n;throw new Error("Unsupported GCP type")}),this.sourcePoints=this.gcps.map(n=>n.source),this.destinationPoints=this.gcps.map(n=>n.destination),this.type=t}createForwardTransformation(){this.forwardTransformation=this.computeTransformation(this.sourcePoints.map(e=>this.assureEqualHandedness(e)),this.destinationPoints)}createBackwardTransformation(){this.backwardTransformation=this.computeTransformation(this.destinationPoints,this.sourcePoints.map(e=>this.assureEqualHandedness(e)))}transformForward(e,t){const i=ee(this.options,t);if(!i.inputIsMultiGeometry){if(ce(e))return this.forwardTransformation||this.createForwardTransformation(),this.forwardTransformation.evaluate(this.assureEqualHandedness(e),i.evaluationType);if(We(e))return this.transformForward(Gt(e),i);if(Me(e))return Qr(e,this,i);if($e(e))return Qr(Nt(e),this,ee(i,{sourceIsGeographic:!0}));if(Ie(e))return ti(e,this,i);if(Ze(e))return ti(Bt(e),this,ee(i,{sourceIsGeographic:!0}))}if(t&&(t.inputIsMultiGeometry=!1),Be(e))return e.map(n=>this.transformForward(n,t));if(qe(e))return xr(e).map(n=>this.transformForward(n,t));if(ze(e))return e.map(n=>this.transformForward(n,t));if(Xe(e))return br(e).map(n=>this.transformForward(n,t));if(Ue(e))return e.map(n=>this.transformForward(n,t));if(He(e))return Tr(e).map(n=>this.transformForward(n,t));throw new Error("Input type not supported")}transformForwardAsGeojson(e,t){const i=ee(this.options,t);if(!i.inputIsMultiGeometry){if(ce(e))return yr(this.transformForward(e));if(We(e))return yr(this.transformForward(Gt(e)));if(Me(e))return wr(Qr(e,this,ee(i,{destinationIsGeographic:!0})));if($e(e))return wr(Qr(Nt(e),this,ee(i,{sourceIsGeographic:!0,destinationIsGeographic:!0})));if(Ie(e))return _r(ti(e,this,ee(i,{destinationIsGeographic:!0})));if(Ze(e))return _r(ti(Bt(e),this,ee(i,{sourceIsGeographic:!0,destinationIsGeographic:!0})))}if(t&&(t.inputIsMultiGeometry=!1),Be(e))return Mr(e.map(n=>this.transformForwardAsGeojson(n,t)));if(qe(e))return Mr(xr(e).map(n=>this.transformForwardAsGeojson(n,t)));if(ze(e))return Pr(e.map(n=>this.transformForwardAsGeojson(n,t)));if(Xe(e))return Pr(br(e).map(n=>this.transformForwardAsGeojson(n,t)));if(Ue(e))return Er(e.map(n=>this.transformForwardAsGeojson(n,t)));if(He(e))return Er(Tr(e).map(n=>this.transformForwardAsGeojson(n,t)));throw new Error("Input type not supported")}transformBackward(e,t){const i=ee(this.options,t);if(!i.inputIsMultiGeometry){if(ce(e))return this.backwardTransformation||this.createBackwardTransformation(),this.assureEqualHandedness(this.backwardTransformation.evaluate(e));if(We(e))return this.transformBackward(Gt(e));if(Me(e))return ei(e,this,i);if($e(e))return ei(Nt(e),this,ee(i,{destinationIsGeographic:!0}));if(Ie(e))return ri(e,this,i);if(Ze(e))return ri(Bt(e),this,ee(i,{destinationIsGeographic:!0}))}if(t&&(t.inputIsMultiGeometry=!1),Be(e))return e.map(n=>this.transformBackward(n,t));if(qe(e))return xr(e).map(n=>this.transformBackward(n,t));if(ze(e))return e.map(n=>this.transformBackward(n,t));if(Xe(e))return br(e).map(n=>this.transformBackward(n,t));if(Ue(e))return e.map(n=>this.transformBackward(n,t));if(He(e))return Tr(e).map(n=>this.transformBackward(n,t));throw new Error("Input type not supported")}transformBackwardAsGeojson(e,t){const i=ee(this.options,t);if(!i.inputIsMultiGeometry){if(ce(e))return yr(this.transformBackward(e));if(We(e))return yr(this.transformBackward(Gt(e)));if(Me(e))return wr(ei(e,this,ee(i,{sourceIsGeographic:!0})));if($e(e))return wr(ei(Nt(e),this,ee(i,{sourceIsGeographic:!0,destinationIsGeographic:!0})));if(Ie(e))return _r(ri(e,this,ee(i,{sourceIsGeographic:!0})));if(Ze(e))return _r(ri(Bt(e),this,ee(i,{sourceIsGeographic:!0,destinationIsGeographic:!0})))}if(t&&(t.inputIsMultiGeometry=!1),Be(e))return Mr(e.map(n=>this.transformBackwardAsGeojson(n,t)));if(qe(e))return Mr(xr(e).map(n=>this.transformBackwardAsGeojson(n,t)));if(ze(e))return Pr(e.map(n=>this.transformBackwardAsGeojson(n,t)));if(Xe(e))return Pr(br(e).map(n=>this.transformBackwardAsGeojson(n,t)));if(Ue(e))return Er(e.map(n=>this.transformBackwardAsGeojson(n,t)));if(He(e))return Er(Tr(e).map(n=>this.transformBackwardAsGeojson(n,t)));throw new Error("Input type not supported")}transformToGeo(e,t){if(!ee(this.options,t).inputIsMultiGeometry){if(ce(e))return this.transformForward(e,t);if(We(e))return this.transformForward(e,t);if(Me(e))return this.transformForward(e,t);if($e(e))return this.transformForward(e,t);if(Ie(e))return this.transformForward(e,t);if(Ze(e))return this.transformForward(e,t)}if(t&&(t.inputIsMultiGeometry=!1),Be(e))return this.transformForward(e,t);if(qe(e))return this.transformForward(e,t);if(ze(e))return this.transformForward(e,t);if(Xe(e))return this.transformForward(e,t);if(Ue(e))return this.transformForward(e,t);if(He(e))return this.transformForward(e,t);throw new Error("Input type not supported")}transformToGeoAsGeojson(e,t){if(!ee(this.options,t).inputIsMultiGeometry){if(ce(e))return this.transformForwardAsGeojson(e,t);if(We(e))return this.transformForwardAsGeojson(e,t);if(Me(e))return this.transformForwardAsGeojson(e,t);if($e(e))return this.transformForwardAsGeojson(e,t);if(Ie(e))return this.transformForwardAsGeojson(e,t);if(Ze(e))return this.transformForwardAsGeojson(e,t)}if(t&&(t.inputIsMultiGeometry=!1),Be(e))return this.transformForwardAsGeojson(e,t);if(qe(e))return this.transformForwardAsGeojson(e,t);if(ze(e))return this.transformForwardAsGeojson(e,t);if(Xe(e))return this.transformForwardAsGeojson(e,t);if(Ue(e))return this.transformForwardAsGeojson(e,t);if(He(e))return this.transformForwardAsGeojson(e,t);throw new Error("Input type not supported")}transformToResource(e,t){if(!ee(this.options,t).inputIsMultiGeometry){if(ce(e))return this.transformBackward(e,t);if(We(e))return this.transformBackward(e,t);if(Me(e))return this.transformBackward(e,t);if($e(e))return this.transformBackward(e,t);if(Ie(e))return this.transformBackward(e,t);if(Ze(e))return this.transformBackward(e,t)}if(t&&(t.inputIsMultiGeometry=!1),Be(e))return this.transformBackward(e,t);if(qe(e))return this.transformBackward(e,t);if(ze(e))return this.transformBackward(e,t);if(Xe(e))return this.transformBackward(e,t);if(Ue(e))return this.transformBackward(e,t);if(He(e))return this.transformBackward(e,t);throw new Error("Input type not supported")}transformToResourceAsGeojson(e,t){if(!ee(this.options,t).inputIsMultiGeometry){if(ce(e))return this.transformBackwardAsGeojson(e,t);if(We(e))return this.transformBackwardAsGeojson(e,t);if(Me(e))return this.transformBackwardAsGeojson(e,t);if($e(e))return this.transformBackwardAsGeojson(e,t);if(Ie(e))return this.transformBackwardAsGeojson(e,t);if(Ze(e))return this.transformBackwardAsGeojson(e,t)}if(t&&(t.inputIsMultiGeometry=!1),Be(e))return this.transformBackwardAsGeojson(e,t);if(qe(e))return this.transformBackwardAsGeojson(e,t);if(ze(e))return this.transformBackwardAsGeojson(e,t);if(Xe(e))return this.transformBackwardAsGeojson(e,t);if(Ue(e))return this.transformBackwardAsGeojson(e,t);if(He(e))return this.transformBackwardAsGeojson(e,t);throw new Error("Input type not supported")}transformSvgToGeojson(e,t){if(e.type==="circle")return this.transformForwardAsGeojson(e.coordinates);if(e.type==="line")return this.transformForwardAsGeojson(e.coordinates,t);if(e.type==="polyline")return this.transformForwardAsGeojson(e.coordinates,t);if(e.type==="rect")return this.transformForwardAsGeojson([e.coordinates],t);if(e.type==="polygon")return this.transformForwardAsGeojson([e.coordinates],t);throw new Error("Unsupported SVG geometry")}transformSvgStringToGeojsonFeatureCollection(e,t){const i=[];for(const n of dc(e)){const o=this.transformSvgToGeojson(n,t);i.push(o)}return Ya(i)}transformGeojsonToSvg(e,t){if(e.type==="Point")return{type:"circle",coordinates:this.transformBackward(e)};if(e.type==="LineString")return{type:"polyline",coordinates:this.transformBackward(e,t)};if(e.type==="Polygon")return{type:"polygon",coordinates:this.transformBackward(e,t)[0]};throw new Error("Unsupported GeoJSON geometry")}transformGeojsonFeatureCollectionToSvgString(e,t){const i=[];for(const n of Ja(e)){const o=this.transformGeojsonToSvg(n,t);i.push(o)}return pc(i)}assureEqualHandedness(e){return this.options?.differentHandedness?Ua(e):e}computeTransformation(e,t){if(this.type==="straight")return new iu(e,t);if(this.type==="helmert")return new Jo(e,t);if(this.type==="polynomial1"||this.type==="polynomial")return new Zi(e,t);if(this.type==="polynomial2")return new Zi(e,t,2);if(this.type==="polynomial3")return new Zi(e,t,3);if(this.type==="projective")return new nu(e,t);if(this.type==="thinPlateSpline")return new ou(e,t,su,au);throw new Error(`Unsupported transformation type: ${this.type}`)}}const ss=["log2sigma","twoOmega","airyKavr","signDetJ","thetaa"];function uu(r,e,t,i=1){if(!t)return 0;const n=r[0]**2+r[1]**2,o=e[0]**2+e[1]**2,s=r[0]*e[0]+r[1]*e[1],a=Math.sqrt(.5*(n+o+Math.sqrt((n-o)**2+4*s**2))),c=Math.sqrt(.5*(n+o-Math.sqrt((n-o)**2+4*s**2))),l=Math.atan(r[1]/r[0]),h=Math.sign(-s)*Math.asin(Math.sqrt((1-a**2/n)/(1-(a/c)**2)));switch(ss.indexOf(t)){case 0:return(Math.log(a*c)-2*Math.log(i))/Math.log(2);case 1:return 2*Math.asin((a-c)/(a+c));case 2:return .5*(Math.log(a/i)**2+Math.log(c/i)**2);case 3:return Math.sign(r[0]*e[1]-r[1]*e[0]);case 4:return l-h;default:throw new Error("Distortion "+t+" not supported")}}var C=(r=>(r.GEOREFERENCEANNOTATIONADDED="georeferenceannotationadded",r.GEOREFERENCEANNOTATIONREMOVED="georeferenceannotationremoved",r.WARPEDMAPADDED="warpedmapadded",r.WARPEDMAPREMOVED="warpedmapremoved",r.WARPEDMAPENTER="warpedmapenter",r.WARPEDMAPLEAVE="warpedmapleave",r.IMAGEINFOLOADED="imageinfoloaded",r.TILEFETCHED="tilefetched",r.TILEFETCHERROR="tilefetcherror",r.MAPTILELOADED="maptileloaded",r.MAPTILEREMOVED="maptileremoved",r.FIRSTMAPTILELOADED="firstmaptileloaded",r.ALLREQUESTEDTILESLOADED="allrequestedtilesloaded",r.TEXTURESUPDATED="texturesupdated",r.PRECHANGE="prechange",r.ZINDICESCHANGED="zindiceschanged",r.RESOURCEMASKUPDATED="resourcemaskupdated",r.VISIBILITYCHANGED="visibilitychanged",r.TRANSFORMATIONCHANGED="transformationchanged",r.DISTORTIONCHANGED="distortionchanged",r.CHANGED="changed",r.CLEARED="cleared",r))(C||{});let N=class extends Event{data;constructor(e,t){super(e),this.data=t}};const Xi={maxOffsetRatio:.05,maxDepth:2,differentHandedness:!0},as=!0;function du(){return{visible:as}}let fu=class extends EventTarget{mapId;georeferencedMap;gcps;projectedGcps;projectedGeoPoints;projectedGeoPreviousTransformedResourcePoints;projectedGeoTransformedResourcePoints;resourcePreviousLongerMask;resourcePreviousMask;resourceLongerMask;resourceMask;resourceMaskBbox;resourceMaskRectangle;resourceFullMask;resourceFullMaskBbox;resourceFullMaskRectangle;imageInformations;imageId;parsedImage;loadingImageInfo;fetchFn;abortController;visible;transformationType;transformer;projectedPreviousTransformer;projectedTransformer;transformerByTransformationType=new Map;projectedTransformerByTransformationType=new Map;geoMask;geoMaskBbox;geoMaskRectangle;geoFullMask;geoFullMaskBbox;geoFullMaskRectangle;projectedGeoPreviousLongerMask;projectedGeoLongerMask;projectedGeoMask;projectedGeoMaskBbox;projectedGeoMaskRectangle;projectedGeoFullMask;projectedGeoFullMaskBbox;projectedGeoFullMaskRectangle;resourceToProjectedGeoScale;distortionMeasure;currentBestScaleFactor;currentTileZoomLevel;currentOverviewTileZoomLevel;currentResourceViewportRing=[];currentResourceViewportRingBbox;currentFetchableTiles=[];currentOverviewFetchableTiles=[];constructor(e,t,i){super(),i={...du(),...i},this.mapId=e,this.georeferencedMap=t,this.gcps=this.georeferencedMap.gcps,this.projectedGcps=this.gcps.map(({resource:n,geo:o})=>({resource:n,geo:mc(o)})),this.projectedGeoPoints=this.projectedGcps.map(n=>n.geo),this.resourceMask=this.georeferencedMap.resourceMask,this.updateResourceMaskProperties(),this.resourceFullMask=[[0,0],[this.georeferencedMap.resource.width,0],[this.georeferencedMap.resource.width,this.georeferencedMap.resource.height],[0,this.georeferencedMap.resource.height]],this.resourceFullMaskBbox=fe(this.resourceFullMask),this.resourceFullMaskRectangle=zt(this.resourceFullMaskBbox),this.imageInformations=i.imageInformations,this.loadingImageInfo=!1,this.visible=i.visible||as,this.fetchFn=i.fetchFn,this.transformationType=i.transformation?.type||this.georeferencedMap.transformation?.type||"polynomial",this.updateTransformerProperties()}getViewportMask(e){return this.projectedGeoMask.map(t=>dt(e.projectedGeoToViewportTransform,t))}getViewportMaskBbox(e){return fe(this.getViewportMask(e))}getViewportMaskRectangle(e){return this.projectedGeoMaskRectangle.map(t=>dt(e.projectedGeoToViewportTransform,t))}getViewportFullMask(e){return this.projectedGeoFullMask.map(t=>dt(e.projectedGeoToViewportTransform,t))}getViewportFullMaskBbox(e){return fe(this.getViewportFullMask(e))}getViewportFullMaskRectangle(e){return this.projectedGeoFullMaskRectangle.map(t=>dt(e.projectedGeoToViewportTransform,t))}getResourceToViewportScale(e){return zn(this.resourceMaskRectangle,this.getViewportMaskRectangle(e))}getResourceToCanvasScale(e){return this.getResourceToViewportScale(e)/e.devicePixelRatio}getReferenceScale(){const e=Ar(this.projectedTransformerByTransformationType,"helmert",()=>new qi(this.projectedGcps,"helmert",Xi));return e.forwardTransformation||e.createForwardTransformation(),e.forwardTransformation.scale}setResourceMask(e){this.resourceMask=e,this.updateResourceMaskProperties(),this.updateGeoMask(),this.updateProjectedGeoMask(),this.updateResourceToProjectedGeoScale()}setTransformationType(e){this.transformationType=e,this.updateTransformerProperties()}setDistortionMeasure(e){this.distortionMeasure=e,this.updateDistortionProperties()}setGcps(e){this.gcps=e,this.updateTransformerProperties(!1)}setCurrentBestScaleFactor(e){const t=this.currentBestScaleFactor!=e;return t&&(this.currentBestScaleFactor=e),t}setCurrentTileZoomLevel(e){this.currentTileZoomLevel=e}setCurrentOverviewTileZoomLevel(e){this.currentOverviewTileZoomLevel=e}setCurrentResourceViewportRing(e){this.currentResourceViewportRing=e,this.currentResourceViewportRingBbox=e?fe(e):void 0}setCurrentFetchableTiles(e){this.currentFetchableTiles=e}setCurrentOverviewFetchableTiles(e){this.currentOverviewFetchableTiles=e}resetCurrent(){this.setCurrentTileZoomLevel(),this.setCurrentOverviewTileZoomLevel(),this.setCurrentResourceViewportRing(),this.setCurrentFetchableTiles([]),this.setCurrentOverviewFetchableTiles([])}resetPrevious(){this.projectedPreviousTransformer=this.projectedTransformer,this.projectedGeoPreviousTransformedResourcePoints=this.projectedGeoTransformedResourcePoints,this.resourcePreviousMask=this.resourceMask,this.resourcePreviousLongerMask=this.resourceLongerMask,this.projectedGeoPreviousLongerMask=this.projectedGeoLongerMask}mixPreviousAndNew(e){this.projectedGeoPreviousTransformedResourcePoints=this.projectedGeoTransformedResourcePoints.map((t,i)=>Mi(t,this.projectedGeoPreviousTransformedResourcePoints[i],e)),this.projectedGeoPreviousLongerMask=this.projectedGeoLongerMask.map((t,i)=>Mi(t,this.projectedGeoPreviousLongerMask[i],e))}hasImageInfo(){return this.imageId!==void 0&&this.parsedImage!==void 0}async loadImageInfo(){try{this.loadingImageInfo=!0;const e=this.georeferencedMap.resource.id;let t;if(this.imageInformations?.get(e))t=this.imageInformations.get(e);else{this.abortController=new AbortController;const i=this.abortController.signal;t=await Fa(e,{signal:i},this.fetchFn),this.abortController=void 0,this.imageInformations?.set(e,t)}this.parsedImage=Ni.parse(t),this.imageId=await qn(e),this.dispatchEvent(new N(C.IMAGEINFOLOADED))}catch(e){throw this.loadingImageInfo=!1,e}finally{this.loadingImageInfo=!1}}updateResourceMaskProperties(){this.resourceMaskBbox=fe(this.resourceMask),this.resourceMaskRectangle=zt(this.resourceMaskBbox),this.resourcePreviousMask||(this.resourcePreviousMask=this.resourceMask)}updateTransformerProperties(e=!0){this.updateTransformer(e),this.updateProjectedTransformer(e),this.updateProjectedGeoTransformedResourcePoints(),this.updateGeoMask(),this.updateFullGeoMask(),this.updateProjectedGeoMask(),this.updateProjectedFullGeoMask(),this.updateResourceToProjectedGeoScale()}updateTransformer(e=!0){this.transformer=Ar(this.transformerByTransformationType,this.transformationType,()=>new qi(this.gcps,this.transformationType,Xi),e)}updateProjectedTransformer(e=!0){this.projectedTransformer=Ar(this.projectedTransformerByTransformationType,this.transformationType,()=>new qi(this.projectedGcps,this.transformationType,Xi),e),this.projectedPreviousTransformer||(this.projectedPreviousTransformer=this.projectedTransformer)}updateProjectedGeoTransformedResourcePoints(){this.projectedGeoTransformedResourcePoints=this.gcps.map(e=>this.projectedTransformer.transformForward(e.resource)),this.projectedGeoPreviousTransformedResourcePoints||(this.projectedGeoPreviousTransformedResourcePoints=this.projectedGeoTransformedResourcePoints)}updateGeoMask(){this.geoMask=this.transformer.transformForwardAsGeojson([this.resourceMask]),this.geoMaskBbox=fe(this.geoMask),this.geoMaskRectangle=this.transformer.transformForward([this.resourceMaskRectangle],{maxDepth:0})[0]}updateFullGeoMask(){this.geoFullMask=this.transformer.transformForwardAsGeojson([this.resourceFullMask]),this.geoFullMaskBbox=fe(this.geoFullMask),this.geoFullMaskRectangle=this.transformer.transformForward([this.resourceFullMaskRectangle],{maxDepth:0})[0]}updateProjectedGeoMask(){this.projectedGeoMask=this.projectedTransformer.transformForward([this.resourceMask])[0],this.projectedGeoMaskBbox=fe(this.projectedGeoMask),this.projectedGeoMaskRectangle=this.projectedTransformer.transformForward([this.resourceMaskRectangle],{maxDepth:0})[0],this.resourceLongerMask=this.projectedTransformer.transformForward([this.resourceMask],{returnDomain:"inverse"})[0],this.resourcePreviousLongerMask||(this.resourcePreviousLongerMask=this.resourceLongerMask);const e=this.resourceLongerMask.length<this.resourcePreviousLongerMask.length,t=this.resourceLongerMask.length>this.resourcePreviousLongerMask.length;e&&(this.resourceLongerMask=this.resourcePreviousLongerMask),this.projectedGeoLongerMask=this.projectedTransformer.transformForward(this.resourceLongerMask,{inputIsMultiGeometry:!0}),(!this.projectedGeoPreviousLongerMask||t)&&(this.projectedGeoPreviousLongerMask=this.projectedPreviousTransformer.transformForward(this.resourceLongerMask,{inputIsMultiGeometry:!0}))}updateProjectedFullGeoMask(){this.projectedGeoFullMask=this.projectedTransformer.transformForward([this.resourceFullMask])[0],this.projectedGeoFullMaskBbox=fe(this.projectedGeoFullMask),this.projectedGeoFullMaskRectangle=this.projectedTransformer.transformForward([this.resourceFullMaskRectangle],{maxDepth:0})[0]}updateResourceToProjectedGeoScale(){this.resourceToProjectedGeoScale=zn(this.resourceMaskRectangle,this.projectedGeoMaskRectangle)}updateDistortionProperties(){}destroy(){this.abortController&&this.abortController.abort()}};function pu(r){return Math.sqrt(Math.pow(r[1][0]-r[0][0],2)+Math.pow(r[1][1]-r[0][1],2))}function gu(r){return Math.atan2(r[1][1]-r[0][1],r[1][0]-r[0][0])}function mu(r,e,t){return[r[0]+Math.cos(t)*e,r[1]+Math.sin(t)*e]}function vu(r,e){let t=r[0];const i=[t];for(;pu([t,r[1]])>e;){const n=mu(t,e,gu(r));i.push(n),t=n}return i}function yu(r,e){r=[...r,r[0]];let t=[];for(let i=0;i<r.length-1;i++)t=t.concat(vu([r[i],r[i+1]],e));return t}function wu(r,e){const t=[],i=fe(r);for(let n=i[0]+e,o=0;n<=i[2];o++,n+=e)for(let s=i[1]+e,a=0;s<=i[3];a++,s+=e)t.push([n,s]);return t}function _u(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var cs={exports:{}},ls=xu,hs=+(Math.pow(2,27)+1);function xu(r,e,t){var i=r*e,n=hs*r,o=n-r,s=n-o,a=r-s,c=hs*e,l=c-e,h=c-l,u=e-h,g=i-s*h,m=g-a*h,v=m-s*u,b=a*u-v;return t?(t[0]=b,t[1]=i,t):[b,i]}var bu=Mu;function Tu(r,e){var t=r+e,i=t-r,n=t-i,o=e-i,s=r-n,a=s+o;return a?[a,t]:[t]}function Mu(r,e){var t=r.length|0,i=e.length|0;if(t===1&&i===1)return Tu(r[0],e[0]);var n=t+i,o=new Array(n),s=0,a=0,c=0,l=Math.abs,h=r[a],u=l(h),g=e[c],m=l(g),v,b;u<m?(b=h,a+=1,a<t&&(h=r[a],u=l(h))):(b=g,c+=1,c<i&&(g=e[c],m=l(g))),a<t&&u<m||c>=i?(v=h,a+=1,a<t&&(h=r[a],u=l(h))):(v=g,c+=1,c<i&&(g=e[c],m=l(g)));for(var E=v+b,_=E-v,S=b-_,d=S,p=E,x,R,I,T,f;a<t&&c<i;)u<m?(v=h,a+=1,a<t&&(h=r[a],u=l(h))):(v=g,c+=1,c<i&&(g=e[c],m=l(g))),b=d,E=v+b,_=E-v,S=b-_,S&&(o[s++]=S),x=p+E,R=x-p,I=x-R,T=E-R,f=p-I,d=f+T,p=x;for(;a<t;)v=h,b=d,E=v+b,_=E-v,S=b-_,S&&(o[s++]=S),x=p+E,R=x-p,I=x-R,T=E-R,f=p-I,d=f+T,p=x,a+=1,a<t&&(h=r[a]);for(;c<i;)v=g,b=d,E=v+b,_=E-v,S=b-_,S&&(o[s++]=S),x=p+E,R=x-p,I=x-R,T=E-R,f=p-I,d=f+T,p=x,c+=1,c<i&&(g=e[c]);return d&&(o[s++]=d),p&&(o[s++]=p),s||(o[s++]=0),o.length=s,o}var Pu=Eu;function Eu(r,e,t){var i=r+e,n=i-r,o=i-n,s=e-n,a=r-o;return t?(t[0]=a+s,t[1]=i,t):[a+s,i]}var Hi=ls,Su=Pu,Ru=Au;function Au(r,e){var t=r.length;if(t===1){var i=Hi(r[0],e);return i[0]?i:[i[1]]}var n=new Array(2*t),o=[.1,.1],s=[.1,.1],a=0;Hi(r[0],e,o),o[0]&&(n[a++]=o[0]);for(var c=1;c<t;++c){Hi(r[c],e,s);var l=o[1];Su(l,s[0],o),o[0]&&(n[a++]=o[0]);var h=s[1],u=o[1],g=h+u,m=g-h,v=u-m;o[1]=g,v&&(n[a++]=v)}return o[1]&&(n[a++]=o[1]),a===0&&(n[a++]=0),n.length=a,n}var Iu=Lu;function Cu(r,e){var t=r+e,i=t-r,n=t-i,o=e-i,s=r-n,a=s+o;return a?[a,t]:[t]}function Lu(r,e){var t=r.length|0,i=e.length|0;if(t===1&&i===1)return Cu(r[0],-e[0]);var n=t+i,o=new Array(n),s=0,a=0,c=0,l=Math.abs,h=r[a],u=l(h),g=-e[c],m=l(g),v,b;u<m?(b=h,a+=1,a<t&&(h=r[a],u=l(h))):(b=g,c+=1,c<i&&(g=-e[c],m=l(g))),a<t&&u<m||c>=i?(v=h,a+=1,a<t&&(h=r[a],u=l(h))):(v=g,c+=1,c<i&&(g=-e[c],m=l(g)));for(var E=v+b,_=E-v,S=b-_,d=S,p=E,x,R,I,T,f;a<t&&c<i;)u<m?(v=h,a+=1,a<t&&(h=r[a],u=l(h))):(v=g,c+=1,c<i&&(g=-e[c],m=l(g))),b=d,E=v+b,_=E-v,S=b-_,S&&(o[s++]=S),x=p+E,R=x-p,I=x-R,T=E-R,f=p-I,d=f+T,p=x;for(;a<t;)v=h,b=d,E=v+b,_=E-v,S=b-_,S&&(o[s++]=S),x=p+E,R=x-p,I=x-R,T=E-R,f=p-I,d=f+T,p=x,a+=1,a<t&&(h=r[a]);for(;c<i;)v=g,b=d,E=v+b,_=E-v,S=b-_,S&&(o[s++]=S),x=p+E,R=x-p,I=x-R,T=E-R,f=p-I,d=f+T,p=x,c+=1,c<i&&(g=-e[c]);return d&&(o[s++]=d),p&&(o[s++]=p),s||(o[s++]=0),o.length=s,o}(function(r){var e=ls,t=bu,i=Ru,n=Iu,o=5,s=11102230246251565e-32,a=(3+16*s)*s,c=(7+56*s)*s;function l(d,p,x,R){return function(T,f,w){var P=d(d(p(f[1],w[0]),p(-w[1],f[0])),d(p(T[1],f[0]),p(-f[1],T[0]))),M=d(p(T[1],w[0]),p(-w[1],T[0])),$=R(P,M);return $[$.length-1]}}function h(d,p,x,R){return function(T,f,w,P){var M=d(d(x(d(p(w[1],P[0]),p(-P[1],w[0])),f[2]),d(x(d(p(f[1],P[0]),p(-P[1],f[0])),-w[2]),x(d(p(f[1],w[0]),p(-w[1],f[0])),P[2]))),d(x(d(p(f[1],P[0]),p(-P[1],f[0])),T[2]),d(x(d(p(T[1],P[0]),p(-P[1],T[0])),-f[2]),x(d(p(T[1],f[0]),p(-f[1],T[0])),P[2])))),$=d(d(x(d(p(w[1],P[0]),p(-P[1],w[0])),T[2]),d(x(d(p(T[1],P[0]),p(-P[1],T[0])),-w[2]),x(d(p(T[1],w[0]),p(-w[1],T[0])),P[2]))),d(x(d(p(f[1],w[0]),p(-w[1],f[0])),T[2]),d(x(d(p(T[1],w[0]),p(-w[1],T[0])),-f[2]),x(d(p(T[1],f[0]),p(-f[1],T[0])),w[2])))),Y=R(M,$);return Y[Y.length-1]}}function u(d,p,x,R){return function(T,f,w,P,M){var $=d(d(d(x(d(x(d(p(P[1],M[0]),p(-M[1],P[0])),w[2]),d(x(d(p(w[1],M[0]),p(-M[1],w[0])),-P[2]),x(d(p(w[1],P[0]),p(-P[1],w[0])),M[2]))),f[3]),d(x(d(x(d(p(P[1],M[0]),p(-M[1],P[0])),f[2]),d(x(d(p(f[1],M[0]),p(-M[1],f[0])),-P[2]),x(d(p(f[1],P[0]),p(-P[1],f[0])),M[2]))),-w[3]),x(d(x(d(p(w[1],M[0]),p(-M[1],w[0])),f[2]),d(x(d(p(f[1],M[0]),p(-M[1],f[0])),-w[2]),x(d(p(f[1],w[0]),p(-w[1],f[0])),M[2]))),P[3]))),d(x(d(x(d(p(w[1],P[0]),p(-P[1],w[0])),f[2]),d(x(d(p(f[1],P[0]),p(-P[1],f[0])),-w[2]),x(d(p(f[1],w[0]),p(-w[1],f[0])),P[2]))),-M[3]),d(x(d(x(d(p(P[1],M[0]),p(-M[1],P[0])),f[2]),d(x(d(p(f[1],M[0]),p(-M[1],f[0])),-P[2]),x(d(p(f[1],P[0]),p(-P[1],f[0])),M[2]))),T[3]),x(d(x(d(p(P[1],M[0]),p(-M[1],P[0])),T[2]),d(x(d(p(T[1],M[0]),p(-M[1],T[0])),-P[2]),x(d(p(T[1],P[0]),p(-P[1],T[0])),M[2]))),-f[3])))),d(d(x(d(x(d(p(f[1],M[0]),p(-M[1],f[0])),T[2]),d(x(d(p(T[1],M[0]),p(-M[1],T[0])),-f[2]),x(d(p(T[1],f[0]),p(-f[1],T[0])),M[2]))),P[3]),d(x(d(x(d(p(f[1],P[0]),p(-P[1],f[0])),T[2]),d(x(d(p(T[1],P[0]),p(-P[1],T[0])),-f[2]),x(d(p(T[1],f[0]),p(-f[1],T[0])),P[2]))),-M[3]),x(d(x(d(p(w[1],P[0]),p(-P[1],w[0])),f[2]),d(x(d(p(f[1],P[0]),p(-P[1],f[0])),-w[2]),x(d(p(f[1],w[0]),p(-w[1],f[0])),P[2]))),T[3]))),d(x(d(x(d(p(w[1],P[0]),p(-P[1],w[0])),T[2]),d(x(d(p(T[1],P[0]),p(-P[1],T[0])),-w[2]),x(d(p(T[1],w[0]),p(-w[1],T[0])),P[2]))),-f[3]),d(x(d(x(d(p(f[1],P[0]),p(-P[1],f[0])),T[2]),d(x(d(p(T[1],P[0]),p(-P[1],T[0])),-f[2]),x(d(p(T[1],f[0]),p(-f[1],T[0])),P[2]))),w[3]),x(d(x(d(p(f[1],w[0]),p(-w[1],f[0])),T[2]),d(x(d(p(T[1],w[0]),p(-w[1],T[0])),-f[2]),x(d(p(T[1],f[0]),p(-f[1],T[0])),w[2]))),-P[3]))))),Y=d(d(d(x(d(x(d(p(P[1],M[0]),p(-M[1],P[0])),w[2]),d(x(d(p(w[1],M[0]),p(-M[1],w[0])),-P[2]),x(d(p(w[1],P[0]),p(-P[1],w[0])),M[2]))),T[3]),x(d(x(d(p(P[1],M[0]),p(-M[1],P[0])),T[2]),d(x(d(p(T[1],M[0]),p(-M[1],T[0])),-P[2]),x(d(p(T[1],P[0]),p(-P[1],T[0])),M[2]))),-w[3])),d(x(d(x(d(p(w[1],M[0]),p(-M[1],w[0])),T[2]),d(x(d(p(T[1],M[0]),p(-M[1],T[0])),-w[2]),x(d(p(T[1],w[0]),p(-w[1],T[0])),M[2]))),P[3]),x(d(x(d(p(w[1],P[0]),p(-P[1],w[0])),T[2]),d(x(d(p(T[1],P[0]),p(-P[1],T[0])),-w[2]),x(d(p(T[1],w[0]),p(-w[1],T[0])),P[2]))),-M[3]))),d(d(x(d(x(d(p(w[1],M[0]),p(-M[1],w[0])),f[2]),d(x(d(p(f[1],M[0]),p(-M[1],f[0])),-w[2]),x(d(p(f[1],w[0]),p(-w[1],f[0])),M[2]))),T[3]),x(d(x(d(p(w[1],M[0]),p(-M[1],w[0])),T[2]),d(x(d(p(T[1],M[0]),p(-M[1],T[0])),-w[2]),x(d(p(T[1],w[0]),p(-w[1],T[0])),M[2]))),-f[3])),d(x(d(x(d(p(f[1],M[0]),p(-M[1],f[0])),T[2]),d(x(d(p(T[1],M[0]),p(-M[1],T[0])),-f[2]),x(d(p(T[1],f[0]),p(-f[1],T[0])),M[2]))),w[3]),x(d(x(d(p(f[1],w[0]),p(-w[1],f[0])),T[2]),d(x(d(p(T[1],w[0]),p(-w[1],T[0])),-f[2]),x(d(p(T[1],f[0]),p(-f[1],T[0])),w[2]))),-M[3])))),X=R($,Y);return X[X.length-1]}}function g(d){var p=d===3?l:d===4?h:u;return p(t,e,i,n)}var m=g(3),v=g(4),b=[function(){return 0},function(){return 0},function(p,x){return x[0]-p[0]},function(p,x,R){var I=(p[1]-R[1])*(x[0]-R[0]),T=(p[0]-R[0])*(x[1]-R[1]),f=I-T,w;if(I>0){if(T<=0)return f;w=I+T}else if(I<0){if(T>=0)return f;w=-(I+T)}else return f;var P=a*w;return f>=P||f<=-P?f:m(p,x,R)},function(p,x,R,I){var T=p[0]-I[0],f=x[0]-I[0],w=R[0]-I[0],P=p[1]-I[1],M=x[1]-I[1],$=R[1]-I[1],Y=p[2]-I[2],X=x[2]-I[2],W=R[2]-I[2],ae=f*$,pe=w*M,ye=w*P,Q=T*$,Ae=T*M,V=f*P,oe=Y*(ae-pe)+X*(ye-Q)+W*(Ae-V),we=(Math.abs(ae)+Math.abs(pe))*Math.abs(Y)+(Math.abs(ye)+Math.abs(Q))*Math.abs(X)+(Math.abs(Ae)+Math.abs(V))*Math.abs(W),me=c*we;return oe>me||-oe>me?oe:v(p,x,R,I)}];function E(d){var p=b[d.length];return p||(p=b[d.length]=g(d.length)),p.apply(void 0,d)}function _(d,p,x,R,I,T,f){return function(P,M,$,Y,X){switch(arguments.length){case 0:case 1:return 0;case 2:return R(P,M);case 3:return I(P,M,$);case 4:return T(P,M,$,Y);case 5:return f(P,M,$,Y,X)}for(var W=new Array(arguments.length),ae=0;ae<arguments.length;++ae)W[ae]=arguments[ae];return d(W)}}function S(){for(;b.length<=o;)b.push(g(b.length));r.exports=_.apply(void 0,[E].concat(b));for(var d=0;d<=o;++d)r.exports[d]=b[d]}S()})(cs);var ku=cs.exports,ju=Ou,ii=ku;function Ou(r,e){for(var t=e[0],i=e[1],n=r.length,o=1,s=n,a=0,c=n-1;a<s;c=a++){var l=r[a],h=r[c],u=l[1],g=h[1];if(g<u){if(g<i&&i<u){var m=ii(l,h,e);if(m===0)return 0;o^=0<m|0}else if(i===u){var v=r[(a+1)%n],b=v[1];if(u<b){var m=ii(l,h,e);if(m===0)return 0;o^=0<m|0}}}else if(u<g){if(u<i&&i<g){var m=ii(l,h,e);if(m===0)return 0;o^=m<0|0}else if(i===u){var v=r[(a+1)%n],b=v[1];if(b<u){var m=ii(l,h,e);if(m===0)return 0;o^=m<0|0}}}else if(i===u){var E=Math.min(l[0],h[0]),_=Math.max(l[0],h[0]);if(a===0){for(;c>0;){var S=(c+n-1)%n,d=r[S];if(d[1]!==i)break;var p=d[0];E=Math.min(E,p),_=Math.max(_,p),c=S}if(c===0)return E<=t&&t<=_?0:1;s=c+1}for(var x=r[(c+n-1)%n][1];a+1<s;){var d=r[a+1];if(d[1]!==i)break;var p=d[0];E=Math.min(E,p),_=Math.max(_,p),a+=1}if(E<=t&&t<=_)return 0;var R=r[(a+1)%n][1];t<E&&x<i!=R<i&&(o^=1)}}return 2*o-1}const Fu=_u(ju);var us={};const Du={version:"1.5.0"};function ds(r){return"("+r.x+";"+r.y+")"}function Gu(r){var e=r.toString();return e==="[object Object]"?ds(r):e}function Nu(r,e){return r.y===e.y?r.x-e.x:r.y-e.y}function Bu(r,e){return r.x===e.x&&r.y===e.y}var Yi={toString:Gu,toStringBase:ds,compare:Nu,equals:Bu},zu=Yi,ni=function(r,e){this.name="PointError",this.points=e=e||[],this.message=r||"Invalid Points!";for(var t=0;t<e.length;t++)this.message+=" "+zu.toString(e[t])};ni.prototype=new Error,ni.prototype.constructor=ni;var Ki=ni,cr=Yi,J=function(r,e){this.x=+r||0,this.y=+e||0,this._p2t_edge_list=null};J.prototype.toString=function(){return cr.toStringBase(this)},J.prototype.toJSON=function(){return{x:this.x,y:this.y}},J.prototype.clone=function(){return new J(this.x,this.y)},J.prototype.set_zero=function(){return this.x=0,this.y=0,this},J.prototype.set=function(r,e){return this.x=+r||0,this.y=+e||0,this},J.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},J.prototype.add=function(r){return this.x+=r.x,this.y+=r.y,this},J.prototype.sub=function(r){return this.x-=r.x,this.y-=r.y,this},J.prototype.mul=function(r){return this.x*=r,this.y*=r,this},J.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},J.prototype.normalize=function(){var r=this.length();return this.x/=r,this.y/=r,r},J.prototype.equals=function(r){return this.x===r.x&&this.y===r.y},J.negate=function(r){return new J(-r.x,-r.y)},J.add=function(r,e){return new J(r.x+e.x,r.y+e.y)},J.sub=function(r,e){return new J(r.x-e.x,r.y-e.y)},J.mul=function(r,e){return new J(r*e.x,r*e.y)},J.cross=function(r,e){return typeof r=="number"?typeof e=="number"?r*e:new J(-r*e.y,r*e.x):typeof e=="number"?new J(e*r.y,-e*r.x):r.x*e.y-r.y*e.x},J.toString=cr.toString,J.compare=cr.compare,J.cmp=cr.compare,J.equals=cr.equals,J.dot=function(r,e){return r.x*e.x+r.y*e.y};var fs=J,Uu=Yi,q=function(r,e,t){this.points_=[r,e,t],this.neighbors_=[null,null,null],this.interior_=!1,this.constrained_edge=[!1,!1,!1],this.delaunay_edge=[!1,!1,!1]},Ji=Uu.toString;q.prototype.toString=function(){return"["+Ji(this.points_[0])+Ji(this.points_[1])+Ji(this.points_[2])+"]"},q.prototype.getPoint=function(r){return this.points_[r]},q.prototype.GetPoint=q.prototype.getPoint,q.prototype.getPoints=function(){return this.points_},q.prototype.getNeighbor=function(r){return this.neighbors_[r]},q.prototype.containsPoint=function(r){var e=this.points_;return r===e[0]||r===e[1]||r===e[2]},q.prototype.containsEdge=function(r){return this.containsPoint(r.p)&&this.containsPoint(r.q)},q.prototype.containsPoints=function(r,e){return this.containsPoint(r)&&this.containsPoint(e)},q.prototype.isInterior=function(){return this.interior_},q.prototype.setInterior=function(r){return this.interior_=r,this},q.prototype.markNeighborPointers=function(r,e,t){var i=this.points_;if(r===i[2]&&e===i[1]||r===i[1]&&e===i[2])this.neighbors_[0]=t;else if(r===i[0]&&e===i[2]||r===i[2]&&e===i[0])this.neighbors_[1]=t;else if(r===i[0]&&e===i[1]||r===i[1]&&e===i[0])this.neighbors_[2]=t;else throw new Error("poly2tri Invalid Triangle.markNeighborPointers() call")},q.prototype.markNeighbor=function(r){var e=this.points_;r.containsPoints(e[1],e[2])?(this.neighbors_[0]=r,r.markNeighborPointers(e[1],e[2],this)):r.containsPoints(e[0],e[2])?(this.neighbors_[1]=r,r.markNeighborPointers(e[0],e[2],this)):r.containsPoints(e[0],e[1])&&(this.neighbors_[2]=r,r.markNeighborPointers(e[0],e[1],this))},q.prototype.clearNeighbors=function(){this.neighbors_[0]=null,this.neighbors_[1]=null,this.neighbors_[2]=null},q.prototype.clearDelaunayEdges=function(){this.delaunay_edge[0]=!1,this.delaunay_edge[1]=!1,this.delaunay_edge[2]=!1},q.prototype.pointCW=function(r){var e=this.points_;return r===e[0]?e[2]:r===e[1]?e[0]:r===e[2]?e[1]:null},q.prototype.pointCCW=function(r){var e=this.points_;return r===e[0]?e[1]:r===e[1]?e[2]:r===e[2]?e[0]:null},q.prototype.neighborCW=function(r){return r===this.points_[0]?this.neighbors_[1]:r===this.points_[1]?this.neighbors_[2]:this.neighbors_[0]},q.prototype.neighborCCW=function(r){return r===this.points_[0]?this.neighbors_[2]:r===this.points_[1]?this.neighbors_[0]:this.neighbors_[1]},q.prototype.getConstrainedEdgeCW=function(r){return r===this.points_[0]?this.constrained_edge[1]:r===this.points_[1]?this.constrained_edge[2]:this.constrained_edge[0]},q.prototype.getConstrainedEdgeCCW=function(r){return r===this.points_[0]?this.constrained_edge[2]:r===this.points_[1]?this.constrained_edge[0]:this.constrained_edge[1]},q.prototype.getConstrainedEdgeAcross=function(r){return r===this.points_[0]?this.constrained_edge[0]:r===this.points_[1]?this.constrained_edge[1]:this.constrained_edge[2]},q.prototype.setConstrainedEdgeCW=function(r,e){r===this.points_[0]?this.constrained_edge[1]=e:r===this.points_[1]?this.constrained_edge[2]=e:this.constrained_edge[0]=e},q.prototype.setConstrainedEdgeCCW=function(r,e){r===this.points_[0]?this.constrained_edge[2]=e:r===this.points_[1]?this.constrained_edge[0]=e:this.constrained_edge[1]=e},q.prototype.getDelaunayEdgeCW=function(r){return r===this.points_[0]?this.delaunay_edge[1]:r===this.points_[1]?this.delaunay_edge[2]:this.delaunay_edge[0]},q.prototype.getDelaunayEdgeCCW=function(r){return r===this.points_[0]?this.delaunay_edge[2]:r===this.points_[1]?this.delaunay_edge[0]:this.delaunay_edge[1]},q.prototype.setDelaunayEdgeCW=function(r,e){r===this.points_[0]?this.delaunay_edge[1]=e:r===this.points_[1]?this.delaunay_edge[2]=e:this.delaunay_edge[0]=e},q.prototype.setDelaunayEdgeCCW=function(r,e){r===this.points_[0]?this.delaunay_edge[2]=e:r===this.points_[1]?this.delaunay_edge[0]=e:this.delaunay_edge[1]=e},q.prototype.neighborAcross=function(r){return r===this.points_[0]?this.neighbors_[0]:r===this.points_[1]?this.neighbors_[1]:this.neighbors_[2]},q.prototype.oppositePoint=function(r,e){var t=r.pointCW(e);return this.pointCW(t)},q.prototype.legalize=function(r,e){var t=this.points_;if(r===t[0])t[1]=t[0],t[0]=t[2],t[2]=e;else if(r===t[1])t[2]=t[1],t[1]=t[0],t[0]=e;else if(r===t[2])t[0]=t[2],t[2]=t[1],t[1]=e;else throw new Error("poly2tri Invalid Triangle.legalize() call")},q.prototype.index=function(r){var e=this.points_;if(r===e[0])return 0;if(r===e[1])return 1;if(r===e[2])return 2;throw new Error("poly2tri Invalid Triangle.index() call")},q.prototype.edgeIndex=function(r,e){var t=this.points_;if(r===t[0]){if(e===t[1])return 2;if(e===t[2])return 1}else if(r===t[1]){if(e===t[2])return 0;if(e===t[0])return 2}else if(r===t[2]){if(e===t[0])return 1;if(e===t[1])return 0}return-1},q.prototype.markConstrainedEdgeByIndex=function(r){this.constrained_edge[r]=!0},q.prototype.markConstrainedEdgeByEdge=function(r){this.markConstrainedEdgeByPoints(r.p,r.q)},q.prototype.markConstrainedEdgeByPoints=function(r,e){var t=this.points_;e===t[0]&&r===t[1]||e===t[1]&&r===t[0]?this.constrained_edge[2]=!0:e===t[0]&&r===t[2]||e===t[2]&&r===t[0]?this.constrained_edge[1]=!0:(e===t[1]&&r===t[2]||e===t[2]&&r===t[1])&&(this.constrained_edge[0]=!0)};var Qi=q,en={};function Vu(r,e){if(!r)throw new Error(e||"Assert Failed")}var Wu=Vu,tn={exports:{}},$u=function(r,e){this.point=r,this.triangle=e||null,this.next=null,this.prev=null,this.value=r.x},Ge=function(r,e){this.head_=r,this.tail_=e,this.search_node_=r};Ge.prototype.head=function(){return this.head_},Ge.prototype.setHead=function(r){this.head_=r},Ge.prototype.tail=function(){return this.tail_},Ge.prototype.setTail=function(r){this.tail_=r},Ge.prototype.search=function(){return this.search_node_},Ge.prototype.setSearch=function(r){this.search_node_=r},Ge.prototype.findSearchNode=function(){return this.search_node_},Ge.prototype.locateNode=function(r){var e=this.search_node_;if(r<e.value){for(;e=e.prev;)if(r>=e.value)return this.search_node_=e,e}else for(;e=e.next;)if(r<e.value)return this.search_node_=e.prev,e.prev;return null},Ge.prototype.locatePoint=function(r){var e=r.x,t=this.findSearchNode(e),i=t.point.x;if(e===i){if(r!==t.point)if(r===t.prev.point)t=t.prev;else if(r===t.next.point)t=t.next;else throw new Error("poly2tri Invalid AdvancingFront.locatePoint() call")}else if(e<i)for(;(t=t.prev)&&r!==t.point;);else for(;(t=t.next)&&r!==t.point;);return t&&(this.search_node_=t),t},tn.exports=Ge,tn.exports.Node=$u;var ps=tn.exports,Ct={},lr=1e-12;Ct.EPSILON=lr;var oi={CW:1,CCW:-1,COLLINEAR:0};Ct.Orientation=oi;function Zu(r,e,t){var i=(r.x-t.x)*(e.y-t.y),n=(r.y-t.y)*(e.x-t.x),o=i-n;return o>-lr&&o<lr?oi.COLLINEAR:o>0?oi.CCW:oi.CW}Ct.orient2d=Zu;function qu(r,e,t,i){var n=(r.x-e.x)*(i.y-e.y)-(i.x-e.x)*(r.y-e.y);if(n>=-lr)return!1;var o=(r.x-t.x)*(i.y-t.y)-(i.x-t.x)*(r.y-t.y);return!(o<=lr)}Ct.inScanArea=qu;function Xu(r,e,t){var i=e.x-r.x,n=e.y-r.y,o=t.x-r.x,s=t.y-r.y;return i*o+n*s<0}Ct.isAngleObtuse=Xu;var rn=Wu,si=Ki,gs=Qi,Hu=ps.Node,hr=Ct,Yu=hr.EPSILON,ne=hr.Orientation,he=hr.orient2d,ms=hr.inScanArea,vs=hr.isAngleObtuse;function Ku(r){r.initTriangulation(),r.createAdvancingFront(),Ju(r),Qu(r)}function Ju(r){var e,t=r.pointCount();for(e=1;e<t;++e)for(var i=r.getPoint(e),n=ed(r,i),o=i._p2t_edge_list,s=0;o&&s<o.length;++s)td(r,o[s],n)}function Qu(r){for(var e=r.front().head().next.triangle,t=r.front().head().next.point;!e.getConstrainedEdgeCW(t);)e=e.neighborCCW(t);r.meshClean(e)}function ed(r,e){var t=r.locateNode(e),i=rd(r,e,t);return e.x<=t.point.x+Yu&&Lt(r,t),id(r,i),i}function td(r,e,t){r.edge_event.constrained_edge=e,r.edge_event.right=e.p.x>e.q.x,!ys(t.triangle,e.p,e.q)&&(cd(r,e,t),nn(r,e.p,e.q,t.triangle,e.q))}function nn(r,e,t,i,n){if(!ys(i,e,t)){var o=i.pointCCW(n),s=he(t,o,e);if(s===ne.COLLINEAR)throw new si("poly2tri EdgeEvent: Collinear not supported!",[t,o,e]);var a=i.pointCW(n),c=he(t,a,e);if(c===ne.COLLINEAR)throw new si("poly2tri EdgeEvent: Collinear not supported!",[t,a,e]);s===c?(s===ne.CW?i=i.neighborCCW(n):i=i.neighborCW(n),nn(r,e,t,i,n)):an(r,e,t,i,n)}}function ys(r,e,t){var i=r.edgeIndex(e,t);if(i!==-1){r.markConstrainedEdgeByIndex(i);var n=r.getNeighbor(i);return n&&n.markConstrainedEdgeByPoints(e,t),!0}return!1}function rd(r,e,t){var i=new gs(e,t.point,t.next.point);i.markNeighbor(t.triangle),r.addToMap(i);var n=new Hu(e);return n.next=t.next,n.prev=t,t.next.prev=n,t.next=n,ht(r,i)||r.mapTriangleToNodes(i),n}function Lt(r,e){var t=new gs(e.prev.point,e.point,e.next.point);t.markNeighbor(e.prev.triangle),t.markNeighbor(e.triangle),r.addToMap(t),e.prev.next=e.next,e.next.prev=e.prev,ht(r,t)||r.mapTriangleToNodes(t)}function id(r,e){for(var t=e.next;t.next&&!vs(t.point,t.next.point,t.prev.point);)Lt(r,t),t=t.next;for(t=e.prev;t.prev&&!vs(t.point,t.next.point,t.prev.point);)Lt(r,t),t=t.prev;e.next&&e.next.next&&nd(e)&&sd(r,e)}function nd(r){var e=r.point.x-r.next.next.point.x,t=r.point.y-r.next.next.point.y;return rn(t>=0,"unordered y"),e>=0||Math.abs(e)<t}function ht(r,e){for(var t=0;t<3;++t)if(!e.delaunay_edge[t]){var i=e.getNeighbor(t);if(i){var n=e.getPoint(t),o=i.oppositePoint(e,n),s=i.index(o);if(i.constrained_edge[s]||i.delaunay_edge[s]){e.constrained_edge[t]=i.constrained_edge[s];continue}var a=od(n,e.pointCCW(n),e.pointCW(n),o);if(a){e.delaunay_edge[t]=!0,i.delaunay_edge[s]=!0,ws(e,n,i,o);var c=!ht(r,e);return c&&r.mapTriangleToNodes(e),c=!ht(r,i),c&&r.mapTriangleToNodes(i),e.delaunay_edge[t]=!1,i.delaunay_edge[s]=!1,!0}}}return!1}function od(r,e,t,i){var n=r.x-i.x,o=r.y-i.y,s=e.x-i.x,a=e.y-i.y,c=n*a,l=s*o,h=c-l;if(h<=0)return!1;var u=t.x-i.x,g=t.y-i.y,m=u*o,v=n*g,b=m-v;if(b<=0)return!1;var E=s*g,_=u*a,S=n*n+o*o,d=s*s+a*a,p=u*u+g*g,x=S*(E-_)+d*b+p*h;return x>0}function ws(r,e,t,i){var n,o,s,a;n=r.neighborCCW(e),o=r.neighborCW(e),s=t.neighborCCW(i),a=t.neighborCW(i);var c,l,h,u;c=r.getConstrainedEdgeCCW(e),l=r.getConstrainedEdgeCW(e),h=t.getConstrainedEdgeCCW(i),u=t.getConstrainedEdgeCW(i);var g,m,v,b;g=r.getDelaunayEdgeCCW(e),m=r.getDelaunayEdgeCW(e),v=t.getDelaunayEdgeCCW(i),b=t.getDelaunayEdgeCW(i),r.legalize(e,i),t.legalize(i,e),t.setDelaunayEdgeCCW(e,g),r.setDelaunayEdgeCW(e,m),r.setDelaunayEdgeCCW(i,v),t.setDelaunayEdgeCW(i,b),t.setConstrainedEdgeCCW(e,c),r.setConstrainedEdgeCW(e,l),r.setConstrainedEdgeCCW(i,h),t.setConstrainedEdgeCW(i,u),r.clearNeighbors(),t.clearNeighbors(),n&&t.markNeighbor(n),o&&r.markNeighbor(o),s&&r.markNeighbor(s),a&&t.markNeighbor(a),r.markNeighbor(t)}function sd(r,e){for(he(e.point,e.next.point,e.next.next.point)===ne.CCW?r.basin.left_node=e.next.next:r.basin.left_node=e.next,r.basin.bottom_node=r.basin.left_node;r.basin.bottom_node.next&&r.basin.bottom_node.point.y>=r.basin.bottom_node.next.point.y;)r.basin.bottom_node=r.basin.bottom_node.next;if(r.basin.bottom_node!==r.basin.left_node){for(r.basin.right_node=r.basin.bottom_node;r.basin.right_node.next&&r.basin.right_node.point.y<r.basin.right_node.next.point.y;)r.basin.right_node=r.basin.right_node.next;r.basin.right_node!==r.basin.bottom_node&&(r.basin.width=r.basin.right_node.point.x-r.basin.left_node.point.x,r.basin.left_highest=r.basin.left_node.point.y>r.basin.right_node.point.y,_s(r,r.basin.bottom_node))}}function _s(r,e){if(!ad(r,e)){Lt(r,e);var t;if(!(e.prev===r.basin.left_node&&e.next===r.basin.right_node)){if(e.prev===r.basin.left_node){if(t=he(e.point,e.next.point,e.next.next.point),t===ne.CW)return;e=e.next}else if(e.next===r.basin.right_node){if(t=he(e.point,e.prev.point,e.prev.prev.point),t===ne.CCW)return;e=e.prev}else e.prev.point.y<e.next.point.y?e=e.prev:e=e.next;_s(r,e)}}}function ad(r,e){var t;return r.basin.left_highest?t=r.basin.left_node.point.y-e.point.y:t=r.basin.right_node.point.y-e.point.y,r.basin.width>t}function cd(r,e,t){r.edge_event.right?ld(r,e,t):hd(r,e,t)}function ld(r,e,t){for(;t.next.point.x<e.p.x;)he(e.q,t.next.point,e.p)===ne.CCW?xs(r,e,t):t=t.next}function xs(r,e,t){t.point.x<e.p.x&&(he(t.point,t.next.point,t.next.next.point)===ne.CCW?on(r,e,t):(bs(r,e,t),xs(r,e,t)))}function on(r,e,t){Lt(r,t.next),t.next.point!==e.p&&he(e.q,t.next.point,e.p)===ne.CCW&&he(t.point,t.next.point,t.next.next.point)===ne.CCW&&on(r,e,t)}function bs(r,e,t){he(t.next.point,t.next.next.point,t.next.next.next.point)===ne.CCW?on(r,e,t.next):he(e.q,t.next.next.point,e.p)===ne.CCW&&bs(r,e,t.next)}function hd(r,e,t){for(;t.prev.point.x>e.p.x;)he(e.q,t.prev.point,e.p)===ne.CW?Ts(r,e,t):t=t.prev}function Ts(r,e,t){t.point.x>e.p.x&&(he(t.point,t.prev.point,t.prev.prev.point)===ne.CW?sn(r,e,t):(Ms(r,e,t),Ts(r,e,t)))}function Ms(r,e,t){he(t.prev.point,t.prev.prev.point,t.prev.prev.prev.point)===ne.CW?sn(r,e,t.prev):he(e.q,t.prev.prev.point,e.p)===ne.CW&&Ms(r,e,t.prev)}function sn(r,e,t){Lt(r,t.prev),t.prev.point!==e.p&&he(e.q,t.prev.point,e.p)===ne.CW&&he(t.point,t.prev.point,t.prev.prev.point)===ne.CW&&sn(r,e,t)}function an(r,e,t,i,n){var o=i.neighborAcross(n);rn(o,"FLIP failed due to missing triangle!");var s=o.oppositePoint(i,n);if(i.getConstrainedEdgeAcross(n)){var a=i.index(n);throw new si("poly2tri Intersecting Constraints",[n,s,i.getPoint((a+1)%3),i.getPoint((a+2)%3)])}if(ms(n,i.pointCCW(n),i.pointCW(n),s))if(ws(i,n,o,s),r.mapTriangleToNodes(i),r.mapTriangleToNodes(o),n===t&&s===e)t===r.edge_event.constrained_edge.q&&e===r.edge_event.constrained_edge.p&&(i.markConstrainedEdgeByPoints(e,t),o.markConstrainedEdgeByPoints(e,t),ht(r,i),ht(r,o));else{var c=he(t,s,e);i=ud(r,c,i,o,n,s),an(r,e,t,i,n)}else{var l=Ps(e,t,o,s);Es(r,e,t,i,o,l),nn(r,e,t,i,n)}}function ud(r,e,t,i,n,o){var s;return e===ne.CCW?(s=i.edgeIndex(n,o),i.delaunay_edge[s]=!0,ht(r,i),i.clearDelaunayEdges(),t):(s=t.edgeIndex(n,o),t.delaunay_edge[s]=!0,ht(r,t),t.clearDelaunayEdges(),i)}function Ps(r,e,t,i){var n=he(e,i,r);if(n===ne.CW)return t.pointCCW(i);if(n===ne.CCW)return t.pointCW(i);throw new si("poly2tri [Unsupported] nextFlipPoint: opposing point on constrained edge!",[e,i,r])}function Es(r,e,t,i,n,o){var s=n.neighborAcross(o);rn(s,"FLIP failed due to missing triangle");var a=s.oppositePoint(n,o);if(ms(t,i.pointCCW(t),i.pointCW(t),a))an(r,t,a,s,a);else{var c=Ps(e,t,s,a);Es(r,e,t,i,s,c)}}en.triangulate=Ku;var dd=Ki,ur=fs,fd=Qi,pd=en,Ss=ps,cn=Ss.Node,Rs=.3,gd=function(r,e){if(this.p=r,this.q=e,r.y>e.y)this.q=r,this.p=e;else if(r.y===e.y){if(r.x>e.x)this.q=r,this.p=e;else if(r.x===e.x)throw new dd("poly2tri Invalid Edge constructor: repeated points!",[r])}this.q._p2t_edge_list||(this.q._p2t_edge_list=[]),this.q._p2t_edge_list.push(this)},As=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};As.prototype.clear=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};var md=function(){this.constrained_edge=null,this.right=!1},K=function(r,e){e=e||{},this.triangles_=[],this.map_=[],this.points_=e.cloneArrays?r.slice(0):r,this.edge_list=[],this.pmin_=this.pmax_=null,this.front_=null,this.head_=null,this.tail_=null,this.af_head_=null,this.af_middle_=null,this.af_tail_=null,this.basin=new As,this.edge_event=new md,this.initEdges(this.points_)};K.prototype.addHole=function(r){this.initEdges(r);var e,t=r.length;for(e=0;e<t;e++)this.points_.push(r[e]);return this},K.prototype.AddHole=K.prototype.addHole,K.prototype.addHoles=function(r){var e,t=r.length;for(e=0;e<t;e++)this.initEdges(r[e]);return this.points_=this.points_.concat.apply(this.points_,r),this},K.prototype.addPoint=function(r){return this.points_.push(r),this},K.prototype.AddPoint=K.prototype.addPoint,K.prototype.addPoints=function(r){return this.points_=this.points_.concat(r),this},K.prototype.triangulate=function(){return pd.triangulate(this),this},K.prototype.getBoundingBox=function(){return{min:this.pmin_,max:this.pmax_}},K.prototype.getTriangles=function(){return this.triangles_},K.prototype.GetTriangles=K.prototype.getTriangles,K.prototype.front=function(){return this.front_},K.prototype.pointCount=function(){return this.points_.length},K.prototype.head=function(){return this.head_},K.prototype.setHead=function(r){this.head_=r},K.prototype.tail=function(){return this.tail_},K.prototype.setTail=function(r){this.tail_=r},K.prototype.getMap=function(){return this.map_},K.prototype.initTriangulation=function(){var r=this.points_[0].x,e=this.points_[0].x,t=this.points_[0].y,i=this.points_[0].y,n,o=this.points_.length;for(n=1;n<o;n++){var s=this.points_[n];s.x>r&&(r=s.x),s.x<e&&(e=s.x),s.y>t&&(t=s.y),s.y<i&&(i=s.y)}this.pmin_=new ur(e,i),this.pmax_=new ur(r,t);var a=Rs*(r-e),c=Rs*(t-i);this.head_=new ur(r+a,i-c),this.tail_=new ur(e-a,i-c),this.points_.sort(ur.compare)},K.prototype.initEdges=function(r){var e,t=r.length;for(e=0;e<t;++e)this.edge_list.push(new gd(r[e],r[(e+1)%t]))},K.prototype.getPoint=function(r){return this.points_[r]},K.prototype.addToMap=function(r){this.map_.push(r)},K.prototype.locateNode=function(r){return this.front_.locateNode(r.x)},K.prototype.createAdvancingFront=function(){var r,e,t,i=new fd(this.points_[0],this.tail_,this.head_);this.map_.push(i),r=new cn(i.getPoint(1),i),e=new cn(i.getPoint(0),i),t=new cn(i.getPoint(2)),this.front_=new Ss(r,t),r.next=e,e.next=t,e.prev=r,t.prev=e},K.prototype.removeNode=function(r){},K.prototype.mapTriangleToNodes=function(r){for(var e=0;e<3;++e)if(!r.getNeighbor(e)){var t=this.front_.locatePoint(r.pointCW(r.getPoint(e)));t&&(t.triangle=r)}},K.prototype.removeFromMap=function(r){var e,t=this.map_,i=t.length;for(e=0;e<i;e++)if(t[e]===r){t.splice(e,1);break}},K.prototype.meshClean=function(r){for(var e=[r],t,i;t=e.pop();)if(!t.isInterior())for(t.setInterior(!0),this.triangles_.push(t),i=0;i<3;i++)t.constrained_edge[i]||e.push(t.getNeighbor(i))};var vd=K;(function(r){var e=globalThis.poly2tri;r.noConflict=function(){return globalThis.poly2tri=e,r},r.VERSION=Du.version,r.PointError=Ki,r.Point=fs,r.Triangle=Qi,r.SweepContext=vd;var t=en;r.triangulate=t.triangulate,r.sweep={Triangulate:t.triangulate}})(us);function yd(r,e){let t=0;const i=new us.SweepContext(yu(r,e).map(n=>({x:n[0],y:n[1],type:"p",item:t++})));i.addPoints(wu(r,e).filter(n=>Fu(r,n)===-1).map(n=>({x:n[0],y:n[1],type:"g",item:t++})));try{i.triangulate()}catch{throw new Error("A Point Error occured during resource mask triangulation. This is typically because the resource mask contains duplicate or collinear points, or is self-intersecting.")}return i.getTriangles()}function wd(r,e){const t=yd(r,e).map(a=>a.getPoints().map(c=>c)),o=[...new Map(t.flat().map(a=>[a.item,a])).values()].sort((a,c)=>a.item-c.item).map(a=>[a.x,a.y]);return{uniquePointsIndexTriangles:t.map(a=>a.map(c=>c.item)),uniquePoints:o}}const _d=80,xd=10;function bd(){return{}}let Td=class extends fu{resourceTrianglePoints=[];resourceUniquePoints=[];trianglePointsUniquePointsIndex=[];triangulationByBestScaleFactor=new Map;triangulateErrorCount=0;projectedGeoPreviousTrianglePoints=[];projectedGeoTrianglePoints=[];projectedGeoUniquePoints=[];projectedGeoUniquePointsByBestScaleFactorAndTransformationType=new Map;projectedGeoUniquePointsPartialDerivativeX=[];projectedGeoUniquePointsPartialDerivativeY=[];projectedGeoUniquePointsPartialDerivativeXByBestScaleFactorAndTransformationType=new Map;projectedGeoUniquePointsPartialDerivativeYByBestScaleFactorAndTransformationType=new Map;previousTrianglePointsDistortion=[];trianglePointsDistortion=[];uniquePointsDistortion=[];constructor(e,t,i){i={...bd(),...i},super(e,t,i)}setResourceMask(e){super.setResourceMask(e),this.triangulationByBestScaleFactor=new Map,this.projectedGeoUniquePointsByBestScaleFactorAndTransformationType=new Map,this.projectedGeoUniquePointsPartialDerivativeXByBestScaleFactorAndTransformationType=new Map,this.projectedGeoUniquePointsPartialDerivativeYByBestScaleFactorAndTransformationType=new Map,this.updateTriangulation()}setCurrentBestScaleFactor(e){const t=super.setCurrentBestScaleFactor(e);return t&&this.updateTriangulation(!0),t}resetPrevious(){super.resetPrevious(),this.projectedGeoPreviousTrianglePoints=this.projectedGeoTrianglePoints,this.previousTrianglePointsDistortion=this.trianglePointsDistortion}mixPreviousAndNew(e){super.mixPreviousAndNew(e),this.projectedGeoPreviousTrianglePoints=this.projectedGeoTrianglePoints.map((t,i)=>Mi(t,this.projectedGeoPreviousTrianglePoints[i],e)),this.previousTrianglePointsDistortion=this.trianglePointsDistortion.map((t,i)=>Ti(t,this.previousTrianglePointsDistortion[i],e))}updateTriangulation(e=!1){if(!this.currentBestScaleFactor)return;const{trianglePointsUniquePointsIndex:t,resourceUniquePoints:i}=Ar(this.triangulationByBestScaleFactor,this.currentBestScaleFactor,()=>{const n=rc(this.resourceMask)*this.currentBestScaleFactor/_d;try{const{uniquePointsIndexTriangles:o,uniquePoints:s}=wd(this.resourceMask,n);return{trianglePointsUniquePointsIndex:o.flat(),resourceUniquePoints:s}}catch(o){return this.triangulateErrorCount++,this.triangulateErrorCount<=xd&&(console.error(`Error computing triangulation for map ${this.mapId}.`,`Fix this map with Allmaps Editor: https://editor.allmaps.org/#/collection?url=${this.parsedImage?.uri}/info.json`),this.triangulateErrorCount===1&&console.error(o)),{trianglePointsUniquePointsIndex:this.trianglePointsUniquePointsIndex,resourceUniquePoints:this.resourceUniquePoints}}});this.resourceTrianglePoints=t.map(n=>i[n]),this.resourceUniquePoints=i,this.trianglePointsUniquePointsIndex=t,this.updateProjectedGeoTrianglePoints(e)}updateProjectedGeoTrianglePoints(e=!1){this.currentBestScaleFactor&&(this.projectedGeoUniquePoints=Ei(this.projectedGeoUniquePointsByBestScaleFactorAndTransformationType,this.currentBestScaleFactor,this.transformationType,()=>this.resourceUniquePoints.map(t=>this.projectedTransformer.transformToGeo(t))),this.projectedGeoTrianglePoints=this.trianglePointsUniquePointsIndex.map(t=>this.projectedGeoUniquePoints[t]),(e||!this.projectedGeoPreviousTrianglePoints.length)&&(this.projectedGeoPreviousTrianglePoints=this.projectedGeoTrianglePoints),this.updateTrianglePointsDistortion(e))}updateTrianglePointsDistortion(e=!1){this.currentBestScaleFactor&&(this.distortionMeasure&&(this.projectedGeoUniquePointsPartialDerivativeX=Ei(this.projectedGeoUniquePointsPartialDerivativeXByBestScaleFactorAndTransformationType,this.currentBestScaleFactor,this.transformationType,()=>this.resourceUniquePoints.map(t=>this.projectedTransformer.transformToGeo(t,{evaluationType:"partialDerivativeX"}))),this.projectedGeoUniquePointsPartialDerivativeY=Ei(this.projectedGeoUniquePointsPartialDerivativeYByBestScaleFactorAndTransformationType,this.currentBestScaleFactor,this.transformationType,()=>this.resourceUniquePoints.map(t=>this.projectedTransformer.transformToGeo(t,{evaluationType:"partialDerivativeY"})))),this.uniquePointsDistortion=this.projectedGeoUniquePoints.map((t,i)=>uu(this.projectedGeoUniquePointsPartialDerivativeX[i],this.projectedGeoUniquePointsPartialDerivativeY[i],this.distortionMeasure,this.getReferenceScale())),this.trianglePointsDistortion=this.trianglePointsUniquePointsIndex.map(t=>this.uniquePointsDistortion[t]),(e||!this.previousTrianglePointsDistortion.length)&&(this.previousTrianglePointsDistortion=this.trianglePointsDistortion))}updateTransformerProperties(e=!0){super.updateTransformerProperties(e),this.updateProjectedGeoTrianglePoints(!1)}updateDistortionProperties(){super.updateDistortionProperties(),this.updateTrianglePointsDistortion(!1)}};var Md=typeof globalThis=="object"&&globalThis&&globalThis.Object===Object&&globalThis,Pd=typeof self=="object"&&self&&self.Object===Object&&self,Is=Md||Pd||Function("return this")(),ai=Is.Symbol,Cs=Object.prototype,Ed=Cs.hasOwnProperty,Sd=Cs.toString,dr=ai?ai.toStringTag:void 0;function Rd(r){var e=Ed.call(r,dr),t=r[dr];try{r[dr]=void 0;var i=!0}catch{}var n=Sd.call(r);return i&&(e?r[dr]=t:delete r[dr]),n}var Ad=Object.prototype,Id=Ad.toString;function Cd(r){return Id.call(r)}var Ld="[object Null]",kd="[object Undefined]",Ls=ai?ai.toStringTag:void 0;function jd(r){return r==null?r===void 0?kd:Ld:Ls&&Ls in Object(r)?Rd(r):Cd(r)}function Od(r){return r!=null&&typeof r=="object"}var Fd="[object Symbol]";function Dd(r){return typeof r=="symbol"||Od(r)&&jd(r)==Fd}var Gd=/\s/;function Nd(r){for(var e=r.length;e--&&Gd.test(r.charAt(e)););return e}var Bd=/^\s+/;function zd(r){return r&&r.slice(0,Nd(r)+1).replace(Bd,"")}function ci(r){var e=typeof r;return r!=null&&(e=="object"||e=="function")}var ks=NaN,Ud=/^[-+]0x[0-9a-f]+$/i,Vd=/^0b[01]+$/i,Wd=/^0o[0-7]+$/i,$d=parseInt;function js(r){if(typeof r=="number")return r;if(Dd(r))return ks;if(ci(r)){var e=typeof r.valueOf=="function"?r.valueOf():r;r=ci(e)?e+"":e}if(typeof r!="string")return r===0?r:+r;r=zd(r);var t=Vd.test(r);return t||Wd.test(r)?$d(r.slice(2),t?2:8):Ud.test(r)?ks:+r}var ln=function(){return Is.Date.now()},Zd="Expected a function",qd=Math.max,Xd=Math.min;function Hd(r,e,t){var i,n,o,s,a,c,l=0,h=!1,u=!1,g=!0;if(typeof r!="function")throw new TypeError(Zd);e=js(e)||0,ci(t)&&(h=!!t.leading,u="maxWait"in t,o=u?qd(js(t.maxWait)||0,e):o,g="trailing"in t?!!t.trailing:g);function m(R){var I=i,T=n;return i=n=void 0,l=R,s=r.apply(T,I),s}function v(R){return l=R,a=setTimeout(_,e),h?m(R):s}function b(R){var I=R-c,T=R-l,f=e-I;return u?Xd(f,o-T):f}function E(R){var I=R-c,T=R-l;return c===void 0||I>=e||I<0||u&&T>=o}function _(){var R=ln();if(E(R))return S(R);a=setTimeout(_,b(R))}function S(R){return a=void 0,g&&i?m(R):(i=n=void 0,s)}function d(){a!==void 0&&clearTimeout(a),l=0,i=c=n=a=void 0}function p(){return a===void 0?s:S(ln())}function x(){var R=ln(),I=E(R);if(i=arguments,n=this,c=R,I){if(a===void 0)return v(c);if(u)return clearTimeout(a),a=setTimeout(_,e),m(c)}return a===void 0&&(a=setTimeout(_,e)),s}return x.cancel=d,x.flush=p,x}var Yd="Expected a function";function hn(r,e,t){var i=!0,n=!0;if(typeof r!="function")throw new TypeError(Yd);return ci(t)&&(i="leading"in t?!!t.leading:i,n="trailing"in t?!!t.trailing:n),Hd(r,e,{leading:i,maxWait:e,trailing:n})}const fr="#222222",li="#ffffff",et=4,Os=["#dff7fa","#c0eff5","#a1e7f0","#82dfeb","#63d8e6","#4facb8","#3b818a","#27565c","#132b2d"],Fs=["#d7d9ee","#b0b4de","#898ecd","#6269bd","#3b44ad","#2f368a","#232867","#171b45","#0b0d22"],Ds=["#f3dcf0","#e7b9e1","#dc97d2","#d074c3","#c552b5","#9d4190","#76316c","#4e2048","#271024"],Gs=["#ffddf1","#ffbbe3","#ff99d5","#ff77c7","#ff56ba","#cc4494","#99336f","#66224a","#321125"],Ns=["#ffe3d0","#ffc7a1","#ffab72","#ff8f43","#ff7415","#cc5c10","#99450c","#662e08","#321704"],Bs=["#fededf","#febebf","#fe9e9f","#fe7e7f","#fe5e60","#cb4b4c","#983839","#652526","#321213"],zs=["#e0f2e8","#c1e6d2","#a2d9bb","#83cda5","#64c18f","#509a72","#3c7355","#284d39","#13261c"],Us=["#fff3d9","#ffe8b3","#ffdd8d","#ffd267","#ffc742","#cc9f34","#997727","#664f1a","#32270d"],Vs=["#efefef","#e0e0e0","#d0d0d0","#c1c1c1","#b2b2b2","#8e8e8e","#6a6a6a","#474747","#232323"],tt={blue:Os,darkblue:Fs,purple:Ds,pink:Gs,orange:Ns,red:Bs,green:zs,yellow:Us,gray:Vs},Ws=Os[et],$s=Fs[et],Kd=Ds[et],un=Gs[et],Jd=Ns[et],dn=Bs[et],Zs=zs[et],qs=Us[et],Qd=Vs[et];function rt(r,e){return e.reduce((t,i,n)=>{const o=(n+1)*100,s=`${r}-${o}`;return t[s]=i,t},{})}({...rt("blue",tt.blue),...rt("darkblue",tt.darkblue),...rt("purple",tt.purple),...rt("pink",tt.pink),...rt("orange",tt.orange),...rt("red",tt.red),...rt("green",tt.green),...rt("yellow",tt.yellow),...rt("gray",tt.gray)});function Re(r,e,t){const i=r.createShader(e);if(i){if(r.shaderSource(i,t),r.compileShader(i),r.getShaderParameter(i,r.COMPILE_STATUS))return i;{const n=r.getShaderInfoLog(i);throw r.deleteShader(i),new Error("Failed to compile shader: "+n)}}else throw new Error("Failed to create shader")}function kt(r,e,t){const i=r.createProgram();if(i){if(r.attachShader(i,e),r.attachShader(i,t),r.linkProgram(i),r.getProgramParameter(i,r.LINK_STATUS))return i;{const n=r.getProgramInfoLog(i);throw r.deleteProgram(i),new Error("Failed to link program: "+n)}}else throw new Error("Failed to create program")}function ie(r,e,t,i,n){const o=r.createBuffer();if(!o)throw new Error("Failed to create buffer");r.bindBuffer(r.ARRAY_BUFFER,o),r.bufferData(r.ARRAY_BUFFER,t,r.STATIC_DRAW);const s=r.FLOAT,a=!1,c=0,l=0,h=r.getAttribLocation(e,n);return r.vertexAttribPointer(h,i,s,a,c,l),r.enableVertexAttribArray(h),o}function ef(r,e,t,i){let n=Number.POSITIVE_INFINITY,o=r.at(-1);for(const s of r){const a=Math.abs(Math.log2(s.scaleFactor)-(Math.log2(e+t)+i));a<n&&(n=a,o=s)}return o}function tf(r,e,t){const i=rf(r,e),n=nf(i),o=sf(n,e,t),s=wt(fe(r));return o.sort((a,c)=>Ys(a,s)-Ys(c,s)),o}function rf(r,e){return r.map(t=>[t[0]/e.originalWidth,t[1]/e.originalHeight])}function nf(r){const e={};for(let t=0;t<r.length;t++){const i=[r[t],r[(t+1)%r.length]];of(i).forEach(([n,o])=>{e[n]||(e[n]=[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]),o<e[n][0]&&(e[n][0]=o),o>e[n][1]&&(e[n][1]=o)})}return e}function of([r,e]){let t=Math.floor(r[0]),i=Math.floor(r[1]);const n=Math.floor(e[0]),o=Math.floor(e[1]),s=[[t,i]];if(t===n&&i===o)return s;const a=Math.sign(e[0]-r[0]),c=Math.sign(e[1]-r[1]),l=Math.abs(r[0]-t-Math.max(0,a)),h=Math.abs(r[1]-i-Math.max(0,c)),u=Math.abs(r[0]-e[0]),g=Math.abs(r[1]-e[1]);let m=l/u,v=h/g;const b=1/u,E=1/g;for(;!(t===n&&i===o);)m<v?(m=m+b,t=t+a):(v=v+E,i=i+c),s.push([t,i]);return s}function sf(r,e,t){const i=[];for(const n in r){const o=parseInt(n);if(o<0||o>=e.columns)break;const s=Math.max(r[o][0],0),a=Math.min(r[o][1],e.rows-1);for(let c=s;c<=a;c++)i.push({column:o,row:c,tileZoomLevel:e,imageSize:t})}return i}function Xs(r,e,t,i){let n=Math.floor(r.column*r.tileZoomLevel.scaleFactor/t);n=n>=0?n:0;const o=Math.ceil((r.column+1)*r.tileZoomLevel.scaleFactor/t);let s=Math.floor(r.row*r.tileZoomLevel.scaleFactor/t);s=s>=0?s:0;const a=Math.ceil((r.row+1)*r.tileZoomLevel.scaleFactor/t);return Hs(t,e,n,o,s,a,i)}function Hs(r,e,t,i,n,o,s=a=>!0){const a=e.tileZoomLevels.find(h=>h.scaleFactor==r),c=[e.width,e.height];if(!a)return[];t=t||0,i=i||a.columns,n=n||0,o=o||a.rows;const l=[];for(let h=t;h<i;h++)for(let u=n;u<o;u++){const g={column:h,row:u,tileZoomLevel:a,imageSize:c};s(g)&&l.push(g)}return l}function Ys(r,e){return ft(af(r),e)}function af(r){const e=Ks(r);return[(e[2]-e[0])/2+e[0],(e[3]-e[1])/2+e[1]]}function cf(r){const e=r.column*r.tileZoomLevel.originalWidth,t=r.row*r.tileZoomLevel.originalHeight;return[e,t]}function Ks(r){const e=cf(r),t=Math.min(e[0]+r.tileZoomLevel.originalWidth,r.imageSize[0]),i=Math.min(e[1]+r.tileZoomLevel.originalHeight,r.imageSize[1]);return[e[0],e[1],t,i]}function lf(r){return r.tileZoomLevel.width*r.tileZoomLevel.height}function hf(r){return r.map(e=>lf(e)).reduce((e,t)=>e+t,0)}function uf(r){return r.rows*r.width*r.columns*r.height}function df(r,e,t,i,n,o){const s=[],a=Qs(r,e,t,i,o);for(const c of a)c&&s.push(c);if(s.length==0){const c=Js(r,e,t,n,o);c&&s.push(c)}return s}function Js(r,e,t,i,n){const o=2**(Math.log2(t)+1);return o>e.tileZoomLevels.map(a=>a.scaleFactor).reduce((a,c)=>a+c,0)-t||i==0?void 0:ff(r,e,o,n)??Js(r,e,o,i--,n)}function Qs(r,e,t,i,n){const o=2**(Math.log2(t)-1);if(o<=0||i==0)return[];const s=ea(r,e,o,n),a=ea(r,e,o,c=>!0);return s.length==a.length?s:[...s,...Qs(r,e,o,i--,n)]}function ff(r,e,t,i){const n=Xs(r,e,t,i);if(n.length!=0)return n[0]}function ea(r,e,t,i){return Xs(r,e,t,i)}function pf(r){return gf(r.mapId,r.tileUrl)}function gf(r,e){return`${r}:${e}`}function fn(r){return mf(r.tileZoomLevel.scaleFactor,r.row,r.column)}function mf(r,e,t){return`${r}:${e}:${t}`}function vf(r,e,t){if(e.currentOverviewTileZoomLevel&&r.tileZoomLevel.scaleFactor==e.currentOverviewTileZoomLevel.scaleFactor)return!1;if(e.currentResourceViewportRingBbox==null||e.currentTileZoomLevel==null)return!0;const i=Math.log2(r.tileZoomLevel.scaleFactor)-Math.log2(e.currentTileZoomLevel.scaleFactor);return i>t.maxHigherLog2ScaleFactorDiff||-i>t.maxLowerLog2ScaleFactorDiff||!Qa(Nn(Ks(r),Math.max(0,i)),e.currentResourceViewportRingBbox)}const yf=200,wf={leading:!0,trailing:!0},_f=1,xf=1,bf=6,Tf=[...le(fr),1],Mf=0,Pf=[...le(li),1],Ef=16,Sf=[...le(fr),1],Rf=1,Af=[...le(li),1],If=5,Cf=1;function Lf(r,e,t,i){return(n,o,s)=>new kf(n,o,r,e,i,t,s)}class kf extends Td{gl;mapsProgram;linesProgram;pointsProgram;mapsVao=null;linesVao=null;pointsVao=null;lineLayers=[];pointLayers=[];cachedTilesByTileKey=new Map;cachedTilesByTileUrl=new Map;cachedTilesForTexture=[];previousCachedTilesForTexture=[];textureWidth=0;textureHeight=0;textureDepth=0;opacity=_f;saturation=xf;renderOptions={};cachedTilesTextureArray=null;cachedTilesResourcePositionsAndDimensionsTexture=null;cachedTilesScaleFactorsTexture=null;projectedGeoToClipTransform;throttledUpdateTextures;constructor(e,t,i,n,o,s,a){super(e,t,a),this.gl=i,this.initializeWebGL(n,o,s),this.throttledUpdateTextures=hn(this.updateTextures.bind(this),yf,wf)}initializeWebGL(e,t,i){this.mapsProgram=e,this.linesProgram=t,this.pointsProgram=i,this.mapsVao=this.gl.createVertexArray(),this.linesVao=this.gl.createVertexArray(),this.pointsVao=this.gl.createVertexArray(),this.cachedTilesTextureArray=this.gl.createTexture(),this.cachedTilesScaleFactorsTexture=this.gl.createTexture(),this.cachedTilesResourcePositionsAndDimensionsTexture=this.gl.createTexture()}updateVertexBuffers(e){this.projectedGeoToClipTransform=e,this.updateVertexBuffersMaps()}clearTextures(){this.throttledUpdateTextures()}addCachedTileAndUpdateTextures(e){this.cachedTilesByTileKey.set(e.tileKey,e),this.cachedTilesByTileUrl.set(e.tileUrl,e),this.throttledUpdateTextures()}removeCachedTileAndUpdateTextures(e){const t=this.cachedTilesByTileUrl.get(e);t&&this.cachedTilesByTileKey.delete(t.tileKey),this.cachedTilesByTileUrl.delete(e),this.throttledUpdateTextures()}cancelThrottledFunctions(){this.throttledUpdateTextures.cancel()}destroy(){this.gl.deleteVertexArray(this.mapsVao),this.gl.deleteVertexArray(this.linesVao),this.gl.deleteVertexArray(this.pointsVao),this.gl.deleteTexture(this.cachedTilesTextureArray),this.gl.deleteTexture(this.cachedTilesScaleFactorsTexture),this.gl.deleteTexture(this.cachedTilesResourcePositionsAndDimensionsTexture),this.cancelThrottledFunctions(),super.destroy()}setLineLayers(){this.lineLayers=[{projectedGeoLines:On(this.projectedGeoLongerMask),projectedGeoPreviousLines:On(this.projectedGeoPreviousLongerMask),viewportSize:8,color:[...le(un),1]},{projectedGeoLines:jn(this.projectedGeoPoints,this.projectedGeoTransformedResourcePoints),projectedGeoPreviousLines:jn(this.projectedGeoPoints,this.projectedGeoPreviousTransformedResourcePoints),color:[...le(fr),1],borderColor:[...le(li),1]}]}setPointLayers(){this.pointLayers=[{projectedGeoPoints:this.projectedGeoPoints,color:[...le(Ws),1]},{projectedGeoPoints:this.projectedGeoTransformedResourcePoints,projectedGeoPreviousPoints:this.projectedGeoPreviousTransformedResourcePoints,color:[...le(un),1]}]}updateVertexBuffersMaps(){if(!this.mapsVao||!this.projectedGeoToClipTransform)return;const e=this.gl,t=this.mapsProgram;e.bindVertexArray(this.mapsVao),ie(e,t,new Float32Array(this.resourceTrianglePoints.flat()),2,"a_resourceTrianglePoint");const i=this.projectedGeoPreviousTrianglePoints.map(s=>dt(this.projectedGeoToClipTransform,s));ie(e,t,new Float32Array(i.flat()),2,"a_clipPreviousTrianglePoint");const n=this.projectedGeoTrianglePoints.map(s=>dt(this.projectedGeoToClipTransform,s));ie(e,t,new Float32Array(n.flat()),2,"a_clipTrianglePoint"),ie(e,t,new Float32Array(this.previousTrianglePointsDistortion),1,"a_previousTrianglePointDistortion"),ie(e,t,new Float32Array(this.trianglePointsDistortion),1,"a_trianglePointDistortion");const o=new Float32Array(this.resourceTrianglePoints.length).map((s,a)=>a);ie(e,t,o,1,"a_trianglePointIndex")}updateVertexBuffersLines(){if(!this.linesVao)return;const e=this.gl,t=this.linesProgram;e.bindVertexArray(this.linesVao),this.setLineLayers();const i=this.lineLayers.reduce((m,v)=>m.concat(v.projectedGeoLines),[]).map(m=>[m[0],m[0],m[0],m[1],m[1],m[1]]).flat();ie(e,t,new Float32Array(i.flat()),2,"a_projectedGeoPoint");const n=this.lineLayers.reduce((m,v)=>m.concat(v.projectedGeoLines),[]).map(m=>[m[1],m[1],m[1],m[0],m[0],m[0]]).flat();ie(e,t,new Float32Array(n.flat()),2,"a_projectedGeoOtherPoint");const o=this.lineLayers.reduce((m,v)=>m.concat(v.projectedGeoPreviousLines||v.projectedGeoLines),[]).map(m=>[m[0],m[0],m[0],m[1],m[1],m[1]]).flat();ie(e,t,new Float32Array(o.flat()),2,"a_projectedGeoPreviousPoint");const s=this.lineLayers.reduce((m,v)=>m.concat(v.projectedGeoPreviousLines||v.projectedGeoLines),[]).map(m=>[m[1],m[1],m[1],m[0],m[0],m[0]]).flat();ie(e,t,new Float32Array(s.flat()),2,"a_projectedGeoPreviousOtherPoint");const a=this.lineLayers.reduce((m,v)=>m.concat(v.projectedGeoLines.flatMap(b=>[0,0,1,0,0,1])),[]);ie(e,t,new Float32Array(a),1,"a_isOtherPoint");const c=this.lineLayers.reduce((m,v)=>m.concat(v.projectedGeoLines.flatMap(b=>[1,-1,1,1,-1,1])),[]);ie(e,t,new Float32Array(c),1,"a_normalSign");const l=this.lineLayers.reduce((m,v)=>m.concat(v.projectedGeoLines.flatMap(b=>Array(6).fill(Object.prototype.hasOwnProperty.call(v,"viewportSize")?v.viewportSize:bf))),[]);ie(e,t,new Float32Array(l),1,"a_viewportSize");const h=this.lineLayers.reduce((m,v)=>m.concat(v.projectedGeoLines.flatMap(b=>Array(6).fill(Object.prototype.hasOwnProperty.call(v,"color")?v.color:Tf))),[]);ie(e,t,new Float32Array(h.flat()),4,"a_color");const u=this.lineLayers.reduce((m,v)=>m.concat(v.projectedGeoLines.flatMap(b=>Array(6).fill(v.viewportBorderSize||Mf))),[]);ie(e,t,new Float32Array(u),1,"a_viewportBorderSize");const g=this.lineLayers.reduce((m,v)=>m.concat(v.projectedGeoLines.flatMap(b=>Array(6).fill(Object.prototype.hasOwnProperty.call(v,"borderColor")?v.borderColor:Pf))),[]);ie(e,t,new Float32Array(g.flat()),4,"a_borderColor")}updateVertexBuffersPoints(){if(!this.pointsVao)return;const e=this.gl,t=this.pointsProgram;e.bindVertexArray(this.pointsVao),this.setPointLayers();const i=this.pointLayers.reduce((l,h)=>l.concat(h.projectedGeoPoints),[]);ie(e,t,new Float32Array(i.flat()),2,"a_projectedGeoPoint");const n=this.pointLayers.reduce((l,h)=>l.concat(h.projectedGeoPreviousPoints||h.projectedGeoPoints),[]);ie(e,t,new Float32Array(n.flat()),2,"a_projectedGeoPreviousPoint");const o=this.pointLayers.reduce((l,h)=>l.concat(h.projectedGeoPoints.map(u=>Object.prototype.hasOwnProperty.call(h,"viewportSize")?h.viewportSize:Ef)),[]);ie(e,t,new Float32Array(o),1,"a_viewportSize");const s=this.pointLayers.reduce((l,h)=>l.concat(h.projectedGeoPoints.map(u=>Object.prototype.hasOwnProperty.call(h,"color")?h.color:Sf)),[]);ie(e,t,new Float32Array(s.flat()),4,"a_color");const a=this.pointLayers.reduce((l,h)=>l.concat(h.projectedGeoPoints.map(u=>h.viewportBorderSize||Rf)),[]);ie(e,t,new Float32Array(a),1,"a_viewportBorderSize");const c=this.pointLayers.reduce((l,h)=>l.concat(h.projectedGeoPoints.map(u=>Object.prototype.hasOwnProperty.call(h,"borderColor")?h.borderColor:Af)),[]);ie(e,t,new Float32Array(c.flat()),4,"a_borderColor")}async updateTextures(){const e=this.gl;if(this.updateCachedTilesForTextures(),this.cachedTilesForTexture.length!=0&&nc(this.previousCachedTilesForTexture.map(a=>a.tileUrl),this.cachedTilesForTexture.map(a=>a.tileUrl)))return;const t=Math.max(...this.parsedImage.tileZoomLevels.map(a=>a.width)),i=Math.max(...this.parsedImage.tileZoomLevels.map(a=>a.height)),n=this.cachedTilesForTexture.length;e.pixelStorei(e.UNPACK_ALIGNMENT,4),e.bindTexture(e.TEXTURE_2D_ARRAY,this.cachedTilesTextureArray),e.texImage3D(e.TEXTURE_2D_ARRAY,0,e.RGBA,t,i,n,0,e.RGBA,e.UNSIGNED_BYTE,null);for(let a=0;a<this.cachedTilesForTexture.length;a++){const c=this.cachedTilesForTexture[a].data;e.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,a,c.width,c.height,1,e.RGBA,e.UNSIGNED_BYTE,c)}e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const o=this.cachedTilesForTexture.map(a=>{if(a&&a.imageRequest&&a.imageRequest.region)return[a.imageRequest.region.x,a.imageRequest.region.y,a.imageRequest.region.width,a.imageRequest.region.height]});e.bindTexture(e.TEXTURE_2D,this.cachedTilesResourcePositionsAndDimensionsTexture),e.texImage2D(e.TEXTURE_2D,0,e.R32I,1,this.cachedTilesForTexture.length*4,0,e.RED_INTEGER,e.INT,new Int32Array(o.flat())),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const s=this.cachedTilesForTexture.map(a=>a.tile.tileZoomLevel.scaleFactor);e.bindTexture(e.TEXTURE_2D,this.cachedTilesScaleFactorsTexture),e.texImage2D(e.TEXTURE_2D,0,e.R32I,1,this.cachedTilesForTexture.length,0,e.RED_INTEGER,e.INT,new Int32Array(s)),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),this.dispatchEvent(new N(C.TEXTURESUPDATED))}updateCachedTilesForTextures(){const e=[],t=[],i=[];for(const s of this.currentFetchableTiles){const a=this.cachedTilesByTileUrl.get(s.tileUrl);if(a)e.push(a);else for(const c of this.getCachedTilesAtOtherScaleFactors(s.tile))t.push(c)}for(const s of this.currentOverviewFetchableTiles){const a=this.cachedTilesByTileUrl.get(s.tileUrl);if(a){const c=this.currentTileZoomLevel?this.currentTileZoomLevel.rows*this.currentTileZoomLevel.columns:void 0;(e.length==0||c&&e.length<c)&&i.push(a)}}let n=[...e,...t,...i];const o=new Map;n.forEach(s=>o.set(s.tileUrl,s)),n=[...o.values()],this.previousCachedTilesForTexture=this.cachedTilesForTexture,this.cachedTilesForTexture=n}getCachedTilesAtOtherScaleFactors(e){if(this.cachedTilesByTileUrl.size==0)return[];const t=[];for(e of df(e,this.parsedImage,this.currentBestScaleFactor,Cf,If,this.tileInCachedTiles.bind(this))){const i=this.tileToCachedTile(e);if(i)t.push(i);else throw new Error("Tile supposed to be in cache isn't.")}return t}tileToCachedTile(e){return this.cachedTilesByTileKey.get(fn(e))}tileInCachedTiles(e){return this.cachedTilesByTileKey.has(fn(e))}}const jf=y.string().or(y.number()).or(y.boolean()),Of=y.record(y.string(),jf.array()),ut=y.tuple([y.number(),y.number()]),ta=y.object({type:y.literal("Point"),coordinates:ut}),ra=ut.array().min(3),pr=y.enum(["ImageService1","ImageService2","ImageService3"]),hi=y.object({id:y.string().url(),type:y.string(),label:Of.optional()}).extend({partOf:y.lazy(()=>hi.array()).optional()}),ui=y.union([y.any(),y.object({type:y.enum(["helmert","polynomial","thinPlateSpline","projective"]).or(y.string()),options:y.object({}).optional()})]).transform(r=>{if(r&&typeof r=="object"&&"type"in r)return r}),di=y.union([y.string().url().array(),y.string().url()]),Ff=/^<svg\s+width="\d+"\s+height="\d+"\s*>\s*<polygon\s+points="\s*(-?\d+(\.\d+)?,-?\d+(\.\d+)?\s+){2,}-?\d+(\.\d+)?,-?\d+(\.\d+)?\s*"\s*\/>\s*<\/svg>$/,Df=y.object({type:y.literal("SvgSelector"),value:y.string().regex(Ff)}),Gf=y.object({source:y.string().url(),service:y.array(y.object({"@id":y.string().url(),type:pr})).length(1),selector:Df}),ia=y.object({pixelCoords:ut}),Nf=y.object({type:y.literal("FeatureCollection"),transformation:ui.optional(),features:y.array(y.object({type:y.literal("Feature"),properties:ia,geometry:ta}))}),pn=y.object({id:y.string().optional(),type:y.literal("Annotation"),"@context":di.optional(),motivation:y.string().default("georeferencing").optional(),target:Gf,body:Nf}),na=y.object({id:y.string().optional(),type:y.literal("AnnotationPage"),"@context":di.optional(),items:y.array(pn)}),gn=/<polygon\s+points="\s*(-?\d+(\.\d+)?,-?\d+(\.\d+)?\s+){2,}-?\d+(\.\d+)?,-?\d+(\.\d+)?\s*"\s*\/>/,Bf=new RegExp(`^<svg\\s+width="\\d+"\\s+height="\\d+"\\s*>\\s*${gn.source}\\s*</svg>$`),zf=new RegExp(`^<svg\\s+height="\\d+"\\s+width="\\d+"\\s*>\\s*${gn.source}\\s*</svg>$`),Uf=new RegExp(`^<svg\\s*>\\s*${gn.source}\\s*</svg>$`),Vf=y.string().regex(Uf),Wf=y.string().regex(Bf),$f=y.string().regex(zf),Zf=y.object({type:y.literal("SvgSelector"),value:Vf.or(Wf).or($f)}),qf=y.object({"@id":y.string().url(),type:pr,height:y.number().positive(),width:y.number().positive(),partOf:hi.array().optional()}),Xf=y.object({id:y.string().url(),type:pr,height:y.number().positive(),width:y.number().positive(),partOf:hi.array().optional()}),Hf=y.object({type:y.literal("SpecificResource"),source:qf.or(Xf),selector:Zf}),oa=y.object({resourceCoords:ut}),Yf=y.object({type:y.literal("FeatureCollection"),transformation:ui.optional(),features:y.array(y.object({type:y.literal("Feature"),properties:oa,geometry:ta}))}),mn=y.object({id:y.string().optional(),type:y.literal("Annotation"),"@context":di.optional(),motivation:y.string().default("georeferencing").optional(),created:y.string().datetime().optional(),modified:y.string().datetime().optional(),target:Hf,body:Yf}),sa=y.object({id:y.string().optional(),type:y.literal("AnnotationPage"),"@context":di.optional(),items:y.array(mn)});pn.or(mn),na.or(sa),ia.or(oa);function aa(r){return Array.isArray(r)}function Kf(r){return!!(r&&typeof r=="object"&&"type"in r&&r.type==="AnnotationPage")}function fi(r){return!!(r&&typeof r=="object"&&"type"in r&&r.type==="GeoreferencedMap")}function ca(r){return!!(r&&typeof r=="object"&&"target"in r&&r.target&&typeof r.target=="object"&&"source"in r.target&&typeof r.target.source=="string")}function pi(r){return"type"in r&&r.type==="GeoreferencedMap"}function gi(r){return"source"in r.target&&typeof r.target.source=="object"}function Jf(r){return{id:Qf(r),...op(r),type:ep(r),partOf:tp(r)}}function Qf(r){if(gi(r)){const e=r.target.source;return"id"in e?e.id:e["@id"]}else return r.target.service[0]["@id"]}function ep(r){return"service"in r.target?r.target.service[0].type:r.target.source.type}function tp(r){if(gi(r))return r.target.source.partOf}function rp(r){return"pixelCoords"in r?r.pixelCoords:r.resourceCoords}function ip(r){return r.body.features.map(e=>({resource:rp(e.properties),geo:e.geometry.coordinates}))}function np(r){if(gi(r))return{created:r.created,modified:r.modified}}function op(r){if(gi(r))return{width:r.target.source.width,height:r.target.source.height};const t=r.target.selector.value,i=/width="(?<width>\d+)"/.exec(t),n=/height="(?<height>\d+)"/.exec(t),o=i?.groups?.width,s=n?.groups?.height;if(!o||!s)throw new Error("Could not parse image dimensions");return{width:parseInt(o),height:parseInt(s)}}function sp(r){const t=r.target.selector.value,n=/points="(?<points>.+)"/.exec(t)?.groups;if(n&&n.points){const o=n.points.trim().split(/\s+/);if(o[0]===o[o.length-1]&&o.splice(-1),o.length>=3)return o.map(s=>{const a=s.split(",");if(a.length===2)return[parseFloat(a[0]),parseFloat(a[1])];throw new Error("Could not parse resource mask")});throw new Error("Could not parse resource mask")}else throw new Error("Could not parse resource mask")}function la(r){return{"@context":"https://schemas.allmaps.org/map/2/context.json",type:"GeoreferencedMap",id:r.id,...np(r),resource:Jf(r),gcps:ip(r),resourceMask:sp(r),transformation:r.body.transformation}}function vn(r){if(Kf(r)){let e;return"items"in r&&Array.isArray(r.items)&&ca(r.items[0])?e=na.parse(r):e=sa.parse(r),e.items.map(t=>la(t))}else{let e;return ca(r)?e=pn.parse(r):e=mn.parse(r),[la(e)]}}const ha=y.object({image:ut,world:ut}),ap=y.object({uri:y.string().url(),width:y.number(),height:y.number(),type:pr}),mi=y.object({id:y.string().optional(),version:y.number().min(1).max(1).default(1),image:ap,gcps:ha.array(),pixelMask:ra,transformation:ui.optional()}),yn=y.array(mi),ua=y.object({resource:ut,geo:ut}),cp=y.object({id:y.string().url(),width:y.number(),height:y.number(),type:pr,partOf:hi.array().optional()}),vi=y.object({"@context":y.literal("https://schemas.allmaps.org/map/2/context.json").optional(),type:y.literal("GeoreferencedMap"),id:y.string().optional(),created:y.string().datetime().optional(),modified:y.string().datetime().optional(),resource:cp,gcps:ua.array(),resourceMask:ra,transformation:ui.optional()}),wn=y.array(vi);mi.or(vi),yn.or(wn),ha.or(ua);function lp(r){let e,t,i;return pi(r)?(e=r.resource.width,t=r.resource.height,i=r.resourceMask):(e=r.image.width,t=r.image.height,i=r.pixelMask),{type:"SvgSelector",value:`<svg width="${e}" height="${t}"><polygon points="${i.map(n=>n.join(",")).join(" ")}" /></svg>`}}function hp(r){let e,t,i,n,o;return pi(r)?(e=r.resource.id,t=r.resource.type,i=r.resource.width,n=r.resource.height,o=r.resource.partOf):(e=r.image.uri,t=r.image.type,i=r.image.width,n=r.image.height),{id:e,type:t,height:n,width:i,partOf:o}}function up(r){if(pi(r))return{created:r.created,modified:r.modified}}function dp(){return["http://iiif.io/api/extension/georef/1/context.json","http://iiif.io/api/presentation/3/context.json"]}function fp(r){let e,t;return"resource"in r?(e=r.resource,t=r.geo):(e=r.image,t=r.world),{type:"Feature",properties:{resourceCoords:e},geometry:{type:"Point",coordinates:t}}}function da(r){const e={type:"SpecificResource",source:hp(r),selector:lp(r)},t={type:"FeatureCollection",transformation:r.transformation,features:r.gcps.map(i=>fp(i))};return{id:r.id,type:"Annotation","@context":dp(),...up(r),motivation:"georeferencing",target:e,body:t}}function pp(r){if(aa(r)){let e;return fi(r[0])?e=wn.parse(r):e=yn.parse(r),{type:"AnnotationPage","@context":"http://www.w3.org/ns/anno.jsonld",items:e.map(i=>da(i))}}else{let e;return fi(r)?e=vi.parse(r):e=mi.parse(r),da(e)}}function fa(r){return pi(r)?r:vn(pp(r))[0]}function gp(r){return r.map(fa)}function pa(r){if(aa(r)){let e;return fi(r[0])?e=wn.parse(r):e=yn.parse(r),gp(e)}else{let e;return fi(r)?e=vi.parse(r):e=mi.parse(r),fa(e)}}function mp(r,e,t,i,n){ga(r,e,t||0,i||r.length-1,n||vp)}function ga(r,e,t,i,n){for(;i>t;){if(i-t>600){var o=i-t+1,s=e-t+1,a=Math.log(o),c=.5*Math.exp(2*a/3),l=.5*Math.sqrt(a*c*(o-c)/o)*(s-o/2<0?-1:1),h=Math.max(t,Math.floor(e-s*c/o+l)),u=Math.min(i,Math.floor(e+(o-s)*c/o+l));ga(r,e,h,u,n)}var g=r[e],m=t,v=i;for(gr(r,t,e),n(r[i],g)>0&&gr(r,t,i);m<v;){for(gr(r,m,v),m++,v--;n(r[m],g)<0;)m++;for(;n(r[v],g)>0;)v--}n(r[t],g)===0?gr(r,t,v):(v++,gr(r,v,i)),v<=e&&(t=v+1),e<=v&&(i=v-1)}}function gr(r,e,t){var i=r[e];r[e]=r[t],r[t]=i}function vp(r,e){return r<e?-1:r>e?1:0}class yp{constructor(e=9){this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(e){let t=this.data;const i=[];if(!wi(e,t))return i;const n=this.toBBox,o=[];for(;t;){for(let s=0;s<t.children.length;s++){const a=t.children[s],c=t.leaf?n(a):a;wi(e,c)&&(t.leaf?i.push(a):xn(e,c)?this._all(a,i):o.push(a))}t=o.pop()}return i}collides(e){let t=this.data;if(!wi(e,t))return!1;const i=[];for(;t;){for(let n=0;n<t.children.length;n++){const o=t.children[n],s=t.leaf?this.toBBox(o):o;if(wi(e,s)){if(t.leaf||xn(e,s))return!0;i.push(o)}}t=i.pop()}return!1}load(e){if(!(e&&e.length))return this;if(e.length<this._minEntries){for(let i=0;i<e.length;i++)this.insert(e[i]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(!this.data.children.length)this.data=t;else if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){const i=this.data;this.data=t,t=i}this._insert(t,this.data.height-t.height-1,!0)}return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=Ot([]),this}remove(e,t){if(!e)return this;let i=this.data;const n=this.toBBox(e),o=[],s=[];let a,c,l;for(;i||o.length;){if(i||(i=o.pop(),c=o[o.length-1],a=s.pop(),l=!0),i.leaf){const h=wp(e,i.children,t);if(h!==-1)return i.children.splice(h,1),o.push(i),this._condense(o),this}!l&&!i.leaf&&xn(i,n)?(o.push(i),s.push(a),a=0,c=i,i=i.children[0]):c?(a++,i=c.children[a],l=!1):i=null}return this}toBBox(e){return e}compareMinX(e,t){return e.minX-t.minX}compareMinY(e,t){return e.minY-t.minY}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){const i=[];for(;e;)e.leaf?t.push(...e.children):i.push(...e.children),e=i.pop();return t}_build(e,t,i,n){const o=i-t+1;let s=this._maxEntries,a;if(o<=s)return a=Ot(e.slice(t,i+1)),jt(a,this.toBBox),a;n||(n=Math.ceil(Math.log(o)/Math.log(s)),s=Math.ceil(o/Math.pow(s,n-1))),a=Ot([]),a.leaf=!1,a.height=n;const c=Math.ceil(o/s),l=c*Math.ceil(Math.sqrt(s));ma(e,t,i,l,this.compareMinX);for(let h=t;h<=i;h+=l){const u=Math.min(h+l-1,i);ma(e,h,u,c,this.compareMinY);for(let g=h;g<=u;g+=c){const m=Math.min(g+c-1,u);a.children.push(this._build(e,g,m,n-1))}}return jt(a,this.toBBox),a}_chooseSubtree(e,t,i,n){for(;n.push(t),!(t.leaf||n.length-1===i);){let o=1/0,s=1/0,a;for(let c=0;c<t.children.length;c++){const l=t.children[c],h=_n(l),u=bp(e,l)-h;u<s?(s=u,o=h<o?h:o,a=l):u===s&&h<o&&(o=h,a=l)}t=a||t.children[0]}return t}_insert(e,t,i){const n=i?e:this.toBBox(e),o=[],s=this._chooseSubtree(n,this.data,t,o);for(s.children.push(e),vr(s,n);t>=0&&o[t].children.length>this._maxEntries;)this._split(o,t),t--;this._adjustParentBBoxes(n,o,t)}_split(e,t){const i=e[t],n=i.children.length,o=this._minEntries;this._chooseSplitAxis(i,o,n);const s=this._chooseSplitIndex(i,o,n),a=Ot(i.children.splice(s,i.children.length-s));a.height=i.height,a.leaf=i.leaf,jt(i,this.toBBox),jt(a,this.toBBox),t?e[t-1].children.push(a):this._splitRoot(i,a)}_splitRoot(e,t){this.data=Ot([e,t]),this.data.height=e.height+1,this.data.leaf=!1,jt(this.data,this.toBBox)}_chooseSplitIndex(e,t,i){let n,o=1/0,s=1/0;for(let a=t;a<=i-t;a++){const c=mr(e,0,a,this.toBBox),l=mr(e,a,i,this.toBBox),h=Tp(c,l),u=_n(c)+_n(l);h<o?(o=h,n=a,s=u<s?u:s):h===o&&u<s&&(s=u,n=a)}return n||i-t}_chooseSplitAxis(e,t,i){const n=e.leaf?this.compareMinX:_p,o=e.leaf?this.compareMinY:xp,s=this._allDistMargin(e,t,i,n),a=this._allDistMargin(e,t,i,o);s<a&&e.children.sort(n)}_allDistMargin(e,t,i,n){e.children.sort(n);const o=this.toBBox,s=mr(e,0,t,o),a=mr(e,i-t,i,o);let c=yi(s)+yi(a);for(let l=t;l<i-t;l++){const h=e.children[l];vr(s,e.leaf?o(h):h),c+=yi(s)}for(let l=i-t-1;l>=t;l--){const h=e.children[l];vr(a,e.leaf?o(h):h),c+=yi(a)}return c}_adjustParentBBoxes(e,t,i){for(let n=i;n>=0;n--)vr(t[n],e)}_condense(e){for(let t=e.length-1,i;t>=0;t--)e[t].children.length===0?t>0?(i=e[t-1].children,i.splice(i.indexOf(e[t]),1)):this.clear():jt(e[t],this.toBBox)}}function wp(r,e,t){if(!t)return e.indexOf(r);for(let i=0;i<e.length;i++)if(t(r,e[i]))return i;return-1}function jt(r,e){mr(r,0,r.children.length,e,r)}function mr(r,e,t,i,n){n||(n=Ot(null)),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(let o=e;o<t;o++){const s=r.children[o];vr(n,r.leaf?i(s):s)}return n}function vr(r,e){return r.minX=Math.min(r.minX,e.minX),r.minY=Math.min(r.minY,e.minY),r.maxX=Math.max(r.maxX,e.maxX),r.maxY=Math.max(r.maxY,e.maxY),r}function _p(r,e){return r.minX-e.minX}function xp(r,e){return r.minY-e.minY}function _n(r){return(r.maxX-r.minX)*(r.maxY-r.minY)}function yi(r){return r.maxX-r.minX+(r.maxY-r.minY)}function bp(r,e){return(Math.max(e.maxX,r.maxX)-Math.min(e.minX,r.minX))*(Math.max(e.maxY,r.maxY)-Math.min(e.minY,r.minY))}function Tp(r,e){const t=Math.max(r.minX,e.minX),i=Math.max(r.minY,e.minY),n=Math.min(r.maxX,e.maxX),o=Math.min(r.maxY,e.maxY);return Math.max(0,n-t)*Math.max(0,o-i)}function xn(r,e){return r.minX<=e.minX&&r.minY<=e.minY&&e.maxX<=r.maxX&&e.maxY<=r.maxY}function wi(r,e){return e.minX<=r.maxX&&e.minY<=r.maxY&&e.maxX>=r.minX&&e.maxY>=r.minY}function Ot(r){return{children:r,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function ma(r,e,t,i,n){const o=[e,t];for(;o.length;){if(t=o.pop(),e=o.pop(),t-e<=i)continue;const s=e+Math.ceil((t-e)/i/2)*i;mp(r,s,e,t,n),o.push(e,s,s,t)}}function Mp(r,e,t){if(t===void 0&&(t={}),!r)throw new Error("point is required");if(!e)throw new Error("polygon is required");var i=Et(r),n=Kl(e),o=n.type,s=e.bbox,a=n.coordinates;if(s&&Pp(i,s)===!1)return!1;o==="Polygon"&&(a=[a]);for(var c=!1,l=0;l<a.length&&!c;l++)if(va(i,a[l][0],t.ignoreBoundary)){for(var h=!1,u=1;u<a[l].length&&!h;)va(i,a[l][u],!t.ignoreBoundary)&&(h=!0),u++;h||(c=!0)}return c}function va(r,e,t){var i=!1;e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]&&(e=e.slice(0,e.length-1));for(var n=0,o=e.length-1;n<e.length;o=n++){var s=e[n][0],a=e[n][1],c=e[o][0],l=e[o][1],h=r[1]*(s-c)+a*(c-r[0])+l*(r[0]-s)===0&&(s-r[0])*(c-r[0])<=0&&(a-r[1])*(l-r[1])<=0;if(h)return!t;var u=a>r[1]!=l>r[1]&&r[0]<(c-s)*(r[1]-a)/(l-a)+s;u&&(i=!i)}return i}function Pp(r,e){return e[0]<=r[0]&&e[1]<=r[1]&&e[2]>=r[0]&&e[3]>=r[1]}const Ep=!0;class Sp{rbush=new yp;polygonsById=new Map;bboxesById=new Map;itemsById=new Map;addItem(e,t){this.removeItem(e);const i=fe(t),n={minX:i[0],minY:i[1],maxX:i[2],maxY:i[3],id:e};this.polygonsById.set(e,t),this.bboxesById.set(e,i),this.itemsById.set(e,n),this.rbush.insert(n)}removeItem(e){const t=this.itemsById.get(e);t&&(this.rbush.remove(t),this.polygonsById.delete(e),this.bboxesById.delete(e),this.itemsById.delete(e))}clear(){this.polygonsById.clear(),this.bboxesById.clear(),this.itemsById.clear(),this.rbush.clear()}search(e,t,i,n){return this.rbush.search({minX:e,minY:t,maxX:i,maxY:n})}getBbox(e){return this.bboxesById.get(e)}getPolygon(e){return this.polygonsById.get(e)}searchFromBbox(e){const[t,i,n,o]=e;return this.search(t,i,n,o).map(s=>s.id)}searchFromPoint(e,t=Ep){const[i,n,o,s]=[e[0],e[1],e[0],e[1]],a=this.search(i,n,o,s);return t?a.filter(c=>{const l=this.polygonsById.get(c.id);return l?Mp(e,l):!1}).map(c=>c.id):a.map(c=>c.id)}}function Rp(){return{createRTree:!0,imageInformations:new Map}}class Ap extends EventTarget{warpedMapFactory;warpedMapsById=new Map;zIndices=new Map;rtree;imageInformations;transformation;fetchFn;constructor(e,t){super(),this.warpedMapFactory=e,t={...Rp(),...t},this.fetchFn=t?.fetchFn,this.imageInformations=t.imageInformations,this.transformation=t.transformation,t.createRTree&&(this.rtree=new Sp)}getMapIds(){return this.warpedMapsById.keys()}getWarpedMaps(e){if(e===void 0)return this.warpedMapsById.values();{const t=[];for(const i of e){const n=this.warpedMapsById.get(i);n&&t.push(n)}return t}}getWarpedMap(e){return this.warpedMapsById.get(e)}getMapZIndex(e){return this.zIndices.get(e)}getCenter(){const e=this.getBbox();if(e)return wt(e)}getProjectedCenter(){const e=this.getProjectedBbox();if(e)return wt(e)}getBbox(){let e;for(const t of this.getWarpedMaps())t.visible&&(e?e=Gn(e,t.geoMaskBbox):e=t.geoMaskBbox);return e}getProjectedBbox(){let e;for(const t of this.getWarpedMaps())t.visible&&(e?e=Gn(e,t.projectedGeoMaskBbox):e=t.projectedGeoMaskBbox);return e}getMapsByGeoBbox(e){return this.rtree?this.rtree.searchFromBbox(e):Array.from(this.warpedMapsById.keys())}setImageInformations(e){this.imageInformations=e}setMapResourceMask(e,t){const i=this.warpedMapsById.get(e);i&&(i.setResourceMask(t),this.addToOrUpdateRtree(i),this.dispatchEvent(new N(C.RESOURCEMASKUPDATED,e)))}setMapsTransformationType(e,t){const i=[];for(const n of e){const o=this.warpedMapsById.get(n);o&&o.transformationType!=t&&i.push(n)}i.length>0&&(this.dispatchEvent(new N(C.PRECHANGE,i)),i.forEach(n=>{const o=this.warpedMapsById.get(n);o&&(o.setTransformationType(t),this.addToOrUpdateRtree(o))}),this.dispatchEvent(new N(C.TRANSFORMATIONCHANGED,i)))}setMapsDistortionMeasure(e,t){const i=[];for(const n of e){const o=this.warpedMapsById.get(n);o&&o.distortionMeasure!=t&&i.push(n)}i.length>0&&(this.dispatchEvent(new N(C.PRECHANGE,i)),i.forEach(n=>{const o=this.warpedMapsById.get(n);o&&(o.setDistortionMeasure(t),this.addToOrUpdateRtree(o))}),this.dispatchEvent(new N(C.DISTORTIONCHANGED,i)))}bringMapsToFront(e){let t=this.warpedMapsById.size;for(const i of e)this.zIndices.has(i)&&(this.zIndices.set(i,t),t++);this.removeZIndexHoles(),this.dispatchEvent(new N(C.ZINDICESCHANGED))}sendMapsToBack(e){let t=-Array.from(e).length;for(const i of e)this.zIndices.has(i)&&(this.zIndices.set(i,t),t++);this.removeZIndexHoles(),this.dispatchEvent(new N(C.ZINDICESCHANGED))}bringMapsForward(e){for(const[t,i]of this.zIndices.entries())this.zIndices.set(t,i*2);for(const t of e){const i=this.zIndices.get(t);i!==void 0&&this.zIndices.set(t,i+3)}this.removeZIndexHoles(),this.dispatchEvent(new N(C.ZINDICESCHANGED))}sendMapsBackward(e){for(const[t,i]of this.zIndices.entries())this.zIndices.set(t,i*2);for(const t of e){const i=this.zIndices.get(t);i!==void 0&&this.zIndices.set(t,i-3)}this.removeZIndexHoles(),this.dispatchEvent(new N(C.ZINDICESCHANGED))}showMaps(e){for(const t of e){const i=this.warpedMapsById.get(t);i&&(i.visible=!0)}this.dispatchEvent(new N(C.VISIBILITYCHANGED,e))}hideMaps(e){for(const t of e){const i=this.warpedMapsById.get(t);i&&(i.visible=!1)}this.dispatchEvent(new N(C.VISIBILITYCHANGED,e))}async addGeoreferencedMap(e){const t=pa(e),i=Array.isArray(t)?t[0]:t;return this.addGeoreferencedMapInternal(i)}async removeGeoreferencedMap(e){const t=pa(e),i=Array.isArray(t)?t[0]:t;return this.removeGeoreferencedMapInternal(i)}async addGeoreferenceAnnotation(e){const t=[],i=vn(e),n=await Promise.allSettled(i.map(o=>this.addGeoreferencedMapInternal(o)));for(const o of n)o.status==="fulfilled"?t.push(o.value):t.push(o.reason);return this.dispatchEvent(new N(C.GEOREFERENCEANNOTATIONADDED)),this.dispatchEvent(new N(C.ZINDICESCHANGED)),t}async removeGeoreferenceAnnotation(e){const t=[],i=vn(e);for(const n of i){const o=await this.removeGeoreferencedMapInternal(n);t.push(o)}return this.dispatchEvent(new N(C.GEOREFERENCEANNOTATIONREMOVED)),t}clear(){this.warpedMapsById=new Map,this.zIndices=new Map,this.rtree?.clear(),this.dispatchEvent(new N(C.CLEARED))}destroy(){for(const e of this.getWarpedMaps())this.removeEventListenersFromWarpedMap(e),e.destroy();this.clear()}async addGeoreferencedMapInternal(e){const t=await this.getOrComputeMapId(e),i=this.warpedMapFactory(t,e,{imageInformations:this.imageInformations,fetchFn:this.fetchFn,transformation:this.transformation});return this.warpedMapsById.set(t,i),this.zIndices.set(t,this.warpedMapsById.size-1),this.addToOrUpdateRtree(i),this.addEventListenersToWarpedMap(i),this.dispatchEvent(new N(C.WARPEDMAPADDED,t)),t}async removeGeoreferencedMapInternal(e){const t=await this.getOrComputeMapId(e),i=this.warpedMapsById.get(t);if(i)this.warpedMapsById.delete(t),this.zIndices.delete(t),this.removeFromRtree(i),this.dispatchEvent(new N(C.WARPEDMAPREMOVED,t)),this.removeZIndexHoles(),this.dispatchEvent(new N(C.ZINDICESCHANGED)),i.destroy();else throw new Error(`No map found with ID ${t}`);return t}async getOrComputeMapId(e){return e.id||await wc(e)}addToOrUpdateRtree(e){this.rtree&&(this.rtree.removeItem(e.mapId),this.rtree.addItem(e.mapId,e.geoMask))}removeFromRtree(e){this.rtree&&this.rtree.removeItem(e.mapId)}removeZIndexHoles(){const e=[...this.zIndices.entries()].sort((i,n)=>i[1]-n[1]);let t=0;for(const i of e){const n=i[0];this.zIndices.set(n,t),t++}}imageInfoLoaded(){this.dispatchEvent(new N(C.IMAGEINFOLOADED))}addEventListenersToWarpedMap(e){e.addEventListener(C.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this))}removeEventListenersFromWarpedMap(e){e.removeEventListener(C.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this))}}class Ip extends EventTarget{tile;imageRequest;tileUrl;tileKey;fetchFn;abortController;data;constructor(e,t){super(),this.tile=e.tile,this.imageRequest=e.imageRequest,this.tileUrl=e.tileUrl,this.tileKey=e.tileKey,this.fetchFn=t,this.abortController=new AbortController}isCachedTile(){return this.data!==void 0}abort(){this.abortController.signal.aborted||this.abortController.abort()}}class ya{mapId;tile;imageRequest;tileUrl;tileKey;fetchableTileKey;constructor(e,t){this.mapId=t.mapId,this.tile=e;const i=t.parsedImage.getIiifTile(e.tileZoomLevel,e.column,e.row);this.imageRequest=i,this.tileUrl=t.parsedImage.getImageUrl(i),this.tileKey=fn(e),this.fetchableTileKey=pf(this)}}class bn extends Ip{async fetch(){try{const e=await(await An(this.tileUrl,{signal:this.abortController.signal},this.fetchFn)).blob();this.data=await createImageBitmap(e,0,0,this.tile.tileZoomLevel.width,this.tile.tileZoomLevel.height),this.dispatchEvent(new N(C.TILEFETCHED,this.tileUrl))}catch(e){e instanceof Error&&e.name==="AbortError"||this.dispatchEvent(new N(C.TILEFETCHERROR,this.tileUrl))}return this.data}static createFactory(){return(e,t)=>new bn(e,t)}}const Cp=4,Lp=2;let kp=class extends EventTarget{cachableTileFactory;fetchFn;tilesByTileUrl=new Map;mapIdsByTileUrl=new Map;tileUrlsByMapId=new Map;tilesFetchingCount=0;fetchableTiles=[];constructor(e,t){super(),this.cachableTileFactory=e,this.fetchFn=t?.fetchFn}getCacheableTiles(){return this.tilesByTileUrl.values()}getCacheableTile(e){return this.tilesByTileUrl.get(e)}getMapCacheableTiles(e){const t=[];for(const i of this.tilesByTileUrl.values())this.tileUrlsByMapId.get(e)?.has(i.tileUrl)&&t.push(i);return t}getCachedTiles(){const e=[];for(const t of this.tilesByTileUrl.values())t.isCachedTile()&&e.push(t);return e}getCachedTile(e){const t=this.tilesByTileUrl.get(e);if(t&&t.isCachedTile())return t}getMapCachedTiles(e){const t=[];for(const i of this.tilesByTileUrl.values())i.isCachedTile()&&this.tileUrlsByMapId.get(e)?.has(i.tileUrl)&&t.push(i);return t}getTileUrls(){return this.tilesByTileUrl.keys()}getMapTileUrls(e){return this.tileUrlsByMapId.get(e)||new Set}requestFetchableTiles(e){const t=new Set(this.fetchableTiles.map(n=>n.fetchableTileKey)),i=new Set(e.map(n=>n.fetchableTileKey));if(!oc(t,i)){for(const n of e)this.requestFetchableTile(n);this.fetchableTiles=e}}async allRequestedTilesLoaded(){return new Promise(e=>{if(this.finished)e();else{const t=()=>{this.removeEventListener(C.ALLREQUESTEDTILESLOADED,t),e()};this.addEventListener(C.ALLREQUESTEDTILESLOADED,t)}})}prune(e){for(const[t,i]of this.mapIdsByTileUrl.entries())for(const n of i){const o=e.get(n),s=this.tilesByTileUrl.get(t)?.tile;s&&(!o||vf(s,o,{maxHigherLog2ScaleFactorDiff:Cp,maxLowerLog2ScaleFactorDiff:Lp}))&&this.removeCacheableTileForMapId(t,n)}}clear(){for(const e of this.getCacheableTiles())e.abort(),this.removeEventListenersFromCacheableTile(e);this.tilesByTileUrl=new Map,this.mapIdsByTileUrl=new Map,this.tileUrlsByMapId=new Map,this.tilesFetchingCount=0}destroy(){this.clear()}requestFetchableTile(e){const t=e.mapId,i=e.tileUrl;if(this.tilesByTileUrl.has(i))this.tilesByTileUrl.get(i)?.isCachedTile()&&this.dispatchEvent(new N(C.MAPTILELOADED,{mapId:t,tileUrl:i}));else{const n=this.cachableTileFactory(e,this.fetchFn);this.addEventListenersToCacheableTile(n),this.addCacheableTile(n)}this.addTileUrlForMapId(i,t),this.addMapIdForTileUrl(t,i)}addCacheableTile(e){this.tilesByTileUrl.set(e.tileUrl,e),e.fetch(),this.updateTilesFetchingCount(1)}removeCacheableTileForMapId(e,t){const i=this.tilesByTileUrl.get(e);if(!i)return;const n=this.removeMapIdForTileUrl(t,e);this.removeTileUrlForMapId(e,t),n.size||(i.isCachedTile()||(i.abort(),this.updateTilesFetchingCount(-1)),this.tilesByTileUrl.delete(e)),this.dispatchEvent(new N(C.MAPTILEREMOVED,{mapId:t,tileUrl:e}))}tileFetched(e){if(e instanceof N){const t=e.data;this.updateTilesFetchingCount(-1);for(const i of this.mapIdsByTileUrl.get(t)||[])this.dispatchEvent(new N(C.MAPTILELOADED,{mapId:i,tileUrl:t})),this.tileUrlsByMapId.get(i)?.values().next().value===t&&this.dispatchEvent(new N(C.FIRSTMAPTILELOADED,{mapId:i,tileUrl:t}))}}tileFetchError(e){if(e instanceof N){const t=e.data;this.tilesByTileUrl.has(t)||this.updateTilesFetchingCount(-1)}}addMapIdForTileUrl(e,t){let i=this.mapIdsByTileUrl.get(t);return i?i.add(e):i=new Set([e]),this.mapIdsByTileUrl.set(t,i),i}removeMapIdForTileUrl(e,t){const i=this.mapIdsByTileUrl.get(t);if(i)i.delete(e);else return new Set;return i.size?this.mapIdsByTileUrl.set(t,i):this.mapIdsByTileUrl.delete(t),i}addTileUrlForMapId(e,t){let i=this.tileUrlsByMapId.get(t);return i?i.add(e):i=new Set([e]),this.tileUrlsByMapId.set(t,i),i}removeTileUrlForMapId(e,t){const i=this.tileUrlsByMapId.get(t);return i?(i.delete(e),i.size?this.tileUrlsByMapId.set(t,i):this.tileUrlsByMapId.delete(t),i):new Set}get finished(){return this.tilesFetchingCount===0}updateTilesFetchingCount(e){this.tilesFetchingCount+=e,this.tilesFetchingCount===0&&this.dispatchEvent(new N(C.ALLREQUESTEDTILESLOADED))}addEventListenersToCacheableTile(e){e.addEventListener(C.TILEFETCHED,this.tileFetched.bind(this)),e.addEventListener(C.TILEFETCHERROR,this.tileFetchError.bind(this))}removeEventListenersFromCacheableTile(e){e.removeEventListener(C.TILEFETCHED,this.tileFetched.bind(this)),e.removeEventListener(C.TILEFETCHERROR,this.tileFetchError.bind(this))}};const jp=5,wa=0,Op=2,Fp=4,_a=10,Dp=0,Gp=.4,Np=1024*1024,Bp=10;class zp extends EventTarget{warpedMapList;tileCache;mapsInViewport=new Set;mapsWithRequestedTilesForViewport=new Set;viewport;constructor(e,t,i){super(),this.tileCache=new kp(e,i),this.warpedMapList=new Ap(t,i)}async addGeoreferenceAnnotation(e){return this.warpedMapList.addGeoreferenceAnnotation(e)}async addGeoreferencedMap(e){return this.warpedMapList.addGeoreferencedMap(e)}loadMissingImageInfosInViewport(){return this.viewport?Array.from(this.warpedMapList.getMapsByGeoBbox(this.viewport.geoRectangleBbox)).map(e=>this.warpedMapList.getWarpedMap(e)).filter(e=>!e.hasImageInfo()&&!e.loadingImageInfo).map(e=>e.loadImageInfo()):[]}someImageInfosInViewport(){return this.viewport?Array.from(this.findMapsInViewport(this.shouldAnticipateInteraction()?_a:0)).map(e=>this.warpedMapList.getWarpedMap(e)).map(e=>e.hasImageInfo()).some(Boolean):!1}shouldRequestFetchableTiles(){return!0}shouldAnticipateInteraction(){return!1}requestFetchableTiles(){if(!this.shouldRequestFetchableTiles())return;const e=[],t=[],i=this.findMapsInViewport(this.shouldAnticipateInteraction()?wa:0),n=this.findMapsInViewport(this.shouldAnticipateInteraction()?Op:0),o=this.findMapsInViewport(this.shouldAnticipateInteraction()?Fp:0),s=this.findMapsInViewport(this.shouldAnticipateInteraction()?_a:0);for(const a of this.warpedMapList.getWarpedMaps())a.resetCurrent();for(const a of o)e.push(...this.getMapFetchableTilesForViewport(a,i));if(this.shouldAnticipateInteraction())for(const a of s)t.push(...this.getMapOverviewFetchableTilesForViewport(a,[...e,...t],n));this.tileCache.requestFetchableTiles([...e,...t]),this.updateMapsForViewport([...e,...t]),this.pruneTileCache(s)}findMapsInViewport(e=0){if(!this.viewport)return new Set;const t=this.viewport,i=this.viewport.getProjectedGeoBufferedRectangle(e),n=fe(i.map(o=>Si(o)));return new Set(Array.from(this.warpedMapList.getMapsByGeoBbox(n)).sort((o,s)=>{const a=this.warpedMapList.getWarpedMap(o),c=this.warpedMapList.getWarpedMap(s);return a&&c?ft(wt(a.geoMaskBbox),t.geoCenter)-ft(wt(c.geoMaskBbox),t.geoCenter):0}))}getMapFetchableTilesForViewport(e,t){if(!this.viewport)return[];const i=this.viewport,n=this.warpedMapList.getWarpedMap(e);if(!n)return[];if(!n.visible)return[];if(!n.hasImageInfo())return[];if(tc(n.getViewportMaskBbox(i))<jp)return[];const o=ef(n.parsedImage.tileZoomLevels,n.getResourceToCanvasScale(i),Dp,Gp);n.setCurrentTileZoomLevel(o),n.setCurrentBestScaleFactor(o.scaleFactor);const s={maxDepth:0,sourceIsGeographic:!1,destinationIsGeographic:!0},a=n.projectedTransformer.transformBackward([i.getProjectedGeoBufferedRectangle(this.shouldAnticipateInteraction()?wa:0)],s)[0];if(n.setCurrentResourceViewportRing(a),!t.has(e))return[];const c=tf(a,o,[n.parsedImage.width,n.parsedImage.height]).map(l=>new ya(l,n));return n.setCurrentFetchableTiles(c),c}getMapOverviewFetchableTilesForViewport(e,t,i){if(!this.viewport)return[];const n=this.warpedMapList.getWarpedMap(e);if(!n)return[];if(!n.visible)return[];if(!n.hasImageInfo())return[];const o=hf(t.map(l=>l.tile)),s=this.viewport.canvasResolution*Bp;if(o>s)return[];const a=n.parsedImage.tileZoomLevels.filter(l=>uf(l)<=Np).sort((l,h)=>l.scaleFactor-h.scaleFactor).at(-1);if(n.setCurrentOverviewTileZoomLevel(a),!i.has(e))return[];if(!a||n.currentTileZoomLevel&&a.scaleFactor<=n.currentTileZoomLevel.scaleFactor)return[];const c=Hs(a.scaleFactor,n.parsedImage).map(l=>new ya(l,n));return n.setCurrentOverviewFetchableTiles(c),c}updateMapsForViewport(e){this.mapsWithRequestedTilesForViewport=new Set(e.map(s=>s.mapId).filter((s,a,c)=>c.indexOf(s)===a).sort((s,a)=>{const c=this.warpedMapList.getMapZIndex(s),l=this.warpedMapList.getMapZIndex(a);return c!==void 0&&l!==void 0?c-l:0})),this.mapsInViewport=this.findMapsInViewport();const t=Array.from(this.mapsInViewport),i=Array.from(this.mapsInViewport),n=i.filter(s=>!t.includes(s)),o=t.filter(s=>!i.includes(s));for(const s of n)this.dispatchEvent(new N(C.WARPEDMAPENTER,s));for(const s of o)this.clearMap(s),this.dispatchEvent(new N(C.WARPEDMAPLEAVE,s))}pruneTileCache(e){const t=new Map;for(const i of this.warpedMapList.getWarpedMaps(e))t.set(i.mapId,{currentTileZoomLevel:i.currentTileZoomLevel,currentOverviewTileZoomLevel:i.currentOverviewTileZoomLevel,currentResourceViewportRingBbox:i.currentResourceViewportRingBbox});this.tileCache.prune(t)}destroy(){this.tileCache.destroy(),this.warpedMapList.destroy()}clearMap(e){}mapTileLoaded(e){}mapTileRemoved(e){}imageInfoLoaded(e){}warpedMapAdded(e){}warpedMapRemoved(e){}preChange(e){}transformationChanged(e){}distortionChanged(e){}addEventListeners(){this.tileCache.addEventListener(C.MAPTILELOADED,this.mapTileLoaded.bind(this)),this.tileCache.addEventListener(C.MAPTILEREMOVED,this.mapTileRemoved.bind(this)),this.warpedMapList.addEventListener(C.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this)),this.warpedMapList.addEventListener(C.WARPEDMAPADDED,this.warpedMapAdded.bind(this)),this.warpedMapList.addEventListener(C.WARPEDMAPREMOVED,this.warpedMapRemoved.bind(this)),this.warpedMapList.addEventListener(C.PRECHANGE,this.preChange.bind(this)),this.warpedMapList.addEventListener(C.TRANSFORMATIONCHANGED,this.transformationChanged.bind(this)),this.warpedMapList.addEventListener(C.DISTORTIONCHANGED,this.distortionChanged.bind(this))}removeEventListeners(){this.tileCache.removeEventListener(C.MAPTILELOADED,this.mapTileLoaded.bind(this)),this.tileCache.removeEventListener(C.MAPTILEREMOVED,this.mapTileRemoved.bind(this)),this.warpedMapList.removeEventListener(C.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this)),this.warpedMapList.removeEventListener(C.WARPEDMAPADDED,this.warpedMapAdded.bind(this)),this.warpedMapList.removeEventListener(C.WARPEDMAPREMOVED,this.warpedMapRemoved.bind(this)),this.warpedMapList.removeEventListener(C.PRECHANGE,this.preChange.bind(this)),this.warpedMapList.removeEventListener(C.TRANSFORMATIONCHANGED,this.transformationChanged.bind(this)),this.warpedMapList.removeEventListener(C.DISTORTIONCHANGED,this.distortionChanged.bind(this))}}var xa=`#version 300 es

precision highp float;

float easing(float t) {
  return t;

  
  
}

uniform mat4 u_renderTransform;
uniform float u_animationProgress;

in vec2 a_resourceTrianglePoint;
in vec2 a_clipPreviousTrianglePoint;
in vec2 a_clipTrianglePoint;
in float a_previousTrianglePointDistortion;
in float a_trianglePointDistortion;
in float a_trianglePointIndex;

out vec2 v_resourceTrianglePoint;
out float v_trianglePointDistortion;
out float v_trianglePointIndex;
out vec4 v_trianglePointBarycentric;

void main() {
  
  vec2 clipTrianglePoint = mix(a_clipPreviousTrianglePoint, a_clipTrianglePoint, easing(u_animationProgress));
  float trianglePointDistortion = mix(a_previousTrianglePointDistortion, a_trianglePointDistortion, easing(u_animationProgress));

  
  
  

  gl_Position = u_renderTransform * vec4(clipTrianglePoint, 0.0f, 1.0f);

  
  v_resourceTrianglePoint = a_resourceTrianglePoint;
  v_trianglePointDistortion = trianglePointDistortion;
  v_trianglePointIndex = a_trianglePointIndex;

  float trianglePointLocalIndex = mod(a_trianglePointIndex, 3.0);
  if(trianglePointLocalIndex == 0.0) v_trianglePointBarycentric = vec4(1.0, 0, 0, 1.0);
  if(trianglePointLocalIndex == 1.0) v_trianglePointBarycentric = vec4(0.0, 1.0, 0, 1.0);
  if(trianglePointLocalIndex == 2.0) v_trianglePointBarycentric = vec4(0.0, 0, 1.0, 1.0);
}`,ba=`#version 300 es

precision highp float;
precision highp isampler2D;

#ifndef SPECTRAL
#define SPECTRAL

const int SPECTRAL_SIZE = 38;
const float SPECTRAL_GAMMA = 2.4;
const float SPECTRAL_EPSILON = 0.0001;

float spectral_uncompand(float x) {
  return (x < 0.04045) ? x / 12.92 : pow((x + 0.055) / 1.055, SPECTRAL_GAMMA);
}

float spectral_compand(float x) {
  return (x < 0.0031308) ? x * 12.92 : 1.055 * pow(x, 1.0 / SPECTRAL_GAMMA) - 0.055;
}

vec3 spectral_srgb_to_linear(vec3 srgb) {
    return vec3(spectral_uncompand(srgb[0]), spectral_uncompand(srgb[1]), spectral_uncompand(srgb[2]));
}

vec3 spectral_linear_to_srgb(vec3 lrgb) {
    return clamp(vec3(spectral_compand(lrgb[0]), spectral_compand(lrgb[1]), spectral_compand(lrgb[2])), 0.0, 1.0);
}

void spectral_upsampling(vec3 lrgb, out float w, out float c, out float m, out float y, out float r, out float g, out float b) {
    w = min(lrgb.r, min(lrgb.g, lrgb.b));

    lrgb -= w;

    c = min(lrgb.g, lrgb.b);
    m = min(lrgb.r, lrgb.b);
    y = min(lrgb.r, lrgb.g);
    r = min(max(0., lrgb.r - lrgb.b), max(0., lrgb.r - lrgb.g));
    g = min(max(0., lrgb.g - lrgb.b), max(0., lrgb.g - lrgb.r));
    b = min(max(0., lrgb.b - lrgb.g), max(0., lrgb.b - lrgb.r));
}

void spectral_linear_to_reflectance(vec3 lrgb, inout float R[SPECTRAL_SIZE]) {
    float w, c, m, y, r, g, b;

    spectral_upsampling(lrgb, w, c, m, y, r, g, b);

     R[0] = max(SPECTRAL_EPSILON, w + c * 0.96853629 + m * 0.51567122 + y * 0.02055257 + r * 0.03147571 + g * 0.49108579 + b * 0.97901834);
     R[1] = max(SPECTRAL_EPSILON, w + c * 0.96855103 + m * 0.54015520 + y * 0.02059936 + r * 0.03146636 + g * 0.46944057 + b * 0.97901649);
     R[2] = max(SPECTRAL_EPSILON, w + c * 0.96859338 + m * 0.62645502 + y * 0.02062723 + r * 0.03140624 + g * 0.40165780 + b * 0.97901118);
     R[3] = max(SPECTRAL_EPSILON, w + c * 0.96877345 + m * 0.75595012 + y * 0.02073387 + r * 0.03119611 + g * 0.24490420 + b * 0.97892146);
     R[4] = max(SPECTRAL_EPSILON, w + c * 0.96942204 + m * 0.92826996 + y * 0.02114202 + r * 0.03053888 + g * 0.06826880 + b * 0.97858555);
     R[5] = max(SPECTRAL_EPSILON, w + c * 0.97143709 + m * 0.97223624 + y * 0.02233154 + r * 0.02856855 + g * 0.02732883 + b * 0.97743705);
     R[6] = max(SPECTRAL_EPSILON, w + c * 0.97541862 + m * 0.98616174 + y * 0.02556857 + r * 0.02459485 + g * 0.01360600 + b * 0.97428075);
     R[7] = max(SPECTRAL_EPSILON, w + c * 0.98074186 + m * 0.98955255 + y * 0.03330189 + r * 0.01929520 + g * 0.01000187 + b * 0.96663223);
     R[8] = max(SPECTRAL_EPSILON, w + c * 0.98580992 + m * 0.98676237 + y * 0.05185294 + r * 0.01423112 + g * 0.01284127 + b * 0.94822893);
     R[9] = max(SPECTRAL_EPSILON, w + c * 0.98971194 + m * 0.97312575 + y * 0.10087639 + r * 0.01033111 + g * 0.02636635 + b * 0.89937713);
    R[10] = max(SPECTRAL_EPSILON, w + c * 0.99238027 + m * 0.91944277 + y * 0.24000413 + r * 0.00765876 + g * 0.07058713 + b * 0.76070164);
    R[11] = max(SPECTRAL_EPSILON, w + c * 0.99409844 + m * 0.32564851 + y * 0.53589066 + r * 0.00593693 + g * 0.70421692 + b * 0.46420440);
    R[12] = max(SPECTRAL_EPSILON, w + c * 0.99517200 + m * 0.13820628 + y * 0.79874659 + r * 0.00485616 + g * 0.85473994 + b * 0.20123039);
    R[13] = max(SPECTRAL_EPSILON, w + c * 0.99576545 + m * 0.05015143 + y * 0.91186529 + r * 0.00426186 + g * 0.95081565 + b * 0.08808402);
    R[14] = max(SPECTRAL_EPSILON, w + c * 0.99593552 + m * 0.02912336 + y * 0.95399623 + r * 0.00409039 + g * 0.97170370 + b * 0.04592894);
    R[15] = max(SPECTRAL_EPSILON, w + c * 0.99564041 + m * 0.02421691 + y * 0.97137099 + r * 0.00438375 + g * 0.97651888 + b * 0.02860373);
    R[16] = max(SPECTRAL_EPSILON, w + c * 0.99464769 + m * 0.02660696 + y * 0.97939505 + r * 0.00537525 + g * 0.97429245 + b * 0.02060067);
    R[17] = max(SPECTRAL_EPSILON, w + c * 0.99229579 + m * 0.03407586 + y * 0.98345207 + r * 0.00772962 + g * 0.97012917 + b * 0.01656701);
    R[18] = max(SPECTRAL_EPSILON, w + c * 0.98638762 + m * 0.04835936 + y * 0.98553736 + r * 0.01366120 + g * 0.94258630 + b * 0.01451549);
    R[19] = max(SPECTRAL_EPSILON, w + c * 0.96829712 + m * 0.00011720 + y * 0.98648905 + r * 0.03181352 + g * 0.99989207 + b * 0.01357964);
    R[20] = max(SPECTRAL_EPSILON, w + c * 0.89228016 + m * 0.00008554 + y * 0.98674535 + r * 0.10791525 + g * 0.99989891 + b * 0.01331243);
    R[21] = max(SPECTRAL_EPSILON, w + c * 0.53740239 + m * 0.85267882 + y * 0.98657555 + r * 0.46249516 + g * 0.13823139 + b * 0.01347661);
    R[22] = max(SPECTRAL_EPSILON, w + c * 0.15360445 + m * 0.93188793 + y * 0.98611877 + r * 0.84604333 + g * 0.06968113 + b * 0.01387181);
    R[23] = max(SPECTRAL_EPSILON, w + c * 0.05705719 + m * 0.94810268 + y * 0.98559942 + r * 0.94275572 + g * 0.05628787 + b * 0.01435472);
    R[24] = max(SPECTRAL_EPSILON, w + c * 0.03126539 + m * 0.94200977 + y * 0.98507063 + r * 0.96860996 + g * 0.06111561 + b * 0.01479836);
    R[25] = max(SPECTRAL_EPSILON, w + c * 0.02205445 + m * 0.91478045 + y * 0.98460039 + r * 0.97783966 + g * 0.08987709 + b * 0.01515250);
    R[26] = max(SPECTRAL_EPSILON, w + c * 0.01802271 + m * 0.87065445 + y * 0.98425301 + r * 0.98187757 + g * 0.13656016 + b * 0.01540513);
    R[27] = max(SPECTRAL_EPSILON, w + c * 0.01613460 + m * 0.78827548 + y * 0.98403909 + r * 0.98377315 + g * 0.22169624 + b * 0.01557233);
    R[28] = max(SPECTRAL_EPSILON, w + c * 0.01520947 + m * 0.65738359 + y * 0.98388535 + r * 0.98470202 + g * 0.32176956 + b * 0.01565710);
    R[29] = max(SPECTRAL_EPSILON, w + c * 0.01475977 + m * 0.59909403 + y * 0.98376116 + r * 0.98515481 + g * 0.36157329 + b * 0.01571025);
    R[30] = max(SPECTRAL_EPSILON, w + c * 0.01454263 + m * 0.56817268 + y * 0.98368246 + r * 0.98537114 + g * 0.48361920 + b * 0.01571916);
    R[31] = max(SPECTRAL_EPSILON, w + c * 0.01444459 + m * 0.54031997 + y * 0.98365023 + r * 0.98546685 + g * 0.46488579 + b * 0.01572133);
    R[32] = max(SPECTRAL_EPSILON, w + c * 0.01439897 + m * 0.52110241 + y * 0.98361309 + r * 0.98550011 + g * 0.47440306 + b * 0.01572502);
    R[33] = max(SPECTRAL_EPSILON, w + c * 0.01437620 + m * 0.51041094 + y * 0.98357259 + r * 0.98551031 + g * 0.48576990 + b * 0.01571717);
    R[34] = max(SPECTRAL_EPSILON, w + c * 0.01436343 + m * 0.50526577 + y * 0.98353856 + r * 0.98550741 + g * 0.49267971 + b * 0.01571905);
    R[35] = max(SPECTRAL_EPSILON, w + c * 0.01435687 + m * 0.50255080 + y * 0.98351247 + r * 0.98551323 + g * 0.49625685 + b * 0.01571059);
    R[36] = max(SPECTRAL_EPSILON, w + c * 0.01435370 + m * 0.50126452 + y * 0.98350101 + r * 0.98551563 + g * 0.49807754 + b * 0.01569728);
    R[37] = max(SPECTRAL_EPSILON, w + c * 0.01435408 + m * 0.50083021 + y * 0.98350852 + r * 0.98551547 + g * 0.49889859 + b * 0.01570020);
}

vec3 spectral_xyz_to_srgb(vec3 xyz) {
    mat3 XYZ_RGB;

    XYZ_RGB[0] = vec3( 3.24306333, -1.53837619, -0.49893282);
    XYZ_RGB[1] = vec3(-0.96896309,  1.87542451,  0.04154303);
    XYZ_RGB[2] = vec3( 0.05568392, -0.20417438,  1.05799454);

    float r = dot(XYZ_RGB[0], xyz);
    float g = dot(XYZ_RGB[1], xyz);
    float b = dot(XYZ_RGB[2], xyz);

    return spectral_linear_to_srgb(vec3(r, g, b));
}

vec3 spectral_reflectance_to_xyz(float R[SPECTRAL_SIZE]) {
    vec3 xyz = vec3(0.0);

    xyz +=  R[0] * vec3(0.00006469, 0.00000184, 0.00030502);
    xyz +=  R[1] * vec3(0.00021941, 0.00000621, 0.00103681);
    xyz +=  R[2] * vec3(0.00112057, 0.00003101, 0.00531314);
    xyz +=  R[3] * vec3(0.00376661, 0.00010475, 0.01795439);
    xyz +=  R[4] * vec3(0.01188055, 0.00035364, 0.05707758);
    xyz +=  R[5] * vec3(0.02328644, 0.00095147, 0.11365162);
    xyz +=  R[6] * vec3(0.03455942, 0.00228226, 0.17335873);
    xyz +=  R[7] * vec3(0.03722379, 0.00420733, 0.19620658);
    xyz +=  R[8] * vec3(0.03241838, 0.00668880, 0.18608237);
    xyz +=  R[9] * vec3(0.02123321, 0.00988840, 0.13995048);
    xyz += R[10] * vec3(0.01049099, 0.01524945, 0.08917453);
    xyz += R[11] * vec3(0.00329584, 0.02141831, 0.04789621);
    xyz += R[12] * vec3(0.00050704, 0.03342293, 0.02814563);
    xyz += R[13] * vec3(0.00094867, 0.05131001, 0.01613766);
    xyz += R[14] * vec3(0.00627372, 0.07040208, 0.00775910);
    xyz += R[15] * vec3(0.01686462, 0.08783871, 0.00429615);
    xyz += R[16] * vec3(0.02868965, 0.09424905, 0.00200551);
    xyz += R[17] * vec3(0.04267481, 0.09795667, 0.00086147);
    xyz += R[18] * vec3(0.05625475, 0.09415219, 0.00036904);
    xyz += R[19] * vec3(0.06947040, 0.08678102, 0.00019143);
    xyz += R[20] * vec3(0.08305315, 0.07885653, 0.00014956);
    xyz += R[21] * vec3(0.08612610, 0.06352670, 0.00009231);
    xyz += R[22] * vec3(0.09046614, 0.05374142, 0.00006813);
    xyz += R[23] * vec3(0.08500387, 0.04264606, 0.00002883);
    xyz += R[24] * vec3(0.07090667, 0.03161735, 0.00001577);
    xyz += R[25] * vec3(0.05062889, 0.02088521, 0.00000394);
    xyz += R[26] * vec3(0.03547396, 0.01386011, 0.00000158);
    xyz += R[27] * vec3(0.02146821, 0.00810264, 0.00000000);
    xyz += R[28] * vec3(0.01251646, 0.00463010, 0.00000000);
    xyz += R[29] * vec3(0.00680458, 0.00249138, 0.00000000);
    xyz += R[30] * vec3(0.00346457, 0.00125930, 0.00000000);
    xyz += R[31] * vec3(0.00149761, 0.00054165, 0.00000000);
    xyz += R[32] * vec3(0.00076970, 0.00027795, 0.00000000);
    xyz += R[33] * vec3(0.00040737, 0.00014711, 0.00000000);
    xyz += R[34] * vec3(0.00016901, 0.00006103, 0.00000000);
    xyz += R[35] * vec3(0.00009522, 0.00003439, 0.00000000);
    xyz += R[36] * vec3(0.00004903, 0.00001771, 0.00000000);
    xyz += R[37] * vec3(0.00002000, 0.00000722, 0.00000000);

    return xyz;
}

float spectral_linear_to_concentration(float l1, float l2, float t) {
    float t1 = l1 * pow(1.0 - t, 2.0);
    float t2 = l2 * pow(t, 2.0);

    return t2 / (t1 + t2);
}

vec3 spectral_mix(vec3 color1, vec3 color2, float t) {
    vec3 lrgb1 = spectral_srgb_to_linear(color1);
    vec3 lrgb2 = spectral_srgb_to_linear(color2);

    float R1[SPECTRAL_SIZE];
    float R2[SPECTRAL_SIZE];

    spectral_linear_to_reflectance(lrgb1, R1);
    spectral_linear_to_reflectance(lrgb2, R2);

    float l1 = spectral_reflectance_to_xyz(R1)[1];
    float l2 = spectral_reflectance_to_xyz(R2)[1];

    t = spectral_linear_to_concentration(l1, l2, t);

    float R[SPECTRAL_SIZE];

    for (int i = 0; i < SPECTRAL_SIZE; i++) {
      float KS = (1.0 - t) * (pow(1.0 - R1[i], 2.0) / (2.0 * R1[i])) + t * (pow(1.0 - R2[i], 2.0) / (2.0 * R2[i]));
      float KM = 1.0 + KS - sqrt(pow(KS, 2.0) + 2.0 * KS);

      
      

      R[i] = KM;
    }

    return spectral_xyz_to_srgb(spectral_reflectance_to_xyz(R));
}

vec4 spectral_mix(vec4 color1, vec4 color2, float t) {
    return vec4(spectral_mix(color1.rgb, color2.rgb, t), mix(color1.a, color2.a, t));
}

#endif
float easing(float t) {
  return t;

  
  
}

uniform float u_debug;

uniform bool u_removeColor;
uniform vec3 u_removeColorOptionsColor;
uniform float u_removeColorOptionsThreshold;
uniform float u_removeColorOptionsHardness;

uniform bool u_colorize;
uniform vec3 u_colorizeOptionsColor;

uniform bool u_grid;

uniform float u_opacity;
uniform float u_saturation;

uniform bool u_distortion;
uniform int u_distortionOptionsdistortionMeasure;

uniform int u_currentBestScaleFactor;

uniform lowp sampler2DArray u_cachedTilesTextureArray;
uniform isampler2D u_cachedTilesResourcePositionsAndDimensionsTexture;
uniform isampler2D u_cachedTilesScaleFactorsTexture;

uniform vec4 u_colorDistortion00;
uniform vec4 u_colorDistortion01;
uniform vec4 u_colorDistortion1;
uniform vec4 u_colorDistortion2;
uniform vec4 u_colorDistortion3;
uniform vec4 u_colorGrid;

in vec2 v_resourceTrianglePoint;
in float v_trianglePointDistortion;
in float v_trianglePointIndex;
in vec4 v_trianglePointBarycentric;

out vec4 color;

void main() {
  float resourceTrianglePointX = v_resourceTrianglePoint.x;
  float resourceTrianglePointY = v_resourceTrianglePoint.y;

  
  ivec3 cachedTilesTextureSize = textureSize(u_cachedTilesTextureArray, 0);
  int cachedTilesCount = cachedTilesTextureSize.z;

  
  int smallestScaleFactor = int(pow(2.0, 8.0)); 
  bool found = false;
  int foundIndex;

  
  vec3 cachedTilesTexturePoint = vec3(0.0f, 0.0f, 0.0f);

  
  color = vec4(0.0f, 0.0f, 0.0f, 0.0f);;

  
  for(int index = 0; index < cachedTilesCount; index += 1) {

    
    float cachedTileResourcePositionX = float(texelFetch(u_cachedTilesResourcePositionsAndDimensionsTexture, ivec2(0, (index * 4)), 0));
    float cachedTileResourcePositionY = float(texelFetch(u_cachedTilesResourcePositionsAndDimensionsTexture, ivec2(0, (index * 4) + 1), 0));
    float cachedTileDimensionWidth = float(texelFetch(u_cachedTilesResourcePositionsAndDimensionsTexture, ivec2(0, (index * 4) + 2), 0));
    float cachedTileDimensionHeight = float(texelFetch(u_cachedTilesResourcePositionsAndDimensionsTexture, ivec2(0, (index * 4) + 3), 0));

    int cachedTileScaleFactor = texelFetch(u_cachedTilesScaleFactorsTexture, ivec2(0, index), 0).r;

    
    if(resourceTrianglePointX >= cachedTileResourcePositionX &&
      resourceTrianglePointX < cachedTileResourcePositionX + cachedTileDimensionWidth &&
      resourceTrianglePointY >= cachedTileResourcePositionY &&
      resourceTrianglePointY < cachedTileResourcePositionY + cachedTileDimensionHeight) {

      
      
      
      
      if(cachedTileScaleFactor < smallestScaleFactor) {
        smallestScaleFactor = cachedTileScaleFactor;
        found = true;
        foundIndex = index;

        float cachedTilePointX = (resourceTrianglePointX - cachedTileResourcePositionX) / float(cachedTileScaleFactor);
        float cachedTilePointY = (resourceTrianglePointY - cachedTileResourcePositionY) / float(cachedTileScaleFactor);

        float cachedTilesTexturePointX = cachedTilePointX / float(cachedTilesTextureSize.x);
        float cachedTilesTexturePointY = cachedTilePointY / float(cachedTilesTextureSize.y);

        cachedTilesTexturePoint = vec3(cachedTilesTexturePointX, cachedTilesTexturePointY, index);
      }
    }
  }

  if(found == true) {
    
    color = texture(u_cachedTilesTextureArray, cachedTilesTexturePoint);

    if(u_removeColorOptionsThreshold > 0.0f) {
  vec3 backgroundColorDiff = color.rgb - u_removeColorOptionsColor.rgb;
  float backgroundColorDistance = length(backgroundColorDiff);
  if(u_removeColor && backgroundColorDistance < u_removeColorOptionsThreshold) {
    float amount = smoothstep(u_removeColorOptionsThreshold - u_removeColorOptionsThreshold * (1.0f - u_removeColorOptionsHardness), u_removeColorOptionsThreshold, backgroundColorDistance);
    color = vec4(color.rgb * amount, amount);
  }
}

float gray = 0.21f * color.r + 0.71f * color.g + 0.07f * color.b;
color = vec4(color.rgb * (u_saturation) + (gray * (1.0f - u_saturation)), color.a);

if(u_colorize) {
  color = vec4((u_colorizeOptionsColor + color.rgb) * color.a, color.a);
}

color = vec4(color.rgb * u_opacity, color.a * u_opacity);
    if(u_distortion) {
  
  

  float trianglePointDistortion = v_trianglePointDistortion;

  
  trianglePointDistortion = floor(trianglePointDistortion * 10.0f) / 10.0f;

  switch(u_distortionOptionsdistortionMeasure) {
    case 0:
      if(trianglePointDistortion > 0.0f) {
        color = spectral_mix(color, u_colorDistortion00, trianglePointDistortion);
      } else {
        color = spectral_mix(color, u_colorDistortion01, abs(trianglePointDistortion));
      }
      break;
    case 1:
      color = spectral_mix(color, u_colorDistortion1, trianglePointDistortion);
      break;
    case 2:
      color = spectral_mix(color, u_colorDistortion2, trianglePointDistortion);
      break;
    case 3:
      color = trianglePointDistortion == -1.0f ? u_colorDistortion3 : color;
      break;
    default:
      color = color;
  }
}

if(u_grid) {
  float gridSize = 20.0f * float(u_currentBestScaleFactor);
  float gridWidth = 2.0f * float(u_currentBestScaleFactor);
  if(mod(float(resourceTrianglePointX) + gridWidth / 2.0f, gridSize) < gridWidth || mod(float(resourceTrianglePointY) + gridWidth / 2.0f, gridSize) < gridWidth) {
    color = u_colorGrid;
  }
}
    if(bool(u_debug)) {
  
  

  float dist = 0.99; 
  if(
    v_trianglePointBarycentric.x + v_trianglePointBarycentric.y > dist ||
    v_trianglePointBarycentric.y + v_trianglePointBarycentric.z > dist ||
    v_trianglePointBarycentric.z + v_trianglePointBarycentric.x > dist
  )
  color = vec4(0, 0, 0, 1);
}
  }
}`,Ta=`#version 300 es

precision highp float;

float easing(float t) {
  return t;

  
  
}

uniform mat4 u_projectedGeoToViewportTransform;
uniform mat4 u_viewportToClipTransform;
uniform float u_animationProgress;

in vec2 a_projectedGeoPoint;
in vec2 a_projectedGeoOtherPoint;
in vec2 a_projectedGeoPreviousPoint;
in vec2 a_projectedGeoPreviousOtherPoint;
in float a_isOtherPoint;
in float a_normalSign;
in float a_viewportSize;
in vec4 a_color;
in float a_viewportBorderSize;
in vec4 a_borderColor;

out float v_viewportLineLength;
out vec2 v_linePoint;
out float v_viewportSize;
out vec4 v_color;
out float v_viewportBorderSize;
out vec4 v_borderColor;
out float v_viewportFeatherSize;
out float v_viewportTotalSize;

void main() {
  vec2 projectedGeoPoint = mix(a_projectedGeoPreviousPoint, a_projectedGeoPoint, easing(u_animationProgress));
  vec2 projectedGeoOtherPoint = mix(a_projectedGeoPreviousOtherPoint, a_projectedGeoOtherPoint, easing(u_animationProgress));

  vec2 viewportPoint = (u_projectedGeoToViewportTransform * vec4(projectedGeoPoint, 0.0f, 1.0f)).xy;
  vec2 viewportOtherPoint = (u_projectedGeoToViewportTransform * vec4(projectedGeoOtherPoint, 0.0f, 1.0f)).xy;

  vec2 viewportLine = vec2(viewportOtherPoint.x-viewportPoint.x, viewportOtherPoint.y-viewportPoint.y);
  vec2 viewportNormalizedLine = normalize(viewportLine);
  vec2 viewportNormalizedLineNormal = vec2(viewportNormalizedLine.y, -viewportNormalizedLine.x);
  v_viewportLineLength = length(viewportLine);

  v_viewportFeatherSize = 1.0;

  
  
  
  float viewportSize = a_viewportSize / 2.0;
  float viewportBorderSize = a_viewportBorderSize / 2.0;
  v_viewportFeatherSize = v_viewportFeatherSize / 2.0;

  v_viewportTotalSize = viewportSize + viewportBorderSize + v_viewportFeatherSize;
  float lineX = -1.0 * v_viewportTotalSize / 2.0 + a_isOtherPoint * (v_viewportLineLength + 2.0 * (v_viewportTotalSize / 2.0));
  float lineY = a_normalSign * v_viewportTotalSize / 2.0;
  v_linePoint = vec2(lineX, lineY);
  
  
  
  
  
  

  v_viewportSize = viewportSize;
  v_color = a_color;
  v_viewportBorderSize = viewportBorderSize;
  v_borderColor = a_borderColor;

  gl_Position = u_viewportToClipTransform * vec4(viewportPoint + lineX * viewportNormalizedLine + lineY * viewportNormalizedLineNormal, 0, 1);
}`,Ma=`#version 300 es

precision highp float;
precision highp isampler2D;

in float v_viewportLineLength;
in vec2 v_linePoint;
in float v_viewportSize;
in vec4 v_color;
in float v_viewportBorderSize;
in vec4 v_borderColor;
in float v_viewportFeatherSize;
in float v_viewportTotalSize;

out vec4 color;

void main() {
  float distance;
  if (v_linePoint.x < 0.0) {
    distance = length(v_linePoint - vec2(0.0,0.0)) / (v_viewportTotalSize / 2.0);
  } else if (v_linePoint.x > v_viewportLineLength) {
    distance = length(v_linePoint - vec2(v_viewportLineLength,0.0)) / (v_viewportTotalSize / 2.0);
  } else {
    distance = abs(v_linePoint.y) / (v_viewportTotalSize / 2.0);
  }
  if (distance > 1.0) {
    discard;
  }
  float viewportDistance = distance * v_viewportTotalSize / 2.0;

  
  color = vec4(0, 0, 0, 0);
  if (v_viewportSize >= v_viewportFeatherSize) {
    color = v_color;
  }

  
  
  
  float borderSmoothStep;
  if(v_viewportBorderSize >= v_viewportFeatherSize) {
    borderSmoothStep = smoothstep(
      v_viewportSize / 2.0 - v_viewportBorderSize / 2.0 - v_viewportFeatherSize / 2.0,
      v_viewportSize / 2.0 - v_viewportBorderSize / 2.0 + v_viewportFeatherSize / 2.0,
      viewportDistance
    );
    color = ((1.0 - borderSmoothStep) * color) + (borderSmoothStep * v_borderColor);
  }

  
  
  
  borderSmoothStep = smoothstep(
      v_viewportSize / 2.0 + v_viewportBorderSize / 2.0 - v_viewportFeatherSize / 2.0,
      v_viewportSize / 2.0 + v_viewportBorderSize / 2.0 + v_viewportFeatherSize / 2.0,
      viewportDistance
  );
  color = ((1.0 - borderSmoothStep) * color) + (borderSmoothStep * vec4(0, 0, 0, 0));
}`,Pa=`#version 300 es

precision highp float;

float easing(float t) {
  return t;

  
  
}

uniform mat4 u_projectedGeoToViewportTransform;
uniform mat4 u_viewportToClipTransform;
uniform float u_animationProgress;

in float a_viewportSize;
in vec4 a_color;
in float a_viewportBorderSize;
in vec4 a_borderColor;

in vec2 a_projectedGeoPoint;
in vec2 a_projectedGeoPreviousPoint;

out float v_viewportSize;
out vec4 v_color;
out float v_viewportBorderSize;
out vec4 v_borderColor;
out float v_viewportFeatherSize;
out float v_viewportTotalSize;

void main() {
  vec2 projectedGeoPoint = mix(a_projectedGeoPreviousPoint, a_projectedGeoPoint, easing(u_animationProgress));

  gl_Position = u_viewportToClipTransform * u_projectedGeoToViewportTransform * vec4(projectedGeoPoint, 0.0f, 1.0f);

  v_viewportFeatherSize = 1.0;

  v_viewportTotalSize = a_viewportSize + a_viewportBorderSize + v_viewportFeatherSize;
  gl_PointSize = v_viewportTotalSize;
  
  
  
  
  
  
  

  v_viewportSize = a_viewportSize;
  v_color = a_color;
  v_viewportBorderSize = a_viewportBorderSize;
  v_borderColor = a_borderColor;
}`,Ea=`#version 300 es

precision highp float;
precision highp isampler2D;

in float v_viewportSize;
in vec4 v_color;
in float v_viewportBorderSize;
in vec4 v_borderColor;
in float v_viewportFeatherSize;
in float v_viewportTotalSize;

out vec4 color;

void main() {
  
  float distance = length(2.0 * gl_PointCoord - 1.0);
  if (distance > 1.0) {
    discard;
  }
  float viewportDistance = distance * v_viewportTotalSize / 2.0;

  
  color = vec4(0, 0, 0, 0);
  if (v_viewportSize >= v_viewportFeatherSize) {
    color = v_color;
  }

  
  
  
  float borderSmoothStep;
  if(v_viewportBorderSize >= v_viewportFeatherSize) {
    borderSmoothStep = smoothstep(
      v_viewportSize / 2.0 - v_viewportBorderSize / 2.0 - v_viewportFeatherSize / 2.0,
      v_viewportSize / 2.0 - v_viewportBorderSize / 2.0 + v_viewportFeatherSize / 2.0,
      viewportDistance
    );
    color = ((1.0 - borderSmoothStep) * color) + (borderSmoothStep * v_borderColor);
  }

  
  
  
  borderSmoothStep = smoothstep(
      v_viewportSize / 2.0 + v_viewportBorderSize / 2.0 - v_viewportFeatherSize / 2.0,
      v_viewportSize / 2.0 + v_viewportBorderSize / 2.0 + v_viewportFeatherSize / 2.0,
      viewportDistance
  );
  color = ((1.0 - borderSmoothStep) * color) + (borderSmoothStep * vec4(0, 0, 0, 0));
}`;const Up=200,Vp={leading:!0,trailing:!0},Wp=50,$p={leading:!0,trailing:!0},Tn=1,Mn=1,Zp=0,qp=.7,Xp=5,Sa=750;class Hp extends zp{gl;mapsProgram;pointsProgram;linesProgram;previousSignificantViewport;opacity=Tn;saturation=Mn;renderOptions={};invertedRenderTransform;lastAnimationFrameRequestId;animating=!1;transformationTransitionStart;animationProgress=0;disableRender=!1;throttledPrepareRenderInternal;throttledChanged;constructor(e,t){const i=Re(e,e.VERTEX_SHADER,xa),n=Re(e,e.FRAGMENT_SHADER,ba),o=Re(e,e.VERTEX_SHADER,Pa),s=Re(e,e.FRAGMENT_SHADER,Ea),a=Re(e,e.VERTEX_SHADER,Ta),c=Re(e,e.FRAGMENT_SHADER,Ma),l=kt(e,i,n),h=kt(e,o,s),u=kt(e,a,c);super(bn.createFactory(),Lf(e,l,h,u),t),this.gl=e,this.mapsProgram=l,this.pointsProgram=h,this.linesProgram=u,e.deleteShader(i),e.deleteShader(n),e.deleteShader(i),e.deleteShader(n),e.deleteShader(i),e.deleteShader(n),e.disable(e.DEPTH_TEST),this.invertedRenderTransform=La(),this.addEventListeners(),this.throttledPrepareRenderInternal=hn(this.prepareRenderInternal.bind(this),Up,Vp),this.throttledChanged=hn(this.changed.bind(this),Wp,$p)}initializeWebGL(e){const t=Re(e,e.VERTEX_SHADER,xa),i=Re(e,e.FRAGMENT_SHADER,ba),n=Re(e,e.VERTEX_SHADER,Pa),o=Re(e,e.FRAGMENT_SHADER,Ea),s=Re(e,e.VERTEX_SHADER,Ta),a=Re(e,e.FRAGMENT_SHADER,Ma),c=kt(e,t,i),l=kt(e,n,o),h=kt(e,s,a);this.gl=e,this.mapsProgram=c,this.pointsProgram=l,this.linesProgram=h,e.disable(e.DEPTH_TEST);for(const u of this.warpedMapList.getWarpedMaps())u.initializeWebGL(c,l,h)}getOpacity(){return this.opacity}setOpacity(e){this.opacity=e}resetOpacity(){this.opacity=Tn}getMapOpacity(e){const t=this.warpedMapList.getWarpedMap(e);if(t)return t.opacity}setMapOpacity(e,t){const i=this.warpedMapList.getWarpedMap(e);i&&(i.opacity=Math.min(Math.max(t,0),1))}resetMapOpacity(e){const t=this.warpedMapList.getWarpedMap(e);t&&(t.opacity=Tn)}getRemoveColorOptions(){return this.renderOptions.removeColorOptions}setRemoveColorOptions(e){this.renderOptions.removeColorOptions=e}resetRemoveColorOptions(){this.renderOptions.removeColorOptions=void 0}getMapRemoveColorOptions(e){const t=this.warpedMapList.getWarpedMap(e);if(t)return t.renderOptions.removeColorOptions}setMapRemoveColorOptions(e,t){const i=this.warpedMapList.getWarpedMap(e);i&&(i.renderOptions.removeColorOptions=t)}resetMapRemoveColorOptions(e){const t=this.warpedMapList.getWarpedMap(e);t&&(t.renderOptions.removeColorOptions=void 0)}getColorizeOptions(){return this.renderOptions.colorizeOptions}setColorizeOptions(e){this.renderOptions.colorizeOptions=e}resetColorizeOptions(){this.renderOptions.colorizeOptions=void 0}getMapColorizeOptions(e){const t=this.warpedMapList.getWarpedMap(e);if(t)return t.renderOptions.colorizeOptions}setMapColorizeOptions(e,t){const i=this.warpedMapList.getWarpedMap(e);i&&(i.renderOptions.colorizeOptions=t)}resetMapColorizeOptions(e){const t=this.warpedMapList.getWarpedMap(e);t&&(t.renderOptions.colorizeOptions=void 0)}getGridOptions(){return this.renderOptions.gridOptions}setGridOptions(e){this.renderOptions.gridOptions=e}resetGridOptions(){this.renderOptions.gridOptions=void 0}getMapGridOptions(e){const t=this.warpedMapList.getWarpedMap(e);if(t)return t.renderOptions.gridOptions}setMapGridOptions(e,t){const i=this.warpedMapList.getWarpedMap(e);i&&(i.renderOptions.gridOptions=t)}resetMapGridOptions(e){const t=this.warpedMapList.getWarpedMap(e);t&&(t.renderOptions.gridOptions=void 0)}getSaturation(){return this.saturation}setSaturation(e){this.saturation=e}resetSaturation(){this.saturation=Mn}getMapSaturation(e){const t=this.warpedMapList.getWarpedMap(e);if(t)return t.saturation}setMapSaturation(e,t){const i=this.warpedMapList.getWarpedMap(e);i&&(i.saturation=t)}resetMapSaturation(e){const t=this.warpedMapList.getWarpedMap(e);t&&(t.saturation=Mn)}render(e){this.disableRender||(this.viewport=e,this.loadMissingImageInfosInViewport(),this.someImageInfosInViewport()&&this.throttledPrepareRenderInternal(),this.renderInternal())}clear(){this.warpedMapList.clear(),this.mapsInViewport=new Set,this.mapsWithRequestedTilesForViewport=new Set,this.gl.clear(this.gl.DEPTH_BUFFER_BIT|this.gl.COLOR_BUFFER_BIT),this.tileCache.clear()}cancelThrottledFunctions(){this.throttledPrepareRenderInternal.cancel(),this.throttledChanged.cancel()}destroy(){this.cancelThrottledFunctions();for(const e of this.warpedMapList.getWarpedMaps())this.removeEventListenersFromWebGL2WarpedMap(e);this.removeEventListeners(),super.destroy(),this.gl.deleteProgram(this.mapsProgram)}prepareRenderInternal(){this.requestFetchableTiles(),this.updateVertexBuffers()}shouldRequestFetchableTiles(){if(!this.viewport||this.animating)return!1;if(this.previousSignificantViewport){const e=[];for(let i=0;i<4;i++)e.push(ft(this.previousSignificantViewport.projectedGeoRectangle[i],this.viewport.projectedGeoRectangle[i])/Math.pow(this.viewport.projectedGeoPerViewportScale,2));const t=Math.max(...e);return t===0?!0:t>Math.pow(Xp,2)?(this.previousSignificantViewport=this.viewport,!0):!1}else return this.previousSignificantViewport=this.viewport,!0}shouldAnticipateInteraction(){return!0}updateVertexBuffers(){if(this.viewport){this.invertedRenderTransform=Rn(this.viewport.projectedGeoToClipTransform);for(const e of this.mapsWithRequestedTilesForViewport){const t=this.warpedMapList.getWarpedMap(e);if(!t)break;t.updateVertexBuffers(this.viewport.projectedGeoToClipTransform)}}}renderInternal(){if(!this.viewport)return;const e=this.gl;e.viewport(0,0,e.canvas.width,e.canvas.height),e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),this.renderMapsInternal(),this.renderLinesInternal(),this.renderPointsInternal()}renderMapsInternal(){if(!this.viewport)return;const e=ka(this.viewport.projectedGeoToClipTransform,this.invertedRenderTransform),t=this.gl,i=this.mapsProgram;t.useProgram(i);const n=t.getUniformLocation(i,"u_debug");t.uniform1f(n,0);const o=t.getUniformLocation(i,"u_renderTransform");t.uniformMatrix4fv(o,!1,Dt(e));const s=t.getUniformLocation(i,"u_animationProgress");t.uniform1f(s,this.animationProgress);const a=t.getUniformLocation(i,"u_colorDistortion00");t.uniform4f(a,...le(dn),1);const c=t.getUniformLocation(i,"u_colorDistortion01");t.uniform4f(c,...le($s),1);const l=t.getUniformLocation(i,"u_colorDistortion1");t.uniform4f(l,...le(Zs),1);const h=t.getUniformLocation(i,"u_colorDistortion2");t.uniform4f(h,...le(qs),1);const u=t.getUniformLocation(i,"u_colorDistortion3");t.uniform4f(u,...le(dn),1);const g=t.getUniformLocation(i,"u_colorGrid");t.uniform4f(g,...le(fr),1);for(const m of this.mapsWithRequestedTilesForViewport){const v=this.warpedMapList.getWarpedMap(m);if(!v)continue;this.setRenderOptionsUniforms(this.renderOptions,v.renderOptions);const b=t.getUniformLocation(i,"u_opacity");t.uniform1f(b,this.opacity*v.opacity);const E=t.getUniformLocation(i,"u_saturation");t.uniform1f(E,this.saturation*v.saturation);const _=t.getUniformLocation(i,"u_distortion");if(t.uniform1f(_,v.distortionMeasure?1:0),v.distortionMeasure){const w=t.getUniformLocation(i,"u_distortionOptionsdistortionMeasure");t.uniform1i(w,ss.indexOf(v.distortionMeasure))}const S=t.getUniformLocation(i,"u_currentBestScaleFactor"),d=v.currentBestScaleFactor;t.uniform1i(S,d);const p=t.getUniformLocation(i,"u_cachedTilesTextureArray");t.uniform1i(p,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D_ARRAY,v.cachedTilesTextureArray);const x=t.getUniformLocation(i,"u_cachedTilesResourcePositionsAndDimensionsTexture");t.uniform1i(x,2),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,v.cachedTilesResourcePositionsAndDimensionsTexture);const R=t.getUniformLocation(i,"u_cachedTilesScaleFactorsTexture");t.uniform1i(R,3),t.activeTexture(t.TEXTURE3),t.bindTexture(t.TEXTURE_2D,v.cachedTilesScaleFactorsTexture);const I=v.resourceTrianglePoints.length,T=this.gl.TRIANGLES;t.bindVertexArray(v.mapsVao),t.drawArrays(T,0,I)}}renderLinesInternal(){if(!this.viewport)return;const e=this.gl,t=this.linesProgram;e.useProgram(t);const i=e.getUniformLocation(t,"u_projectedGeoToViewportTransform");e.uniformMatrix4fv(i,!1,Dt(this.viewport.projectedGeoToViewportTransform));const n=e.getUniformLocation(t,"u_viewportToClipTransform");e.uniformMatrix4fv(n,!1,Dt(this.viewport.viewportToClipTransform));const o=e.getUniformLocation(t,"u_animationProgress");e.uniform1f(o,this.animationProgress);for(const s of this.mapsWithRequestedTilesForViewport){const a=this.warpedMapList.getWarpedMap(s);if(!a)continue;const c=a.lineLayers.reduce((u,g)=>u+g.projectedGeoLines.length,0)*6,l=this.gl.TRIANGLES;e.bindVertexArray(a.linesVao),e.drawArrays(l,0,c)}}renderPointsInternal(){if(!this.viewport)return;const e=this.gl,t=this.pointsProgram;e.useProgram(t);const i=e.getUniformLocation(t,"u_projectedGeoToViewportTransform");e.uniformMatrix4fv(i,!1,Dt(this.viewport.projectedGeoToViewportTransform));const n=e.getUniformLocation(t,"u_viewportToClipTransform");e.uniformMatrix4fv(n,!1,Dt(this.viewport.viewportToClipTransform));const o=e.getUniformLocation(t,"u_animationProgress");e.uniform1f(o,this.animationProgress);for(const s of this.mapsWithRequestedTilesForViewport){const a=this.warpedMapList.getWarpedMap(s);if(!a)continue;const c=a.pointLayers.reduce((u,g)=>u+g.projectedGeoPoints.length,0),l=this.gl.POINTS;e.bindVertexArray(a.pointsVao),e.drawArrays(l,0,c)}}setRenderOptionsUniforms(e,t){const i=this.gl,n=this.mapsProgram,o={removeColorOptions:{color:t.removeColorOptions?.color||e.removeColorOptions?.color,hardness:Un(t.removeColorOptions?.hardness,e.removeColorOptions?.hardness),threshold:Un(t.removeColorOptions?.threshold,e.removeColorOptions?.threshold)},colorizeOptions:{...e.colorizeOptions,...t.colorizeOptions},gridOptions:{...e.gridOptions,...t.gridOptions}},s=o.removeColorOptions?.color,a=i.getUniformLocation(n,"u_removeColor");if(i.uniform1f(a,s?1:0),s){const g=i.getUniformLocation(n,"u_removeColorOptionsColor");i.uniform3fv(g,s);const m=i.getUniformLocation(n,"u_removeColorOptionsThreshold");i.uniform1f(m,o.removeColorOptions?.threshold||Zp);const v=i.getUniformLocation(n,"u_removeColorOptionsHardness");i.uniform1f(v,o.removeColorOptions?.hardness||qp)}const c=o.colorizeOptions?.color,l=i.getUniformLocation(n,"u_colorize");if(i.uniform1f(l,c?1:0),c){const g=i.getUniformLocation(n,"u_colorizeOptionsColor");i.uniform3fv(g,c)}const h=o.gridOptions?.enabled,u=i.getUniformLocation(n,"u_grid");i.uniform1f(u,h?1:0)}startTransformationTransition(){this.lastAnimationFrameRequestId!==void 0&&cancelAnimationFrame(this.lastAnimationFrameRequestId),this.animating=!0,this.transformationTransitionStart=void 0,this.lastAnimationFrameRequestId=requestAnimationFrame(this.transformationTransitionFrame.bind(this))}transformationTransitionFrame(e){if(this.transformationTransitionStart||(this.transformationTransitionStart=e),e-this.transformationTransitionStart<Sa)this.animationProgress=(e-this.transformationTransitionStart)/Sa,this.renderInternal(),this.lastAnimationFrameRequestId=requestAnimationFrame(this.transformationTransitionFrame.bind(this));else{for(const t of this.warpedMapList.getWarpedMaps())t.resetPrevious();this.updateVertexBuffers(),this.animating=!1,this.animationProgress=0,this.transformationTransitionStart=void 0,this.changed()}}changed(){this.dispatchEvent(new N(C.CHANGED))}imageInfoLoaded(e){e instanceof N&&this.dispatchEvent(new N(C.IMAGEINFOLOADED))}clearMap(e){const t=this.warpedMapList.getWarpedMap(e);t&&t.clearTextures()}mapTileLoaded(e){if(e instanceof N){const{mapId:t,tileUrl:i}=e.data,n=this.tileCache.getCacheableTile(i);if(!n||!n.isCachedTile())return;const o=this.warpedMapList.getWarpedMap(t);if(!o)return;o.addCachedTileAndUpdateTextures(n)}}mapTileRemoved(e){if(e instanceof N){const{mapId:t,tileUrl:i}=e.data,n=this.warpedMapList.getWarpedMap(t);if(!n)return;n.removeCachedTileAndUpdateTextures(i)}}warpedMapAdded(e){if(e instanceof N){const t=e.data,i=this.warpedMapList.getWarpedMap(t);i&&this.addEventListenersToWebGL2WarpedMap(i)}}preChange(e){if(e instanceof N){const t=e.data;for(const i of this.warpedMapList.getWarpedMaps(t))this.animating&&i.mixPreviousAndNew(1-this.animationProgress)}}transformationChanged(e){e instanceof N&&(this.updateVertexBuffers(),this.startTransformationTransition())}distortionChanged(e){e instanceof N&&(this.updateVertexBuffers(),this.startTransformationTransition())}addEventListenersToWebGL2WarpedMap(e){e.addEventListener(C.TEXTURESUPDATED,this.throttledChanged.bind(this))}removeEventListenersFromWebGL2WarpedMap(e){e.removeEventListener(C.TEXTURESUPDATED,this.throttledChanged.bind(this))}contextLost(){this.disableRender=!0,this.cancelThrottledFunctions();for(const e of this.warpedMapList.getWarpedMaps())e.cancelThrottledFunctions();this.tileCache.clear()}contextRestored(){this.initializeWebGL(this.gl),this.disableRender=!1}}const Yp="Renderer not defined. Add the layer to a map before calling this function.",Kp="Canvas not defined. Add the layer to a map before calling this function.",Ra="tilePane",Aa=1;function U(r){if(!r)throw new Error(Yp)}function Ia(r){if(!r)throw new Error(Kp)}class Pn extends it.Layer{container;canvas;gl;renderer;_annotationOrAnnotationUrl;resizeObserver;options={opacity:Aa,interactive:!1,className:"",pane:Ra,zIndex:1};constructor(e,t){super(),this.initialize(e,t)}initialize(e,t){this._annotationOrAnnotationUrl=e,it.setOptions(this,t),this._initGl()}onAdd(e){if(!this._map||!this.container)return this;const t=this.getPaneName();return this._map.getPane(t)?.appendChild(this.container),e.on("zoomend viewreset move",this._update,this),e.on("zoomanim",this._animateZoom,this),e.on("unload",this._unload,this),this.resizeObserver=new ResizeObserver(this._resized.bind(this)),this.resizeObserver.observe(this._map.getContainer(),{box:"content-box"}),this._annotationOrAnnotationUrl&&(typeof this._annotationOrAnnotationUrl=="string"&&sc(this._annotationOrAnnotationUrl)?this.addGeoreferenceAnnotationByUrl(this._annotationOrAnnotationUrl).then(()=>this._update()):this.addGeoreferenceAnnotation(this._annotationOrAnnotationUrl).then(()=>this._update())),this}onRemove(e){return this.container&&this.container.remove(),e.off("zoomend viewreset move",this._update,this),e.off("zoomanim",this._animateZoom,this),this}async addGeoreferenceAnnotation(e){U(this.renderer);const t=await this.renderer.warpedMapList.addGeoreferenceAnnotation(e);return this._update(),t}async removeGeoreferenceAnnotation(e){U(this.renderer);const t=await this.renderer.warpedMapList.removeGeoreferenceAnnotation(e);return this._update(),t}async addGeoreferenceAnnotationByUrl(e){const t=await fetch(e).then(i=>i.json());return this.addGeoreferenceAnnotation(t)}async removeGeoreferenceAnnotationByUrl(e){const t=await fetch(e).then(n=>n.json());return this.removeGeoreferenceAnnotation(t)}async addGeoreferencedMap(e){U(this.renderer);const t=this.renderer.warpedMapList.addGeoreferencedMap(e);return this._update(),t}async removeGeoreferencedMap(e){U(this.renderer);const t=this.renderer.warpedMapList.removeGeoreferencedMap(e);return this._update(),t}getContainer(){return this.container}getCanvas(){return this.canvas}getWarpedMapList(){return U(this.renderer),this.renderer.warpedMapList}getWarpedMap(e){return U(this.renderer),this.renderer.warpedMapList.getWarpedMap(e)}showMap(e){U(this.renderer),this.renderer.warpedMapList.showMaps([e]),this._update()}showMaps(e){U(this.renderer),this.renderer.warpedMapList.showMaps(e),this._update()}hideMap(e){U(this.renderer),this.renderer.warpedMapList.hideMaps([e]),this._update()}hideMaps(e){U(this.renderer),this.renderer.warpedMapList.hideMaps(e),this._update()}isMapVisible(e){return U(this.renderer),this.renderer.warpedMapList.getWarpedMap(e)?.visible}setMapResourceMask(e,t){U(this.renderer),this.renderer.warpedMapList.setMapResourceMask(e,t),this._update()}setMapsTransformationType(e,t){U(this.renderer),this.renderer.warpedMapList.setMapsTransformationType(e,t),this._update()}setMapsDistortionMeasure(e,t){U(this.renderer),this.renderer.warpedMapList.setMapsDistortionMeasure(e,t),this._update()}getBounds(){U(this.renderer);const e=this.renderer.warpedMapList.getBbox();if(e)return[[e[1],e[0]],[e[3],e[2]]]}bringMapsToFront(e){U(this.renderer),this.renderer.warpedMapList.bringMapsToFront(e),this._update()}sendMapsToBack(e){U(this.renderer),this.renderer.warpedMapList.sendMapsToBack(e),this._update()}bringMapsForward(e){U(this.renderer),this.renderer.warpedMapList.bringMapsForward(e),this._update()}sendMapsBackward(e){U(this.renderer),this.renderer.warpedMapList.sendMapsBackward(e),this._update()}bringToFront(){return this._map&&this.container&&it.DomUtil.toFront(this.container),this}bringToBack(){return this._map&&this.container&&it.DomUtil.toBack(this.container),this}getMapZIndex(e){return U(this.renderer),this.renderer.warpedMapList.getMapZIndex(e)}getZIndex(){return this.options.zIndex}setZIndex(e){return this.options.zIndex=e,this._updateZIndex(),this}setImageInformations(e){U(this.renderer),this.renderer.warpedMapList.setImageInformations(e)}getPaneName(){return this.options.pane||Ra}getOpacity(){return this.options.opacity||Aa}setOpacity(e){return this.options.opacity=e,this._update(),this}resetOpacity(){return this.options.opacity=1,this._update(),this}getMapOpacity(e){return U(this.renderer),this.renderer.getMapOpacity(e)}setMapOpacity(e,t){return U(this.renderer),this.renderer.setMapOpacity(e,t),this._update(),this}resetMapOpacity(e){return U(this.renderer),this.renderer.resetMapOpacity(e),this._update(),this}setSaturation(e){return U(this.renderer),this.renderer.setSaturation(e),this._update(),this}resetSaturation(){return U(this.renderer),this.renderer.resetSaturation(),this._update(),this}setMapSaturation(e,t){return U(this.renderer),this.renderer.setMapSaturation(e,t),this._update(),this}resetMapSaturation(e){return U(this.renderer),this.renderer.resetMapSaturation(e),this._update(),this}setRemoveColor(e){U(this.renderer);const t=e.hexColor?le(e.hexColor):void 0;return this.renderer.setRemoveColorOptions({color:t,threshold:e.threshold,hardness:e.hardness}),this._update(),this}resetRemoveColor(){return U(this.renderer),this.renderer.resetRemoveColorOptions(),this._update(),this}setMapRemoveColor(e,t){U(this.renderer);const i=t.hexColor?le(t.hexColor):void 0;return this.renderer.setMapRemoveColorOptions(e,{color:i,threshold:t.threshold,hardness:t.hardness}),this._update(),this}resetMapRemoveColor(e){return U(this.renderer),this.renderer.resetMapRemoveColorOptions(e),this}setColorize(e){U(this.renderer);const t=le(e);return t&&(this.renderer.setColorizeOptions({color:t}),this._update()),this}resetColorize(){return U(this.renderer),this.renderer.resetColorizeOptions(),this._update(),this}setMapColorize(e,t){U(this.renderer);const i=le(t);return i&&(this.renderer.setMapColorizeOptions(e,{color:i}),this._update()),this}resetMapColorize(e){return U(this.renderer),this.renderer.resetMapColorizeOptions(e),this._update(),this}clear(){return U(this.renderer),this.renderer.clear(),this._update(),this}_initGl(){if(this.container=it.DomUtil.create("div"),this.container.classList.add("leaflet-layer"),this.container.classList.add("allmaps-warped-map-layer"),this.options.zIndex&&this._updateZIndex(),this.canvas=it.DomUtil.create("canvas",void 0,this.container),this.canvas.classList.add("leaflet-zoom-animated"),this.canvas.classList.add("leaflet-image-layer"),this.options.interactive&&this.canvas.classList.add("leaflet-interactive"),this.options.className&&this.canvas.classList.add(this.options.className),this.gl=this.canvas.getContext("webgl2",{premultipliedAlpha:!0}),!this.gl)throw new Error("WebGL 2 not available");this.renderer=new Hp(this.gl),this._addEventListeners()}_resized(e){if(this.canvas){for(const t of e){const i=t.contentRect.width,n=t.contentRect.height,o=window.devicePixelRatio,s=Math.round(i*o),a=Math.round(n*o);this.canvas.width=s,this.canvas.height=a,this.canvas.style.width=i+"px",this.canvas.style.height=n+"px"}this._update()}}_animateZoom(e){if(!this.canvas)return;const t=this._map.getZoomScale(e.zoom),i=this._map._latLngBoundsToNewLayerBounds(this._map.getBounds(),e.zoom,e.center).min;it.DomUtil.setTransform(this.canvas,i,t)}_updateZIndex(){this.container&&this.options.zIndex!==void 0&&(this.container.style.zIndex=String(this.options.zIndex))}_update(){if(!this._map||!this.renderer||!this.canvas||!this._map.options.crs)return;const e=this._map.containerPointToLayerPoint([0,0]);it.DomUtil.setPosition(this.canvas,e),this.renderer.setOpacity(this.getOpacity());const t=this._map.getSize(),i=[t.x,t.y],n=this._map.getCenter(),o=this._map.options.crs.project(n),s=[o.x,o.y],a=this._map.getBounds(),c=this._map.options.crs.project(a.getNorthEast()),l=this._map.options.crs.project(a.getNorthWest()),h=this._map.options.crs.project(a.getSouthWest()),u=this._map.options.crs.project(a.getSouthEast()),g=[[c.x,c.y],[l.x,l.y],[h.x,h.y],[u.x,u.y]],m=Pi(g),v=Rr(m,i),b=new vc(i,s,v,0,window.devicePixelRatio);return this.renderer.render(b),this.container}_contextLost(e){e.preventDefault(),this.renderer?.contextLost()}_contextRestored(e){e.preventDefault(),this.renderer?.contextRestored()}_addEventListeners(){U(this.renderer),Ia(this.canvas),this.canvas.addEventListener("webglcontextlost",this._contextLost.bind(this)),this.canvas.addEventListener("webglcontextrestored",this._contextRestored.bind(this)),this.renderer.addEventListener(C.CHANGED,this._update.bind(this)),this.renderer.addEventListener(C.IMAGEINFOLOADED,this._update.bind(this)),this.renderer.addEventListener(C.WARPEDMAPENTER,this._passWarpedMapEvent.bind(this)),this.renderer.addEventListener(C.WARPEDMAPLEAVE,this._passWarpedMapEvent.bind(this)),this.renderer.tileCache.addEventListener(C.FIRSTMAPTILELOADED,this._passWarpedMapEvent.bind(this)),this.renderer.tileCache.addEventListener(C.ALLREQUESTEDTILESLOADED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.addEventListener(C.WARPEDMAPADDED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.addEventListener(C.WARPEDMAPREMOVED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.addEventListener(C.VISIBILITYCHANGED,this._update.bind(this)),this.renderer.warpedMapList.addEventListener(C.CLEARED,this._update.bind(this))}_removeEventListeners(){U(this.renderer),Ia(this.canvas),this.canvas.addEventListener("webglcontextlost",this._contextLost.bind(this)),this.canvas.addEventListener("webglcontextrestored",this._contextRestored.bind(this)),this.renderer.removeEventListener(C.CHANGED,this._update.bind(this)),this.renderer.removeEventListener(C.IMAGEINFOLOADED,this._update.bind(this)),this.renderer.removeEventListener(C.WARPEDMAPENTER,this._passWarpedMapEvent.bind(this)),this.renderer.removeEventListener(C.WARPEDMAPLEAVE,this._passWarpedMapEvent.bind(this)),this.renderer.tileCache.removeEventListener(C.FIRSTMAPTILELOADED,this._passWarpedMapEvent.bind(this)),this.renderer.tileCache.removeEventListener(C.ALLREQUESTEDTILESLOADED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.removeEventListener(C.WARPEDMAPADDED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.removeEventListener(C.WARPEDMAPREMOVED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.removeEventListener(C.VISIBILITYCHANGED,this._update.bind(this)),this.renderer.warpedMapList.removeEventListener(C.CLEARED,this._update.bind(this))}_passWarpedMapEvent(e){e instanceof N&&this._map&&this._map.fire(e.type,e.data)}_unload(){if(U(this.renderer),!this.gl)return;this.renderer.destroy();const e=this.gl.getExtension("WEBGL_lose_context");e&&e.loseContext();const t=this.gl.canvas;t.width=1,t.height=1,this.resizeObserver?.disconnect(),this._removeEventListeners()}}const Jp=function(r,e){return new Pn(r,e)};L.WarpedMapLayer=Pn,L.warpedMapLayer=Jp,Ne.WarpedMapEvent=N,Ne.WarpedMapEventType=C,Ne.WarpedMapLayer=Pn,Object.defineProperty(Ne,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=allmaps-leaflet-1.9.umd.js.map
